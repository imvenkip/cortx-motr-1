KNETC2_SRCDIR = @SRCDIR@/net/linux_kernel
NET_MOD       := knetc2

GCOV_PROFILE := @K_ENABLE_COVERAGE@

otw_ff        := net_otw_types.ff
otw_k_h       := $(otw_ff:.ff=_k.h)
otw_k_c       := $(otw_ff:.ff=_k.c)
otw_k_o       := $(otw_k_c:.c=.o)

local_src     :=
ut_src        := bulk_if.c buffer_pool_ut.c
link_ut       := $(ut_src:%=../ut/%)
kernel_src    := $(local_src) $(otw_k_c) $(ut_src)
net_src       := buf.c domain.c ep.c net.c tm.c buffer_pool.c
link_net      := $(net_src:%=../%)
# link in unit test file as it includes lnet_main.c
lnet_src      := lnet_ut.c
link_lnet     := $(lnet_src:%=../lnet/ut/%)
# link in the unit test file as it includes mem_xprt_xo.c
bulk_src      := bulk_mem_ut.c ksunrpc_ut.c
link_bulk     := $(bulk_src:%=../bulk_emulation/ut/%)

# rename the ksunrpc files when sym linking to avoid name clashes
depr_Ksrc     := client.c kxdr.c domain.c
depr_ksrc     := $(depr_Ksrc:%=k%)
depr_src      := connection.c net.c net_cli.c net_utils.c net_srv.c
link_depr     := $(depr_src:%=../%)

sio_ff        := sunrpc_io.ff
sio_k_h       := $(sio_ff:.ff=_k.h)
sio_k_c       := $(sio_ff:.ff=_k.c)
sio_k_o       := $(sio_k_c:.c=.o)
# link in the unit test file as it includes sunrpc_xprt_xo.c
deprbulk_lut  := bulk_sunrpc_ut.c
deprbulk_lsrc := ksunrpc_server.c
deprbulk_src  := $(deprbulk_lsrc) $(sio_k_c) $(deprbulk_lut)
link_deprbulk := $(deprbulk_lsrc:%=../bulk_emulation/%) \
                 $(deprbulk_lut:%=../bulk_emulation/ut/%)

all_src       := $(kernel_src) $(net_src) $(lnet_src) $(bulk_src) \
                 $(depr_src) $(depr_ksrc) $(deprbulk_src)
all_obj       := $(all_src:.c=.o)

obj-y         := $(NET_MOD).o
$(NET_MOD)-y  := $(all_obj)

dist_src      := Makefile.in $(local_src)

EXTRA_CFLAGS = -DHAVE_CONFIG_H -I@SRCDIR@ -I@SRCDIR@/net/ksunrpc \
        -I@LUSTRE@/lnet/include -I@LUSTRE@/libcfs/include @KCFLAGS@

prepare: $(otw_k_c) $(otw_k_h) $(sio_k_c) $(sio_k_h)
	ln -fs @LUSTRE@/config.h lustre_config.h
	ln -fs $(link_net) $(link_lnet) $(link_ut) $(link_bulk) .
	ln -fs $(link_depr) $(link_deprbulk) .
	for f in $(depr_Ksrc) ; do ln -fs ../ksunrpc/$$f k$$f; done

install modules_install:
	$(MAKE) INSTALL_MOD_DIR=kernel/fs/$(NET_MOD) -C @LINUX_OBJ@ M=`pwd` modules_install

uninstall:
	rm -fr @LUNUX_MOD@/kernel/fs/$(NET_MOD)

clean distclean:
	$(RM) $(net_src) $(lnet_src) $(ut_src) $(bulk_src) $(otw_k_c) $(otw_k_h)
	$(RM) $(depr_src) $(depr_ksrc) $(deprbulk_src) $(sio_k_h)
	$(RM) lustre_config.h
	$(RM) Module.markers Module.symvers modules.order
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` clean

distdir:
	cp $(dist_src) @top_builddir@/@PACKAGE@-@VERSION@/$(NET_MOD)/linux_kernel

$(all_obj): $(otw_k_h) $(sio_k_h)
$(otw_k_c) $(otw_k_h): ../$(otw_ff)
	@SRCDIR@/fop/fop2c -k ../$(otw_ff)
$(sio_k_c) $(sio_k_h): ../bulk_emulation/$(sio_ff)
	@SRCDIR@/fop/fop2c -k ../bulk_emulation/$(sio_ff)
