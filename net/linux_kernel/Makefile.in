KNETC2_SRCDIR = @SRCDIR@/net/linux_kernel
NET_MOD      := knetc2

otw_ff       := net_otw_types.ff
otw_k_h      := $(otw_ff:.ff=_k.h)
otw_k_c      := $(otw_ff:.ff=_k.c)
otw_k_o      := $(otw_k_c:.c=.o)

local_src    := main.c
kernel_src   := $(local_src) $(otw_k_c)
net_src      := buf.c domain.c ep.c net.c tm.c
orig_net     := $(net_src:%=../%)
bulk_src     := mem_xprt_xo.c
orig_bulk    := $(bulk_src:%=../bulk_emulation/%)

# rename the ksunrpc files when sym linking to avoid name clashes
depr_Ksrc    := client.c kxdr.c domain.c server.c
depr_ksrc    := $(depr_Ksrc:%=k%)
depr_src     := connection.c net.c net_cli.c net_utils.c
orig_depr    := $(depr_src:%=../%)

all_src      := $(kernel_src) $(net_src) $(bulk_src) $(depr_src) $(depr_ksrc)
all_obj      := $(all_src:.c=.o)

obj-m        := $(NET_MOD).o
$(NET_MOD)-y := $(all_obj)

dist_src     := Makefile.in $(local_src)

EXTRA_CFLAGS = -DHAVE_CONFIG_H -I@SRCDIR@ -I@SRCDIR@/net/ksunrpc @KCFLAGS@

prepare: $(otw_k_c) $(otw_k_h)
	ln -fs $(orig_net) $(orig_bulk) .
	ln -fs $(orig_depr) .
	for f in $(depr_Ksrc) ; do ln -fs ../ksunrpc/$$f k$$f; done

install modules_install:
	$(MAKE) INSTALL_MOD_DIR=kernel/fs/$(NET_MOD) -C @LINUX_OBJ@ M=`pwd` modules_install

uninstall:
	rm -fr @LUNUX_MOD@/kernel/fs/$(NET_MOD)

clean distclean:
	$(RM) $(net_src) $(bulk_src) $(otw_k_c) $(otw_k_h)
	$(RM) $(depr_src) $(depr_ksrc)
	$(RM) Module.markers Module.symvers modules.order
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` clean

distdir:
	cp $(dist_src) @top_builddir@/@PACKAGE@-@VERSION@/$(NET_MOD)/linux_kernel

$(all_obj): $(otw_k_h)
$(otw_k_c) $(otw_k_h): ../$(otw_ff)
	@SRCDIR@/fop/fop2c -k ../$(otw_ff)
