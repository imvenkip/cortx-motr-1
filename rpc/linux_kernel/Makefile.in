RPC_SRCDIR = @SRCDIR@/rpc/linux_kernel
RPCDIR = @SRCDIR@/rpc
FOPDIR = @SRCDIR@/fop

obj-m		:= krpc.o
shared_src	:= rpccore.h rpccore.c session.h session.c session_internal.h \
		   session_foms.h session_foms.c session_fops.h session_fops.c \
		   formation.h formation.c 
kernel_src	:= rpc_kernel.c
krpc-y		:= $(shared_src:.c=.o) $(kernel_src:.c=.o)
orig		:= $(shared_src:%=../%)

EXTRA_CFLAGS = -DHAVE_CONFIG_H -I@SRCDIR@ @KCFLAGS@

prepare: session_k.h session_k.c
	ln -fs $(orig) .

session_k.h session_k.c: $(RPCDIR)/session.ff
	$(FOPDIR)/fop2c -k $(RPC_SRCDIR)/session.ff

install modules_install:
	$(MAKE) INSTALL_MOD_DIR=kernel/fs/rpc -C @LINUX_OBJ@ M=`pwd` modules_install

uninstall:
	rm -rf @LINUX_MOD@/kernel/fs/rpc

clean distclean:
	$(RM) $(shared_src) Module.markers Modules.symvers modules.order
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` clean

distdir:
	cp $(<MOD.DIR>)/Makefile.in $(RPC_SRCDIR)/rpc_kernel.h $(RPC_SRCDIR)/rpc_kernel.c \
	    @top_builddir@/@PACKAGE@-@VERSION@/<rpc>/linux_kernel



