IOSERVICE_SRCDIR = @SRCDIR@/ioservice/linux_kernel
IOSERVICEDIR = @SRCDIR@/ioservice
FOPDIR = @SRCDIR@/fop

GCOV_PROFILE := @K_ENABLE_COVERAGE@

obj-y		:= kioservice.o
shared_src	:= io_fops.c
kernel_src	:= io_fops_k.c
kioservice-y	:= $(shared_src:.c=.o) $(kernel_src:.c=.o)
orig		:= $(shared_src:%=../%)

EXTRA_CFLAGS = -DHAVE_CONFIG_H -I@SRCDIR@ @KCFLAGS@

prepare: io_fops_k.h io_fops_k.c
	ln -fs $(orig) .

io_fops_k.h io_fops_k.c: $(IOSERVICEDIR)/io_fops.ff
	$(FOPDIR)/fop2c -k $(IOSERVICEDIR)/io_fops.ff

install modules_install:
	$(MAKE) INSTALL_MOD_DIR=kernel/fs/ioservice -C @LINUX_OBJ@ M=`pwd` modules_install

uninstall:
	rm -rf @LINUX_MOD@/kernel/fs/ioservice

clean distclean:
	$(RM) io_fops_k.[ch]
	$(RM) $(shared_src) Module.markers Module.symvers modules.order io_fops.ff
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` clean

distdir:
	cp $(IOSERVICE_SRCDIR)/Makefile.in $(IOSERVICE_SRCDIR)/ioservice_kernel.c \
	    @top_builddir@/@PACKAGE@-@VERSION@/ioservice/linux_kernel
