#! /bin/sh

# Small wrapper to run user-space UT, which depends on m0mero module

if [ "$(id -u)" -ne 0 ]; then
    echo "Must be run as root"
    exit 1
fi

# Assign a node uuid for the user space UT (addb/ut/addb_ut.c)
NODE_UUID="abcdef01-2345-6789-0123-456789ABCDEF"

. @abs_top_srcdir@/m0t1fs/linux_kernel/st/common.sh

unload_all() {
    modunload
    modunload_galois
}
trap unload_all EXIT

modprobe_lnet
modload_galois
modload || exit $?

# allow only 'fatal' and higher trace messages to be printed on console by
# default, to prevent cluttering of UT output with "fake" error messages,
# generated while testing various error paths using fault injection;
# this can be overridden with '-e' CLI option.
export M0_TRACE_LEVEL=${M0_TRACE_LEVEL:-'fatal+'}

# $EXEC allows to reuse this script to execute different utilities which need
# loaded mero modules prior to be run. For example, running utitiliy called `ub'
# will need the following symlink to be created: `ln -s ut.sh ub.sh'.
EXEC=`echo ${0##*/} | sed 's/\.sh$//'`

if test x$enable_rpm = xyes; then
    $EXEC "$@"
else
    @abs_top_srcdir@/utils/$EXEC "$@"
fi
