#! /bin/sh

# Small wrapper to run user-space UT, which depends on kmero module

if [ "$(id -u)" -ne 0 ]; then
    echo "Must be run as root"
    exit 1
fi

. @abs_top_srcdir@/m0t1fs/linux_kernel/st/common.sh

unload_all() {
    modunload
    modunload_galois
}
trap unload_all EXIT

modprobe_lnet
modload_galois
modload || exit $?

# allow only 'fatal' and higher trace messages to be printed on console by
# default, to prevent cluttering of UT output with "fake" error messages,
# generated while testing various error paths using fault injection;
# this can be overridden with '-e' CLI option.
export M0_TRACE_LEVEL='fatal+'

if test x$enable_rpm = xyes; then
    ut "$@"
else
    @abs_top_srcdir@/utils/ut "$@"
fi
