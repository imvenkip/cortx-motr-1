From 7abfdd61cccb31aa839d0695a02e74ee90ec5c4c Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Mon, 17 Dec 2012 12:36:16 +0800
Subject: [PATCH 4/6] rollback: allocate iomap for all unit: data, parity and
 spare.

---
 m0t1fs/linux_kernel/file.c | 15 ++++++---------
 1 file changed, 6 insertions(+), 9 deletions(-)

diff --git a/m0t1fs/linux_kernel/file.c b/m0t1fs/linux_kernel/file.c
index 9e444ea..4862a3b 100644
--- a/m0t1fs/linux_kernel/file.c
+++ b/m0t1fs/linux_kernel/file.c
@@ -2111,21 +2111,18 @@ static int nw_xfer_io_prepare(struct nw_xfer_request *xfer)
 
 				src.sa_unit = layout_n(play) + unit;
 
-				if (m0_pdclust_unit_classify(play,
-				    src.sa_unit) == M0_PUT_PARITY) {
-					rc = xfer->nxr_ops->nxo_tioreq_map(xfer,
-									   &src,
-									   &tgt,
-									   &ti);
-					if (rc != 0)
-						goto err;
+				rc = xfer->nxr_ops->nxo_tioreq_map(xfer, &src,
+								   &tgt, &ti);
+				if (rc != 0)
+					goto err;
 
+				if (m0_pdclust_unit_classify(play,
+				    src.sa_unit) == M0_PUT_PARITY)
 					ti->ti_ops->tio_seg_add(ti,
 							&src, &tgt, pgstart,
 							0,
 							layout_unit_size(play),
 							req->ir_iomaps[map]);
-				}
 			}
 		}
 	}
-- 
1.8.3.2

