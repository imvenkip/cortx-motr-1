From 1c927293dadb624cdd389dc4161147fc5f4791a1 Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Mon, 17 Dec 2012 14:07:03 +0800
Subject: [PATCH 6/6] adding FI code to help testing: emulate device 1 is
 repaired.

---
 m0t1fs/linux_kernel/file.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/m0t1fs/linux_kernel/file.c b/m0t1fs/linux_kernel/file.c
index 4862a3b..35b2a1d 100644
--- a/m0t1fs/linux_kernel/file.c
+++ b/m0t1fs/linux_kernel/file.c
@@ -2445,10 +2445,22 @@ static int nw_xfer_tioreq_map(struct nw_xfer_request           *xfer,
 		M0_RETURN(rc);
 	}
 
+	if (M0_FI_ENABLED("poolmach_client_repaired_device1")) {
+		if (tfid.f_container == 1)
+			device_state = M0_PNDS_SNS_REPAIRED;
+	}
+
 	if (device_state == M0_PNDS_SNS_REPAIRED) {
 		rc = m0_poolmach_sns_repair_spare_query(csb->csb_pool.po_mach,
 							tfid.f_container,
 							&spare_slot);
+		if (M0_FI_ENABLED("poolmach_client_repaired_device1")) {
+			if (tfid.f_container == 1) {
+				rc = 0;
+				spare_slot = 0;
+			}
+		}
+
 		if (rc != 0) {
 			M0_ADDB_ADD(&m0t1fs_addb, &io_addb_loc,
 				    io_request_failed, "Query spare slot fail",
-- 
1.8.3.2

