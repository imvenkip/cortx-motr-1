From 4ab35fdfb1e119975d13c7fbbb618681fd695f02 Mon Sep 17 00:00:00 2001
From: Alexander Gattin <alexander_gattin@xyratex.com>
Date: Thu, 6 Jun 2013 17:23:13 +0300
Subject: [PATCH 115/161] be/list: use l_reg to simplify m0_be_list_put() loop

Reported-by: Nikita Danilov <nikita_danilov@xyratex.com>
---
 be/list.c | 22 +++++++++++-----------
 1 file changed, 11 insertions(+), 11 deletions(-)

diff --git a/be/list.c b/be/list.c
index c1b4328..d149cb7 100644
--- a/be/list.c
+++ b/be/list.c
@@ -101,25 +101,25 @@ M0_INTERNAL void m0_be_list_put(const struct m0_be_list *list,
 {
 	struct m0_list_link *ll;
 	struct m0_list_link *prvll;
+	uint64_t            *ll_magic;
+	struct m0_be_reg     l_reg = M0_BE_REG(list->bl_seg, list->bl_descr->
+					       td_container_size, 0);
 
 	M0_PRE(list != NULL);
 	for (ll = list->bl_list.t_head.l_head;
 	     ll != NULL && (void*)ll != &list->bl_list.t_head
 	     && nelems > 0;
 	     nelems--) {
+		l_reg.br_addr = (void *)ll - list->bl_descr->td_link_offset;
+		ll_magic = l_reg.br_addr +
+			list->bl_descr->td_link_magic_offset;
 		/* Check ll's reg before doing mem access. */
-		M0_ASSERT(m0_be__reg_is_pinned(&M0_BE_REG(list->bl_seg,
-							  list->bl_descr->
-							  td_container_size,
-							  (void *)ll -
-							  list->bl_descr->
-							  td_link_offset)));
+		M0_ASSERT(m0_be__reg_is_pinned(&l_reg));
+		M0_ASSERT(list->bl_descr->td_link_magic == 0
+			  || *ll_magic == list->bl_descr->td_link_magic);
 		prvll = ll;
-		ll = ll->ll_next; /* mem access */
-		m0_be_reg_put(&M0_BE_REG(list->bl_seg,
-					 list->bl_descr->td_container_size,
-					 (void *)ll -
-					 list->bl_descr->td_link_offset));
+		ll = ll->ll_next;
+		m0_be_reg_put(&l_reg);
 	}
 }
 
-- 
1.8.3.2

