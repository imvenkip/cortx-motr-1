From a980185e321cb3c03dcd612d9741ae8625c02d27 Mon Sep 17 00:00:00 2001
From: Maxim Medved <Max_Medved@xyratex.com>
Date: Wed, 28 Mar 2012 15:22:46 +0300
Subject: [PATCH 9/9] added __C2_FOM_OPS_WRAPPER() macro

---
 fop/fop_format.h              |  2 +-
 fop/fop_user.h                |  2 ++
 fop/linux_kernel/fop_kernel.h |  2 ++
 ioservice/io_fops.c           | 11 +----------
 4 files changed, 6 insertions(+), 11 deletions(-)

diff --git a/fop/fop_format.h b/fop/fop_format.h
index 85012a0..8ee6dea 100644
--- a/fop/fop_format.h
+++ b/fop/fop_format.h
@@ -224,7 +224,7 @@ struct c2_fop_type fopt ## _fopt = {					\
 		.rit_ops    = (itops)					\
 	},								\
 	.ft_fom_type = {						\
-		.ft_ops = (fom_ops)					\
+		.ft_ops = __C2_FOM_OPS_WRAPPER(fom_ops)			\
 	}								\
 };
 
diff --git a/fop/fop_user.h b/fop/fop_user.h
index 5bb9c02..52d2e56 100644
--- a/fop/fop_user.h
+++ b/fop/fop_user.h
@@ -23,6 +23,8 @@
 
 #include <rpc/rpc.h> /* xdrproc_t */
 
+#define __C2_FOM_OPS_WRAPPER(x) (x)
+
 /* __COLIBRI_FOP_FOP_USER_H__ */
 #endif
 
diff --git a/fop/linux_kernel/fop_kernel.h b/fop/linux_kernel/fop_kernel.h
index 161832b..92ca953 100644
--- a/fop/linux_kernel/fop_kernel.h
+++ b/fop/linux_kernel/fop_kernel.h
@@ -30,6 +30,8 @@ typedef void *xdrproc_t;
 #define xdr_uint32_t NULL
 #define xdr_uint64_t NULL
 
+#define __C2_FOM_OPS_WRAPPER(x) (NULL)
+
 /* __COLIBRI_FOP_FOP_KERNEL_H__ */
 #endif
 
diff --git a/ioservice/io_fops.c b/ioservice/io_fops.c
index 0af175d..862356b 100644
--- a/ioservice/io_fops.c
+++ b/ioservice/io_fops.c
@@ -134,21 +134,12 @@ const struct c2_fop_type_ops c2_io_rwv_rep_ops = {
 C2_FOP_TYPE_DECLARE_OPS(c2_fop_cob_readv, "Read request",
 			&io_fop_rwv_ops, C2_IOSERVICE_READV_OPCODE,
 			C2_RPC_ITEM_TYPE_REQUEST, &io_item_type_ops,
-#ifndef __KERNEL__
 			&c2_io_cob_rw_type_ops);
-#else
-			NULL);
-#endif
 
 C2_FOP_TYPE_DECLARE_OPS(c2_fop_cob_writev, "Write request",
 			&io_fop_rwv_ops, C2_IOSERVICE_WRITEV_OPCODE,
 			C2_RPC_ITEM_TYPE_REQUEST | C2_RPC_ITEM_TYPE_MUTABO,
-			&io_item_type_ops,
-#ifndef __KERNEL__
-			&c2_io_cob_rw_type_ops);
-#else
-			NULL);
-#endif
+			&io_item_type_ops, &c2_io_cob_rw_type_ops);
 
 C2_FOP_TYPE_DECLARE(c2_fop_cob_writev_rep, "Write reply",
 		    &c2_io_rwv_rep_ops, C2_IOSERVICE_WRITEV_REP_OPCODE,
-- 
1.8.3.2

