From 7bd917ad2207d37f81023e88bed4c182244dbaf7 Mon Sep 17 00:00:00 2001
From: Rajanikant Chirmade <rajanikant_chirmade@xyratex.com>
Date: Mon, 10 Feb 2014 15:27:06 +0530
Subject: [PATCH 45/50]  - Added code to remove holes in extended transtions
 table.

---
 fop/fom_generic.c |  4 ++--
 sm/sm.c           | 16 ++++++++++++----
 2 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/fop/fom_generic.c b/fop/fom_generic.c
index 292137e..6389b9b 100644
--- a/fop/fom_generic.c
+++ b/fop/fom_generic.c
@@ -46,8 +46,6 @@
 struct m0_fop_type m0_fop_generic_reply_fopt;
 M0_EXPORTED(m0_fop_generic_reply_fopt);
 
-M0_BASSERT(ARRAY_SIZE(m0_generic_phases_trans) == M0_FOM_GENERIC_TRANS_NR);
-
 M0_INTERNAL void m0_fom_generic_fini(void)
 {
 	m0_fop_type_fini(&m0_fop_generic_reply_fopt);
@@ -753,6 +751,8 @@ struct m0_sm_trans_descr m0_generic_phases_trans[] = {
 	{"FOM failed",           M0_FOPH_FAILURE, M0_FOPH_TXN_COMMIT},
 };
 
+M0_BASSERT(ARRAY_SIZE(m0_generic_phases_trans) == M0_FOM_GENERIC_TRANS_NR);
+
 struct m0_sm_conf m0_generic_conf = {
 	.scf_magic     = M0_SM_CONF_MAGIC,
 	.scf_name      = "FOM standard phases",
diff --git a/sm/sm.c b/sm/sm.c
index da104ce..13bb92e 100644
--- a/sm/sm.c
+++ b/sm/sm.c
@@ -651,16 +651,24 @@ M0_INTERNAL void m0_sm_conf_trans_extend(const struct m0_sm_conf *base,
 					 struct m0_sm_conf *sub)
 {
 	uint32_t i;
+	uint32_t j;
 
 	M0_PRE(conf_invariant(base));
-	M0_PRE(sub->scf_trans_nr > base->scf_trans_nr);
 
-	for (i = 0; i < base->scf_trans_nr; i++) {
+	for (i = 0, j = 0; i < base->scf_trans_nr; i++) {
 		const struct m0_sm_trans_descr *b = &base->scf_trans[i];
 
-		if (!trans_exists(sub, b->td_src, b->td_tgt))
-			sub->scf_trans[i] = *b;
+		if (!trans_exists(sub, b->td_src, b->td_tgt)) {
+			M0_ASSERT(i < sub->scf_trans_nr);
+			sub->scf_trans[j++] = *b;
+		}
 	}
+
+	for (;i < sub->scf_trans_nr; i++)
+		sub->scf_trans[j++] = sub->scf_trans[i];
+
+	sub->scf_trans_nr = j;
+
 	M0_POST(conf_invariant(sub));
 }
 
-- 
1.8.3.2

