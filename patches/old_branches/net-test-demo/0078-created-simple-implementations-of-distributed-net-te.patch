From 4a7cba68b63b3e747f93207a99c14176851e9261 Mon Sep 17 00:00:00 2001
From: Maxim Medved <Max_Medved@xyratex.com>
Date: Thu, 21 Feb 2013 15:23:47 +0200
Subject: [PATCH 78/79] created simple implementations of distributed net-test
 demo scripts

---
 net/test/demo/demo-list-nids.sh |  29 ++++++-
 net/test/demo/demo-test-run.sh  | 172 +++++++++++++++++++++++++++++++++++++++-
 2 files changed, 199 insertions(+), 2 deletions(-)

diff --git a/net/test/demo/demo-list-nids.sh b/net/test/demo/demo-list-nids.sh
index a674ea6..6de0bb3 100755
--- a/net/test/demo/demo-list-nids.sh
+++ b/net/test/demo/demo-list-nids.sh
@@ -1,3 +1,30 @@
 #!/bin/bash
+set -eux
 
-awk '{print $1 " " $1 "@tcp"}'
+SSH="ssh"
+
+main()
+{
+	while read addr; do
+		ssh_get_nids $addr | awk "{print \"$addr \" \$0}"
+	done
+}
+
+ssh_sudo()
+{
+	addr=$1
+	shift 1
+
+	$SSH "$addr" sudo "$@"
+}
+
+ssh_get_nids()
+{
+	addr=$1
+
+	ssh_sudo "$1" modprobe lnet
+	ssh_sudo "$1" lctl network up > /dev/null
+	ssh_sudo "$1" lctl list_nids
+}
+
+main "$@"
diff --git a/net/test/demo/demo-test-run.sh b/net/test/demo/demo-test-run.sh
index f0dd97f..9328a26 100755
--- a/net/test/demo/demo-test-run.sh
+++ b/net/test/demo/demo-test-run.sh
@@ -1,3 +1,173 @@
 #!/bin/bash
+set -eux
 
-cat /tmp/raw$(expr \( $RANDOM % 4 \) + 1)
+declare -A NODES
+NODES_NR=0
+
+CONSOLE_SSH=
+CONSOLE_CMD=
+
+SSH="ssh"
+INIT_TIME_S=3
+STOP_TIME_S=5
+
+DIR_SCRIPT=${0%/*}
+TOP_SCRDIR="$DIR_SCRIPT/../../.."
+FILE_COMMON_SH="$TOP_SCRDIR/m0t1fs/linux_kernel/st/common.sh"
+# TODO hardcoded for now
+MOD_GALOIS="$TOP_SCRDIR/extra-libs/galois/src/linux_kernel/galois.ko"
+MOD_M0MERO="$TOP_SCRDIR/build_kernel_modules/m0mero.ko"
+PARAMS_M0MERO="node_uuid=00000000-0000-0000-0000-000000000000"
+
+main()
+{
+	local line
+	local node_ssh
+	local node_space
+	local node_cmd
+
+	read line
+	CONSOLE_SSH=$(echo "$line" | awk "{print \$1}")
+	CONSOLE_CMD="$(echo $line | cmd_get)"
+	while read line; do
+		node_ssh=$(echo "$line" | awk "{print \$1}")
+		node_space=$(echo "$line" | awk "{print \$2}")
+		node_cmd="$(echo $line | cmd_get)"
+		node_set $NODES_NR "ssh" "$node_ssh"
+		node_set $NODES_NR "space" "$node_space"
+		node_set $NODES_NR "cmd" "$node_cmd"
+	done
+	host_pre "$CONSOLE_SSH"
+	for_each_node node_host_pre
+	for_each_node node_pre
+	sleep $INIT_TIME_S
+	console_run
+	sleep $STOP_TIME_S
+	for_each_node node_post
+	for_each_node node_host_post
+	host_post "$CONSOLE_SSH"
+}
+
+# Setter and getter for node associative array
+# $1 - node index in array
+# $2 - parameter name
+# node_set(): $3 - new value
+# node_get(): returns value
+node_set()
+{
+	local index="$1_$2"
+	NODES[$index]=$3
+}
+
+node_get()
+{
+	local index="$1_$2"
+	echo "${NODES[$index]}"
+}
+
+# $1 - function to call.
+#      Node index will be passed to this function as first argument.
+# $2 .. - this parameters will be passed to function as $3 .. .
+for_each_node()
+{
+	local i
+	local func="$1"
+	shift 1
+	for i in $(seq 0 $(expr $NODES_NR - 1)); do
+		$func $i $@
+	done
+}
+
+ssh_sudo()
+{
+	local ssh_credentials="$1"
+	shift 1
+	$SSH "$ssh_credentials" sudo "$@"
+}
+
+cmd_get()
+{
+	awk "{\$1 = \"\"; \$2 = \"\"; print}" | sed -e 's/^[ \t]*//'
+}
+
+console_run()
+{
+	ssh_sudo "$CONSOLE_SSH" "$CONSOLE_CMD"
+}
+
+host_pre()
+{
+	local ssh_credentials="$1"
+	ssh_sudo "$ssh_credentials" modprobe lnet
+	ssh_sudo "$ssh_credentials" lctl network up
+	ssh_sudo "$ssh_credentials" modprobe "$MOD_GALOIS"
+	ssh_sudo "$ssh_credentials" modprobe "$MOD_M0MERO" "$PARAMS_M0MERO"
+}
+
+host_post()
+{
+	local ssh_credentials="$1"
+	ssh_sudo "$ssh_credentials" rmmod m0mero
+	ssh_sudo "$ssh_credentials" rmmod galois
+	ssh_sudo "$ssh_credentials" rmmod lnet
+}
+
+node_host_pre()
+{
+	host_pre "$(node_get $1 ssh)"
+}
+
+node_host_post()
+{
+	host_post "$(node_get $1 ssh)"
+}
+
+node_kernel_pre()
+{
+	local ssh_credentials="$(node_get $1 ssh)"
+	local module="$(node_get $1 cmd)"
+	ssh_sudo "$ssh_credentials" modprobe "$module"
+}
+
+node_kernel_post()
+{
+	local ssh_credentials="$(node_get $1 ssh)"
+	local module="$(node_get $1 cmd | awk '{print \$1}')"
+	ssh_sudo "$ssh_credentials" rmmmod "$module"
+}
+
+node_user_pre()
+{
+	local ssh_credentials="$(node_get $1 ssh)"
+	local cmd="$(node_get $1 cmd)"
+	ssh_sudo "$ssh_credentials" "$cmd"
+}
+
+node_user_post()
+{
+	true
+}
+
+node_pre()
+{
+	local space="$(node_get $1 space)"
+
+	if [ "$space" == "user" ]; then
+		node_user_pre "$@"
+	elif [ "$space" == "kernel" ]; then
+		node_kernel_pre "$@"
+	fi
+}
+
+node_post()
+{
+	local space="$(node_get $1 space)"
+
+	if [ "$space" == "user" ]; then
+		node_user_post "$@"
+	elif [ "$space" == "kernel" ]; then
+		node_kernel_post "$@"
+	fi
+}
+
+main "$@"
-- 
1.8.3.2

