From a4d177ba2907676c7f575763e6a5fd85eff30a5a Mon Sep 17 00:00:00 2001
From: Maxim Medved <Max_Medved@xyratex.com>
Date: Fri, 25 Jan 2013 20:13:53 +0200
Subject: [PATCH 15/79] added number of m0_net_test_commands_recv_enqueue()
 failures to console

---
 net/test/console.c | 5 ++++-
 net/test/console.h | 2 ++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/net/test/console.c b/net/test/console.c
index d03841c..749d120 100644
--- a/net/test/console.c
+++ b/net/test/console.c
@@ -53,6 +53,8 @@ static int console_role_init_fini(struct m0_net_test_console_role_ctx *ctx,
 	if (cfg == NULL)
 		goto fini;
 
+	M0_SET0(ctx);
+
 	addr_console = role == M0_NET_TEST_ROLE_CLIENT ?
 		cfg->ntcc_addr_console4clients : cfg->ntcc_addr_console4servers;
 	nodes = role == M0_NET_TEST_ROLE_CLIENT ?
@@ -291,7 +293,8 @@ size_t m0_net_test_console_cmd(struct m0_net_test_console_ctx *ctx,
 			break;
 		rc = m0_net_test_commands_recv_enqueue(cmd_ctx,
 						       cmd->ntc_buf_index);
-		/** @todo rc != 0 is lost here */
+		if (rc != 0)
+			++rctx->ntcrc_recv_enqueue_errors;
 		m0_net_test_commands_received_free(cmd);
 	}
 	/* send all commands */
diff --git a/net/test/console.h b/net/test/console.h
index a622a49..814c6f4 100644
--- a/net/test/console.h
+++ b/net/test/console.h
@@ -140,6 +140,8 @@ struct m0_net_test_console_role_ctx {
 	int				   *ntcrc_errno;
 	/** status of last received *_DONE command */
 	int				   *ntcrc_status;
+	/** number of m0_net_test_commands_recv_enqueue() failures */
+	size_t				    ntcrc_recv_enqueue_errors;
 };
 
 /** Test console context */
-- 
1.8.3.2

