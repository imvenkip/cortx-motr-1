From 3a97f16f246f203a238b8679a6d54cbac02c824e Mon Sep 17 00:00:00 2001
From: Maxim Medved <Max_Medved@xyratex.com>
Date: Sun, 3 Feb 2013 20:17:17 +0200
Subject: [PATCH 43/79] LogD 1881: different timeouts for normal run and
 debugging in gdb

---
 net/test/ut/client_server.c | 44 +++++++++++---------------------------------
 1 file changed, 11 insertions(+), 33 deletions(-)

diff --git a/net/test/ut/client_server.c b/net/test/ut/client_server.c
index 24d88c6..807ff0e 100644
--- a/net/test/ut/client_server.c
+++ b/net/test/ut/client_server.c
@@ -38,17 +38,9 @@ enum {
 	NTCS_PORTAL		  = 42,
 	NTCS_NODES_MAX		  = 128,
 	NTCS_NODE_ADDR_MAX	  = 0x100,
-	/** @todo 20min for debugging in gdb */
-	/*
-	NTCS_TIMEOUT_CMD_MS	  = 1200000,
-	NTCS_TIMEOUT_SEND_MS	  = 1200000,
-	NTCS_TIMEOUT_RECV_MS	  = 1200000,
-	NTCS_TIMEOUT_BULK_MS	  = 1200000,
-	*/
-	NTCS_TIMEOUT_CMD_MS	  = 20000,
-	NTCS_TIMEOUT_SEND_MS	  = 20000,
-	NTCS_TIMEOUT_RECV_MS	  = 20000,
-	NTCS_TIMEOUT_BULK_MS	  = 20000,
+	NTCS_TIMEOUT		  = 20,
+	/* 20min for debugging in gdb */
+	NTCS_TIMEOUT_GDB	  = 1200,
 	NTCS_TMID_CONSOLE4CLIENTS = 2998,
 	NTCS_TMID_CONSOLE4SERVERS = 2999,
 	NTCS_TMID_NODES		  = 3000,
@@ -69,10 +61,8 @@ static char  servers[(NTCS_NODES_MAX + 1) * NTCS_NODE_ADDR_MAX];
 static char  clients_data[(NTCS_NODES_MAX + 1) * NTCS_NODE_ADDR_MAX];
 static char  servers_data[(NTCS_NODES_MAX + 1) * NTCS_NODE_ADDR_MAX];
 
-static m0_time_t timeout_cmd;
-static m0_time_t timeout_send;
-static m0_time_t timeout_recv;
-static m0_time_t timeout_bulk;
+/* s/NTCS_TIMEOUT/NTCS_TIMEOUT_GDB/ while using gdb */
+static m0_time_t timeout = M0_MKTIME(NTCS_TIMEOUT, 0);
 
 static char *addr_get(const char *nid, int tmid)
 {
@@ -115,14 +105,6 @@ static void net_test_node(struct m0_net_test_node_cfg *node_cfg)
 	m0_free(ctx);
 }
 
-static m0_time_t ms2time(int ms)
-{
-	m0_time_t time;
-
-	return m0_time_set(&time,NTCS_TIMEOUT_SEND_MS / 1000,
-			   (NTCS_TIMEOUT_SEND_MS % 1000) * 1000000);
-}
-
 static void node_cfg_fill(struct m0_net_test_node_cfg *ncfg,
 			  char *addr_cmd,
 			  char *addr_cmd_list,
@@ -133,7 +115,7 @@ static void node_cfg_fill(struct m0_net_test_node_cfg *ncfg,
 {
 	ncfg->ntnc_addr		= addr_cmd;
 	ncfg->ntnc_addr_console = addr_console;
-	ncfg->ntnc_send_timeout = timeout_cmd;
+	ncfg->ntnc_send_timeout = timeout;
 
 	strncat(addr_cmd_list, ncfg->ntnc_addr, NTCS_NODE_ADDR_MAX);
 	strncat(addr_cmd_list, last_node ? "" : ",", 2);
@@ -183,10 +165,6 @@ static void net_test_client_server(const char *nid,
 	if (console_cfg == NULL || console == NULL)
 		goto done;
 	/* prepare config for test clients and test servers */
-	timeout_cmd  = ms2time(NTCS_TIMEOUT_CMD_MS);
-	timeout_send = ms2time(NTCS_TIMEOUT_SEND_MS);
-	timeout_recv = ms2time(NTCS_TIMEOUT_RECV_MS);
-	timeout_bulk = ms2time(NTCS_TIMEOUT_BULK_MS);
 	addr_console4clients = addr_get(nid, NTCS_TMID_CONSOLE4CLIENTS);
 	addr_console4servers = addr_get(nid, NTCS_TMID_CONSOLE4SERVERS);
 	clients[0] = '\0';
@@ -239,11 +217,11 @@ static void net_test_client_server(const char *nid,
 	rc = m0_net_test_slist_init(&console_cfg->ntcc_data_servers,
 				    servers_data, ',');
 	M0_UT_ASSERT(rc == 0);
-	console_cfg->ntcc_cmd_send_timeout   = timeout_cmd;
-	console_cfg->ntcc_cmd_recv_timeout   = timeout_cmd;
-	console_cfg->ntcc_buf_send_timeout   = timeout_send;
-	console_cfg->ntcc_buf_recv_timeout   = timeout_recv;
-	console_cfg->ntcc_buf_bulk_timeout   = timeout_bulk;
+	console_cfg->ntcc_cmd_send_timeout   = timeout;
+	console_cfg->ntcc_cmd_recv_timeout   = timeout;
+	console_cfg->ntcc_buf_send_timeout   = timeout;
+	console_cfg->ntcc_buf_recv_timeout   = timeout;
+	console_cfg->ntcc_buf_bulk_timeout   = timeout;
 	console_cfg->ntcc_test_type	     = type;
 	console_cfg->ntcc_msg_nr	     = msg_nr;
 	console_cfg->ntcc_msg_size	     = msg_size;
-- 
1.8.3.2

