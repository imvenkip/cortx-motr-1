From a395b8e11a01c9678ae67a66e03d90b0b966385e Mon Sep 17 00:00:00 2001
From: Maxim Medved <Max_Medved@xyratex.com>
Date: Sun, 3 Feb 2013 18:32:27 +0200
Subject: [PATCH 29/79] LogD 1870: net/test/debug.h altogether mode support,
 improved doc

---
 net/test/commands.c         |  5 ++---
 net/test/console.c          |  5 ++---
 net/test/debug.h            | 37 ++++++++++++++++++++-----------------
 net/test/node.c             |  5 ++---
 net/test/node_bulk.c        |  5 ++---
 net/test/node_ping.c        |  5 ++---
 net/test/ut/client_server.c |  5 ++---
 7 files changed, 32 insertions(+), 35 deletions(-)

diff --git a/net/test/commands.c b/net/test/commands.c
index 8b0a89a..edf3cbd 100644
--- a/net/test/commands.c
+++ b/net/test/commands.c
@@ -30,9 +30,6 @@
 
 #include "net/test/commands.h"
 
-#ifdef NET_TEST_MODULE_NAME
-#undef NET_TEST_MODULE_NAME
-#endif
 #define NET_TEST_MODULE_NAME commands
 #include "net/test/debug.h"	/* LOGD */
 
@@ -598,6 +595,8 @@ bool m0_net_test_commands_invariant(struct m0_net_test_cmd_ctx *ctx)
 	return true;
 }
 
+#undef NET_TEST_MODULE_NAME
+
 /**
    @} end of NetTestCommandsInternals group
  */
diff --git a/net/test/console.c b/net/test/console.c
index 9c84175..cce45aa 100644
--- a/net/test/console.c
+++ b/net/test/console.c
@@ -25,9 +25,6 @@
 
 #include "net/test/console.h"
 
-#ifdef NET_TEST_MODULE_NAME
-#undef NET_TEST_MODULE_NAME
-#endif
 #define NET_TEST_MODULE_NAME console
 #include "net/test/debug.h"	/* LOGD */
 
@@ -364,6 +361,8 @@ done:
 	return success_nr;
 }
 
+#undef NET_TEST_MODULE_NAME
+
 /**
    @} end of NetTestConsoleInternals group
  */
diff --git a/net/test/debug.h b/net/test/debug.h
index 65ad3cc..ec7b769 100644
--- a/net/test/debug.h
+++ b/net/test/debug.h
@@ -15,14 +15,9 @@
  * http://www.xyratex.com/contact
  *
  * Original author: Maxim Medved <max_medved@xyratex.com>
- * Original creation date: 01/12/2012
+ * Original creation date: 01/12/2013
  */
 
-#pragma once
-
-#ifndef __MERO_NET_TEST_DEBUG_H__
-#define __MERO_NET_TEST_DEBUG_H__
-
 #include "lib/trace.h"	/* M0_LOG */
 
 /**
@@ -31,17 +26,21 @@
 
    Usage recipe
    0. in .c file
-   1. #ifdef NET_TEST_MODULE_NAME
-      #undef NET_TEST_MODULE_NAME
-      #endif
-   2. #define NET_TEST_MODULE_NAME name_of_net_test_module
-   3. #include "net/test/debug.h"
-   4. Use LOGD() macro for regular debug output.
+   1. #define NET_TEST_MODULE_NAME name_of_net_test_module
+   2. #include "net/test/debug.h"
+   3. Use LOGD() macro for regular debug output.
+   4. #undef NET_TEST_MODULE_NAME
+      in the end of file (or scope in which LOGD() is needed)
+      (because of altogether build mode).
    5. Enable/disable debug output from any point using
       LOGD_VAR_NAME(some_module_name) variable
-      (declared using LOGD_VAR_DECLARE(some_module_name) (disabled by default).
+      (declared using LOGD_VAR_DECLARE(some_module_name))
+      Debug output is disabled by default.
 
    Macro names used: LOGD, NET_TEST_MODULE_NAME, LOGD_VAR_DECLARE, LOGD_VAR_NAME
+   @note Include guards are not neeed in this file because
+   LOGD_VAR_NAME(NET_TEST_MODULE_NAME) variable should be defined
+   for each module that includes this file.
 
    @{
  */
@@ -51,17 +50,23 @@ M0_BASSERT("NET_TEST_MODULE_NAME should be defined "
 	   "before including debug.h" == NULL);
 #endif
 
+#ifndef LOGD_VAR_NAME
 #define LOGD_VAR_NAME(module_name)					\
 	M0_CAT(m0_net_test_logd_, module_name)
+#endif
 
+/**
+   There is one variable per inclusion of this file.
+   It is useful to enable/disable module debug messages from any point in code.
+ */
 bool LOGD_VAR_NAME(NET_TEST_MODULE_NAME) = false;
 
+#ifndef LOGD_VAR_DECLARE
 #define LOGD_VAR_DECLARE(module_name)					\
 	extern bool LOGD_VAR_NAME(module_name);
+#endif
 
-#ifdef LOGD
 #undef LOGD
-#endif
 #define LOGD(...)							\
 	do {								\
 		if (LOGD_VAR_NAME(NET_TEST_MODULE_NAME))		\
@@ -73,8 +78,6 @@ bool LOGD_VAR_NAME(NET_TEST_MODULE_NAME) = false;
    @} end of NetTestDebugDFS group
  */
 
-#endif /*  __MERO_NET_TEST_DEBUG_H__ */
-
 /*
  *  Local variables:
  *  c-indentation-style: "K&R"
diff --git a/net/test/node.c b/net/test/node.c
index b3e4969..f3dfdff 100644
--- a/net/test/node.c
+++ b/net/test/node.c
@@ -28,9 +28,6 @@
 #include "net/test/node_ping.h"	/* m0_net_test_node_ping_ops */
 #include "net/test/node_bulk.h"	/* m0_net_test_node_bulk_ops */
 
-#ifdef NET_TEST_MODULE_NAME
-#undef NET_TEST_MODULE_NAME
-#endif
 #define NET_TEST_MODULE_NAME node
 #include "net/test/debug.h"
 
@@ -974,6 +971,8 @@ success:
 }
 M0_EXPORTED(m0_net_test_node_module_initfini);
 
+#undef NET_TEST_MODULE_NAME
+
 /**
    @} end of NetTestNodeInternals group
  */
diff --git a/net/test/node_bulk.c b/net/test/node_bulk.c
index e39038d..6daf100 100644
--- a/net/test/node_bulk.c
+++ b/net/test/node_bulk.c
@@ -35,9 +35,6 @@
 
 #include "net/test/node_bulk.h"
 
-#ifdef NET_TEST_MODULE_NAME
-#undef NET_TEST_MODULE_NAME
-#endif
 #define NET_TEST_MODULE_NAME node_bulk
 #include "net/test/debug.h"		/* LOGD */
 
@@ -1681,6 +1678,8 @@ void m0_net_test_node_bulk_fini(void)
 {
 }
 
+#undef NET_TEST_MODULE_NAME
+
 /**
    @} end of NetTestBulkNodeInternals group
  */
diff --git a/net/test/node_ping.c b/net/test/node_ping.c
index 31f453e..1acff70 100644
--- a/net/test/node_ping.c
+++ b/net/test/node_ping.c
@@ -33,9 +33,6 @@
 
 #include "net/test/node_ping.h"
 
-#ifdef NET_TEST_MODULE_NAME
-#undef NET_TEST_MODULE_NAME
-#endif
 #define NET_TEST_MODULE_NAME node_ping
 #include "net/test/debug.h"		/* LOGD */
 
@@ -958,6 +955,8 @@ struct m0_net_test_service_ops m0_net_test_node_ping_ops = {
 	.ntso_cmd_handler_nr = ARRAY_SIZE(node_ping_cmd_handler),
 };
 
+#undef NET_TEST_MODULE_NAME
+
 /**
    @} end of NetTestPingNodeInternals group
  */
diff --git a/net/test/ut/client_server.c b/net/test/ut/client_server.c
index c99c21c..24d88c6 100644
--- a/net/test/ut/client_server.c
+++ b/net/test/ut/client_server.c
@@ -30,9 +30,6 @@
 #include "net/test/node.h"		/* m0_net_test_node_ctx */
 #include "net/test/console.h"		/* m0_net_test_console_ctx */
 
-#ifdef NET_TEST_MODULE_NAME
-#undef NET_TEST_MODULE_NAME
-#endif
 #define NET_TEST_MODULE_NAME ut_client_server
 #include "net/test/debug.h"
 
@@ -402,6 +399,8 @@ void m0_net_test_client_server_bulk_ut(void)
 			       8, 16, 0x1000, 0x10000);
 }
 
+#undef NET_TEST_MODULE_NAME
+
 /*
  *  Local variables:
  *  c-indentation-style: "K&R"
-- 
1.8.3.2

