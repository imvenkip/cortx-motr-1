From 9a854558e9d8f52d705eac05edf3d16e799c4d8f Mon Sep 17 00:00:00 2001
From: Amit Jambure <Amit_Jambure@xyratex.com>
Date: Wed, 14 Mar 2012 20:16:43 +0530
Subject: [PATCH 03/10] - Add mdservice fop definitions to kcolibri kernel
 module.

---
 .gitignore                        | 1 +
 build_kernel_modules/.gitignore   | 2 ++
 build_kernel_modules/Makefile.in  | 5 ++++-
 c2t1fs/linux_kernel/st/.gitignore | 1 +
 mdservice/md_fops.c               | 9 +++++++--
 mdservice/md_fops.ff              | 6 +++---
 6 files changed, 18 insertions(+), 6 deletions(-)
 create mode 100644 c2t1fs/linux_kernel/st/.gitignore

diff --git a/.gitignore b/.gitignore
index a9ada21..e661de6 100644
--- a/.gitignore
+++ b/.gitignore
@@ -3,6 +3,7 @@
 .tmp_versions
 aclocal.m4
 autom4te.cache
+colibri.spec
 compile
 config.cache
 config.guess
diff --git a/build_kernel_modules/.gitignore b/build_kernel_modules/.gitignore
index 6adaf74..de47945 100644
--- a/build_kernel_modules/.gitignore
+++ b/build_kernel_modules/.gitignore
@@ -11,10 +11,12 @@ galois
 ioservice
 layout
 lib
+mdservice
 net
 pool
 rpc
 sm
 sns
 stob
+ut
 xcode
diff --git a/build_kernel_modules/Makefile.in b/build_kernel_modules/Makefile.in
index c7890ca..928a880 100644
--- a/build_kernel_modules/Makefile.in
+++ b/build_kernel_modules/Makefile.in
@@ -23,7 +23,7 @@ EXTRA_CFLAGS    = -DHAVE_CONFIG_H -I. -I$(CORE_SRCDIR) @KCFLAGS@
 
 dirs  = addb addb/linux_kernel c2t1fs/linux_kernel cob colibri db \
         db/linux_kernel dtm fid fol fop ioservice ioservice/ut    \
-	layout lib lib/linux_kernel lib/ut net net/bulk_emulation \
+	layout lib lib/linux_kernel lib/ut mdservice net net/bulk_emulation \
         net/bulk_emulation/ut net/ksunrpc net/ut pool rpc rpc/ut  \
         sm sns stob stob/ut ut xcode xcode/ut
 
@@ -88,6 +88,9 @@ lib_ut_SOURCES                  := rwlock.c bitmap.c tlist.c chan.c list.c    \
                                    vec.c zerovec.c thread.c bob.c trace.c     \
 				   memory.c
 
+mdservice_SOURCES               := md_fops.c md_fops_k.c
+mdservice_HEADERS               := md_fops_k.h
+
 net_SOURCES                     := buf.c buffer_pool.c domain.c ep.c net.c    \
                                    tm.c connection.c net_cli.c net_utils.c    \
                                    net_srv.c net_otw_types_k.c
diff --git a/c2t1fs/linux_kernel/st/.gitignore b/c2t1fs/linux_kernel/st/.gitignore
new file mode 100644
index 0000000..5621a6e
--- /dev/null
+++ b/c2t1fs/linux_kernel/st/.gitignore
@@ -0,0 +1 @@
+common.sh
diff --git a/mdservice/md_fops.c b/mdservice/md_fops.c
index 25ecf01..814d6d9 100644
--- a/mdservice/md_fops.c
+++ b/mdservice/md_fops.c
@@ -2,9 +2,14 @@
 #  include <config.h>
 #endif
 
-#include "fop/fop.h"
+//#include "fop/fop.h"
+
+#ifndef __KERNEL__
+#   include "mdservice/md_fops_u.h"
+#else
+#   include "mdservice/md_fops_k.h"
+#endif
 
-#include "mdservice/md_fops_u.h"
 #include "fop/fop_format_def.h"
 #include "mdservice/md_fops.ff"
 
diff --git a/mdservice/md_fops.ff b/mdservice/md_fops.ff
index c54565e..e61653c 100644
--- a/mdservice/md_fops.ff
+++ b/mdservice/md_fops.ff
@@ -29,7 +29,7 @@
  *
  */
 
-DEF(c2_fop_fid, RECORD,
+DEF(c2_md_fop_fid, RECORD,
     _(f_seq, U64),
     _(f_oid, U64));
 
@@ -55,8 +55,8 @@ DEF(c2_fop_cob, RECORD,
     _(b_atime, U32),
     _(b_mtime, U32),
     _(b_ctime, U32),
-    _(b_pfid, c2_fop_fid),
-    _(b_tfid, c2_fop_fid));
+    _(b_pfid, c2_md_fop_fid),
+    _(b_tfid, c2_md_fop_fid));
 
 DEF(c2_fop_create, RECORD,
     _(c_body,   c2_fop_cob),
-- 
1.8.3.2

