From 4543fbb901672ddbfddefccd2976cd9b516cbf38 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Mon, 30 May 2011 06:52:13 -0600
Subject: [PATCH 099/177] - fixes about rename.

---
 cob/cob.c         | 10 ++++++++++
 configure.ac      |  2 +-
 mdstore/mdstore.c | 31 +++++++------------------------
 3 files changed, 18 insertions(+), 25 deletions(-)

diff --git a/cob/cob.c b/cob/cob.c
index f62df9c..1155552 100644
--- a/cob/cob.c
+++ b/cob/cob.c
@@ -1142,6 +1142,16 @@ int c2_cob_update_name(struct c2_cob        *cob,
         rc = c2_table_update(tx, &pair);
         c2_db_pair_release(&pair);
         c2_db_pair_fini(&pair);
+
+        /*
+         * Update key to new one.
+         */        
+        if (rc == 0) {
+                c2_free(cob->co_nskey);
+                c2_cob_make_nskey(&cob->co_nskey, &tgtkey->cnk_pfid,
+                                  c2_bitstring_buf_get(&tgtkey->cnk_name),
+                                  c2_bitstring_len_get(&tgtkey->cnk_name));
+        }
 out:
         C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
                     c2_addb_func_fail, "cob_update_name", rc);
diff --git a/configure.ac b/configure.ac
index 36d6e57..1c8f2a7 100755
--- a/configure.ac
+++ b/configure.ac
@@ -367,7 +367,7 @@ else
                 # have position intependent code as nobody case foresee in what addresses inside
                 # calling process it will be mapped
                 AC_MSG_NOTICE([cd $DB_SRC/build_unix && ../dist/configure $o_direct_options && make])
-		cd $DB_SRC/build_unix && ../dist/configure CFLAGS=-fPIC $o_direct_options && make
+		cd $DB_SRC/build_unix && ../dist/configure CFLAGS="$CFLAGS -fPIC" $o_direct_options && make
 		res=$?
 		cd $oldcwd
 		if ! test $res -eq 0 ; then
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 4b07f9d..e422440 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -368,14 +368,14 @@ int c2_md_store_rename(struct c2_md_store       *md,
         /*
          * Cob is just renamed in same parent, not much to do.
          */
-        if (c2_fid_eq(pfid_src, pfid_tgt)) {
-                rc = c2_cob_update_name(cob, srckey, tgtkey, tx);
-                if (rc)
-                        goto out;
+        rc = c2_cob_update_name(cob, srckey, tgtkey, tx);
+        if (rc)
+                goto out;
 
-                cob->co_nsrec.cnr_ctime = now;
+        cob->co_nsrec.cnr_ctime = now;
 
 #if 0
+        if (c2_fid_eq(pfid_src, pfid_tgt)) {
                 /*
                  * Update mtime in parent.
                  */
@@ -391,16 +391,8 @@ int c2_md_store_rename(struct c2_md_store       *md,
                                    NULL, NULL, tx);
                 if (rc)
                         goto out;
-#endif
         } else {
                 /*
-                 * Del name from src parent.
-                 */
-                rc = c2_cob_del_name(cob, srckey, tx);
-                if (rc)
-                        goto out;
-#if 0
-                /*
                  * Update mtime and links in src parent.
                  */
                 if (S_ISDIR(cob->co_nsrec.cnr_mode))
@@ -408,16 +400,7 @@ int c2_md_store_rename(struct c2_md_store       *md,
                 pcob_src->co_nsrec.cnr_mtime = now;
                 pcob_src->co_nsrec.cnr_ctime = now;
                 pcob_src->co_nsrec.cnr_atime = now;
-#endif
-                /*
-                 * Add name to new location.
-                 */
-                rc = c2_cob_add_name(cob, tgtkey, tx);
-                if (rc)
-                        goto out;
-                cob->co_nsrec.cnr_cntr++;
-                cob->co_nsrec.cnr_ctime = now;
-#if 0
+
                 /*
                  * Update mtime and links in tgt parent.
                  */
@@ -444,8 +427,8 @@ int c2_md_store_rename(struct c2_md_store       *md,
                                    NULL, NULL, tx);
                 if (rc)
                         goto out;
-#endif
         }
+#endif
 
         /*
          * Update cob on store to save changed cntr and ctime.
-- 
1.8.3.2

