From 29730a59df3e0960138e3f978734b733eed09ec1 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Tue, 14 Jun 2011 04:18:02 -0600
Subject: [PATCH 131/177] - unlink old name of foreign file in c2_md_create()
 if existing and has old version.

---
 cob/cob.c           |  8 +-------
 cob/ut/cob.c        |  7 +------
 mdservice/md_foms.c | 47 +++++++++++++++++++++++++++++++++++------------
 3 files changed, 37 insertions(+), 25 deletions(-)

diff --git a/cob/cob.c b/cob/cob.c
index 6750463..d86fe8b 100644
--- a/cob/cob.c
+++ b/cob/cob.c
@@ -569,7 +569,7 @@ int c2_cob_lookup(struct c2_cob_domain *dom, struct c2_cob_nskey *nskey,
                 return rc;
 
         cob->co_nskey = nskey;
-        cob->co_valid |= CA_NSKEY;
+        cob->co_valid |= CA_NSKEY | CA_NSKEY_FREE;
 
         rc = cob_ns_lookup(cob, tx);
         if (rc) {
@@ -577,12 +577,6 @@ int c2_cob_lookup(struct c2_cob_domain *dom, struct c2_cob_nskey *nskey,
                 return rc;
         }
 
-        /* 
-         * Otherwise we can't assume NSKEY will stick around. 
-         */
-        if (need & CA_NSKEY_FREE)
-                cob->co_valid |= CA_NSKEY_FREE;
-
         /*
          * Get the fabrec here too if needed.  co_valid will be set
          * correctly inside the call so we can ignore the return code. 
diff --git a/cob/ut/cob.c b/cob/ut/cob.c
index 6efed06..e179b88 100644
--- a/cob/ut/cob.c
+++ b/cob/ut/cob.c
@@ -117,7 +117,6 @@ static void test_add_name(void)
         c2_cob_make_nskey(&key, &pfid, test_name, strlen(test_name));
         rc = c2_cob_lookup(&dom, key, 0, &cob, &tx);
         C2_UT_ASSERT(rc == 0);
-        c2_free(key);
 
         /* add new name to existing cob */
         c2_cob_make_nskey(&key, &pfid, add_name, strlen(add_name));
@@ -129,13 +128,11 @@ static void test_add_name(void)
         rc = c2_cob_lookup(&dom, key, 0, &cob, &tx);
         C2_UT_ASSERT(rc == 0);
         c2_cob_put(cob);
-        c2_free(key);
 
         /* lookup for wrong name, should fail. */
         c2_cob_make_nskey(&key, &pfid, wrong_name, strlen(wrong_name));
         rc = c2_cob_lookup(&dom, key, 0, &cob, &tx);
         C2_UT_ASSERT(rc != 0);
-        c2_free(key);
 
         c2_db_tx_commit(&tx);
 }
@@ -159,7 +156,6 @@ static void test_del_name(void)
         c2_cob_make_nskey(&key, &pfid, test_name, strlen(test_name));
         rc = c2_cob_lookup(&dom, key, 0, &cob, &tx);
         C2_UT_ASSERT(rc == 0);
-        c2_free(key);
 
         /* del name that we created in prev test */
         c2_cob_make_nskey(&key, &pfid, add_name, strlen(add_name));
@@ -170,7 +166,6 @@ static void test_del_name(void)
         /* lookup for new name */
         rc = c2_cob_lookup(&dom, key, 0, &cob, &tx);
         C2_UT_ASSERT(rc != 0);
-        c2_free(key);
 
         c2_db_tx_commit(&tx);
 }
@@ -188,7 +183,7 @@ static void test_lookup(void)
         pfid.f_key = 0x456;
         c2_cob_make_nskey(&key, &pfid, test_name, strlen(test_name));
         c2_db_tx_init(&tx, dom.cd_dbenv, 0);
-        rc = c2_cob_lookup(&dom, key, CA_NSKEY_FREE, &cob, &tx);
+        rc = c2_cob_lookup(&dom, key, 0, &cob, &tx);
         c2_db_tx_commit(&tx);
         C2_UT_ASSERT(rc == 0);
         C2_UT_ASSERT(cob != NULL);
diff --git a/mdservice/md_foms.c b/mdservice/md_foms.c
index 7c3ab90..1402d1b 100644
--- a/mdservice/md_foms.c
+++ b/mdservice/md_foms.c
@@ -148,7 +148,8 @@ static int c2_md_create(struct c2_md_store  *md,
         struct c2_cob *scob = NULL;
         struct c2_cob *ncob = NULL;
         int rc;
-        
+
+restart:        
         rc = c2_md_store_lookup(md, pfid, attr->ca_name, 
                                 attr->ca_namelen, &ncob, tx);
         if (rc == -ENOENT) {
@@ -195,19 +196,41 @@ static int c2_md_create(struct c2_md_store  *md,
                         c2_cob_put(ncob);
                         return rc;
                 }
-                if (attr->ca_version > scob->co_nsrec.cnr_version) {
-                        /*
-                         * Name exists but it has old version. It cannot
-                         * be different file because scanner would give 
-                         * us different fid and we would not get here.
-                         * Let's just update attributes.
-                         */
-                        C2_ASSERT(c2_fid_eq(ncob->co_fid, scob->co_fid));
-                        rc = c2_md_store_setattr(md, scob, attr, tx);
+
+                /*
+                 * Different object, this must be hardlink.
+                 */
+                if (!c2_fid_eq(ncob->co_fid, scob->co_fid)) {
+                        struct c2_cob *ecob;
+                        
+                        rc = c2_md_store_locate(md, ncob->co_fid, &ecob, 
+                                                C2_MD_LOCATE_STORED, tx);
+                        if (rc) {
+                                c2_cob_put(ncob);
+                                return rc;
+                        }
+
+                        if (attr->ca_version > ecob->co_nsrec.cnr_version) {
+                                rc = c2_md_store_unlink(md, pfid, ecob, 
+                                                        attr->ca_name,
+                                                        attr->ca_namelen,
+                                                        tx);
+                                c2_cob_put(ecob);
+                                c2_cob_put(ncob);
+
+                                if (rc)
+                                        return rc;
+                                goto restart;
+                        }
+                        c2_cob_put(ecob);
+                        c2_cob_put(ncob);
                 }
-        }
-        if (ncob)    
+
+                if (attr->ca_version > scob->co_nsrec.cnr_version)
+                        rc = c2_md_store_setattr(md, scob, attr, tx);
+                        
                 c2_cob_put(ncob);
+        }
         if (scob)
                 c2_cob_put(scob);
         return rc;
-- 
1.8.3.2

