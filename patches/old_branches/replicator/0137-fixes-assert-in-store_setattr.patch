From f56d244e697b3a0c491a9bf1469414ee1217510e Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Wed, 15 Jun 2011 15:34:26 -0600
Subject: [PATCH 137/177] - fixes assert in store_setattr(); - don;t apply
 setattr attrs if ca_nlink == 0

---
 mdservice/md_foms.c | 3 ++-
 mdstore/mdstore.c   | 2 +-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/mdservice/md_foms.c b/mdservice/md_foms.c
index 0751bdd..c5437be 100644
--- a/mdservice/md_foms.c
+++ b/mdservice/md_foms.c
@@ -1012,7 +1012,8 @@ static int c2_md_setattr_fom_state(struct c2_fom *fom)
         if (rc)
                 goto out;
 
-        if (attr.ca_version > cob->co_nsrec.cnr_version) {
+        if (attr.ca_version > cob->co_nsrec.cnr_version &&
+            (!(attr.ca_flags & C2_MD_NLINK) || attr.ca_nlink > 0)) {
                 rc = c2_md_store_setattr(site->s_mdstore, cob, &attr,
                                          &ctx->fc_tx->tx_dbtx);
         }
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 176c0e0..7258ad8 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -460,7 +460,7 @@ int c2_md_store_setattr(struct c2_md_store      *md,
                 if (attr->ca_flags & C2_MD_BLKSIZE)
                         nsrec->cnr_blksize = attr->ca_blksize;
                 if (attr->ca_flags & C2_MD_NLINK) {
-                        C2_ASSERT(nsrec->cnr_nlink > 0);
+                        C2_ASSERT(attr->ca_nlink > 0);
                         nsrec->cnr_nlink = attr->ca_nlink;
                 }
                 nsrec->cnr_version = attr->ca_version;
-- 
1.8.3.2

