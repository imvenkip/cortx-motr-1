From 3901a51375634684c79adb1696028b9cfc7ab2ec Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Mon, 30 May 2011 13:57:26 -0600
Subject: [PATCH 100/177] - fixed c2_cob_update_name(). It corrupted nskey due
 to wrong rec size.

---
 cob/cob.c         | 5 +++--
 mdstore/mdstore.c | 2 +-
 mdstore/mdstore.h | 2 +-
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/cob/cob.c b/cob/cob.c
index 1155552..614f27b 100644
--- a/cob/cob.c
+++ b/cob/cob.c
@@ -1126,7 +1126,7 @@ int c2_cob_update_name(struct c2_cob        *cob,
          */
         c2_db_pair_setup(&pair, &cob->co_dom->cd_namespace,
 	                 srckey, c2_cob_nskey_size(srckey),
-		         &nsrec, sizeof nsrec);
+		         NULL, 0);
         rc = c2_table_delete(tx, &pair);
         c2_db_pair_release(&pair);
         c2_db_pair_fini(&pair);
@@ -1138,7 +1138,8 @@ int c2_cob_update_name(struct c2_cob        *cob,
         /* Update object index */
         c2_cob_make_oikey(&oikey, cob->co_fid, nsrec.cnr_linkno);
         c2_db_pair_setup(&pair, &cob->co_dom->cd_object_index,
-                         &oikey, sizeof oikey, &tgtkey, sizeof tgtkey);
+                         &oikey, sizeof oikey, tgtkey,
+                         c2_cob_nskey_size(tgtkey));
         rc = c2_table_update(tx, &pair);
         c2_db_pair_release(&pair);
         c2_db_pair_fini(&pair);
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index e422440..fe7ab71 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -660,7 +660,7 @@ out:
    Find cob by fid.
 */
 int c2_md_store_locate(struct c2_md_store       *md, 
-                       struct c2_fid            *fid,
+                       const struct c2_fid      *fid,
                        struct c2_cob           **cob, 
                        int                       flags, 
                        struct c2_db_tx          *tx)
diff --git a/mdstore/mdstore.h b/mdstore/mdstore.h
index 5a17fa1..47730ae 100644
--- a/mdstore/mdstore.h
+++ b/mdstore/mdstore.h
@@ -304,7 +304,7 @@ int c2_md_store_readdir(struct c2_md_store      *md,
    Find cob by fid.
 */
 int c2_md_store_locate(struct c2_md_store *md, 
-                       struct c2_fid *fid,
+                       const struct c2_fid *fid,
                        struct c2_cob **cob, 
                        int flags, 
                        struct c2_db_tx *tx);
-- 
1.8.3.2

