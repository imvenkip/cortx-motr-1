From b453fa22dae0aa26b1fde37b9bef486d4c62dbe7 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Thu, 7 Apr 2011 08:51:40 -0600
Subject: [PATCH 047/177] - c2_md_store_rename() accepts also pcob_src and
 pcob_tgt.

---
 mdservice/md_foms.c | 41 +++++++++++++++++++++++++++------
 mdstore/mdstore.c   | 66 ++++++++++++++++++++++++++++++++++++++++++-----------
 mdstore/mdstore.h   | 15 ++++++------
 3 files changed, 95 insertions(+), 27 deletions(-)

diff --git a/mdservice/md_foms.c b/mdservice/md_foms.c
index 24ff4c8..7f0ffcd 100644
--- a/mdservice/md_foms.c
+++ b/mdservice/md_foms.c
@@ -254,8 +254,11 @@ static int c2_md_rename_fom_perm(struct c2_fom *fom)
 
 static int c2_md_rename_fom_state(struct c2_fom *fom)
 {
-        struct c2_fop_cob        *body;
+        struct c2_fop_cob        *sbody;
+        struct c2_fop_cob        *tbody;
         struct c2_site           *site;
+        struct c2_cob            *pcob_src;
+        struct c2_cob            *pcob_tgt;
         struct c2_cob            *cob;
         struct c2_fop_rename     *req;
         struct c2_fop_rename_rep *rep;
@@ -263,7 +266,9 @@ static int c2_md_rename_fom_state(struct c2_fom *fom)
         struct c2_fop            *fop;
         struct c2_fop            *fop_rep;
         struct c2_fop_ctx        *ctx;
-        struct c2_fid             fid;
+        struct c2_fid             tfid;
+        struct c2_fid             pfid_tgt;
+        struct c2_fid             pfid_src;
         int                       rc;
 
         fom_obj = container_of(fom, struct c2_fom_md, fm_fom);
@@ -281,20 +286,42 @@ static int c2_md_rename_fom_state(struct c2_fom *fom)
         C2_ASSERT(site != NULL);
 
         req = c2_fop_data(fop);
-        body = &req->r_sbody;
 
-        c2_md_make_fid(&fid, &body->b_tfid);
+        sbody = &req->r_sbody;
+        tbody = &req->r_tbody;
 
-        rc = c2_md_store_locate(site->s_mdstore, &fid, &cob, 
+        c2_md_make_fid(&pfid_src, &sbody->b_pfid);
+        rc = c2_md_store_locate(site->s_mdstore, &pfid_src, &pcob_src, 
                                 C2_MD_STORE_LOCATE_STORE,
                                 &ctx->fc_tx->tx_dbtx);
         if (rc)
                 goto out;
 
-        rep = c2_fop_data(fop_rep);
+        c2_md_make_fid(&pfid_tgt, &tbody->b_pfid);
+        rc = c2_md_store_locate(site->s_mdstore, &pfid_tgt, &pcob_tgt, 
+                                C2_MD_STORE_LOCATE_STORE,
+                                &ctx->fc_tx->tx_dbtx);
+        if (rc) {
+                c2_cob_put(pcob_src);
+                goto out;
+        }
 
-        rc = c2_md_store_rename(site->s_mdstore, cob, req, rep, ctx);
+        c2_md_make_fid(&tfid, &sbody->b_tfid);
+        rc = c2_md_store_locate(site->s_mdstore, &tfid, &cob, 
+                                C2_MD_STORE_LOCATE_STORE,
+                                &ctx->fc_tx->tx_dbtx);
+        if (rc) {
+                c2_cob_put(pcob_src);
+                c2_cob_put(pcob_tgt);
+                goto out;
+        }
+
+        rep = c2_fop_data(fop_rep);
+        rc = c2_md_store_rename(site->s_mdstore, pcob_tgt, pcob_src, 
+                                cob, req, rep, ctx);
         c2_cob_put(cob);
+        c2_cob_put(pcob_src);
+        c2_cob_put(pcob_tgt);
 out:
 	fom->fo_phase = rc ? FOPH_FAILED : FOPH_DONE;
         return FSO_AGAIN;
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 01671ed..c072989 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -139,7 +139,7 @@ int c2_md_store_create_attr(struct c2_md_store *md,
                         pcob->co_nsrec.cnr_mtime = nsrec->cnr_mtime;
                          
                         /*
-                         * Update on-store cob so that updated number of links
+                         * Update on-store cob so that updated time
                          * is saved.
                          */
                         rc = c2_cob_update(pcob, &pcob->co_nsrec,  NULL, NULL, tx);
@@ -289,7 +289,7 @@ int c2_md_store_link(struct c2_md_store *md,
         pcob->co_nsrec.cnr_mtime = time(&now);
                          
         /*
-         * Update on-store cob so that updated number of links
+         * Update on-store cob so that updated time
          * is saved.
          */
         rc = c2_cob_update(pcob, &pcob->co_nsrec,  NULL, NULL, 
@@ -379,7 +379,7 @@ int c2_md_store_unlink(struct c2_md_store *md,
         pcob->co_nsrec.cnr_mtime = time(&now);
                          
         /*
-         * Update on-store cob so that updated number of links
+         * Update on-store cob so that updated time
          * is saved.
          */
         rc = c2_cob_update(pcob, &pcob->co_nsrec,  NULL, NULL, 
@@ -486,17 +486,20 @@ static int c2_md_store_rename_sanity(struct c2_md_store *md,
 }
 
 int c2_md_store_rename(struct c2_md_store *md, 
+                       struct c2_cob *pcob_tgt,
+                       struct c2_cob *pcob_src,
                        struct c2_cob *cob,
                        struct c2_fop_rename *req, 
                        struct c2_fop_rename_rep *rep, 
                        struct c2_fop_ctx *ctx)
 {
-        struct c2_fop_cob    *sbody = &req->r_sbody;
-        struct c2_fop_cob    *tbody = &req->r_tbody;
         struct c2_cob_nskey  *srckey;
         struct c2_cob_nskey  *tgtkey;
+        time_t                now;
         int                   rc;
 
+        C2_ASSERT(pcob_tgt != NULL);
+        C2_ASSERT(pcob_src != NULL);
         C2_ASSERT(cob != NULL);
 
         /*
@@ -510,12 +513,43 @@ int c2_md_store_rename(struct c2_md_store *md,
         /*
          * Prepare src and dst keys.
          */                
-        c2_md_make_nskey(&srckey, &sbody->b_pfid, &req->r_sname);
-        c2_md_make_nskey(&tgtkey, &tbody->b_pfid, &req->r_tname);
-
-        rc = c2_cob_update_name(cob, srckey, tgtkey, &ctx->fc_tx->tx_dbtx);
+        c2_md_store_make_nskey(&srckey, &pcob_src->co_fid, 
+                               req->r_sname.n_name,
+                               req->r_sname.n_count);
+        c2_md_store_make_nskey(&tgtkey, &pcob_tgt->co_fid, 
+                               req->r_tname.n_name,
+                               req->r_tname.n_count);
+
+        rc = c2_cob_update_name(cob, srckey, tgtkey, 
+                                &ctx->fc_tx->tx_dbtx);
         c2_free(srckey);
         c2_free(tgtkey);
+        if (rc)
+                goto out;
+
+        /*
+         * Update mtime in parent.
+         */
+        pcob_src->co_nsrec.cnr_mtime = time(&now);
+                         
+        /*
+         * Update on-store cob so that updated time
+         * is saved.
+         */
+        rc = c2_cob_update(pcob_src, &pcob_src->co_nsrec,  NULL,
+                           NULL, &ctx->fc_tx->tx_dbtx);
+        if (rc)
+                goto out;
+
+        /*
+         * Update time in tgt parent unless it is not the same
+         * as source.
+         */
+        if (!c2_fid_eq(&pcob_src->co_fid, &pcob_tgt->co_fid)) {
+                pcob_tgt->co_nsrec.cnr_mtime = now;
+                rc = c2_cob_update(pcob_tgt, &pcob_tgt->co_nsrec,  
+                                   NULL, NULL, &ctx->fc_tx->tx_dbtx);
+        }
 out:
         C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
                     c2_addb_func_fail, "md_rename", rc);
@@ -607,8 +641,11 @@ int c2_md_store_readdir(struct c2_md_store *md,
 /**
    Find cob by fid.
 */
-int c2_md_store_locate(struct c2_md_store *md, struct c2_fid *fid,
-                       struct c2_cob **cob, int flags, struct c2_db_tx *tx)
+int c2_md_store_locate(struct c2_md_store *md, 
+                       struct c2_fid *fid,
+                       struct c2_cob **cob, 
+                       int flags, 
+                       struct c2_db_tx *tx)
 {
         struct c2_cob_oikey oikey;
         int                 rc;
@@ -630,8 +667,11 @@ int c2_md_store_locate(struct c2_md_store *md, struct c2_fid *fid,
 /**
    Find cob by parent and name.
 */
-int c2_md_store_lookup(struct c2_md_store *md, struct c2_cob *pcob,
-                       const char *name, int namelen, struct c2_cob *cob, 
+int c2_md_store_lookup(struct c2_md_store *md, 
+                       struct c2_cob *pcob,
+                       const char *name, 
+                       int namelen, 
+                       struct c2_cob *cob, 
                        struct c2_db_tx *tx)
 {
         struct c2_cob_nskey *nskey;
diff --git a/mdstore/mdstore.h b/mdstore/mdstore.h
index 9fc34e0..ca97d0e 100644
--- a/mdstore/mdstore.h
+++ b/mdstore/mdstore.h
@@ -47,8 +47,8 @@ int c2_md_store_init(struct c2_md_store *md,
 void c2_md_store_fini(struct c2_md_store *md);
 
 /**
-   Handle link operation described by @req on @cob. Input @cob
-   is so called statdata cob and returned by c2_cob_locate(). 
+   Handle link operation described by @req. Input cobs are
+   so called statdata cobs and returned by c2_cob_locate(). 
    Save result to @rep.
    
    Error code is returned in error case or zero otherwise.
@@ -61,8 +61,8 @@ int c2_md_store_link(struct c2_md_store *md,
                      struct c2_fop_ctx *ctx);
                      
 /**
-   Handle unlink operation described by @req on @cob. Input @cob
-   is so called statdata cob and returned by c2_cob_locate(). 
+   Handle unlink operation described by @req. Input cobs are
+   so called statdata cobs and returned by c2_cob_locate(). 
    Save result to @rep.
    
    Error code is returned in error case or zero otherwise.
@@ -75,13 +75,14 @@ int c2_md_store_unlink(struct c2_md_store *md,
                        struct c2_fop_ctx *ctx);
                        
 /**
-   Handle rename operation described by @req on @cob. Input @cob
-   is so called statdata cob of source and returned by c2_cob_locate(). 
-   Save result to @rep.
+   Handle rename operation described by @req. Input cobs are so called
+   statdata cobs and returned by c2_cob_locate(). 
    
    Error code is returned in error case or zero otherwise.
 */
 int c2_md_store_rename(struct c2_md_store *md, 
+                       struct c2_cob *pcob_tgt,
+                       struct c2_cob *pcob_src,
                        struct c2_cob *cob,
                        struct c2_fop_rename *req, 
                        struct c2_fop_rename_rep *rep, 
-- 
1.8.3.2

