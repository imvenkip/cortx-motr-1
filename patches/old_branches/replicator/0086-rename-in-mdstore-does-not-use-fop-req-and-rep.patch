From 80a03bc9812cecdd1e10ade51408f62d93923600 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Fri, 13 May 2011 16:29:02 -0600
Subject: [PATCH 086/177] - rename in mdstore does not use fop req and rep

---
 mdservice/md_foms.c |  41 ++++++-------------
 mdstore/mdstore.c   | 113 ++++++++++------------------------------------------
 mdstore/mdstore.h   |  32 ++++++---------
 3 files changed, 47 insertions(+), 139 deletions(-)

diff --git a/mdservice/md_foms.c b/mdservice/md_foms.c
index 3e1779b..e54e93f 100644
--- a/mdservice/md_foms.c
+++ b/mdservice/md_foms.c
@@ -187,8 +187,8 @@ static int c2_md_create_fom_state(struct c2_fom *fom)
                 if (rc)
                         goto out;
 
-                rc = c2_md_store_create_raw(site->s_mdstore, &pfid,
-                                            cob, &attr, ctx);
+                rc = c2_md_store_create(site->s_mdstore, &pfid,
+                                        cob, &attr, ctx);
         } else if (rc == 0) {
                 /* 
                  * Already have this object, let's check its version
@@ -445,11 +445,8 @@ static int c2_md_rename_fom_state(struct c2_fom *fom)
         struct c2_fop_cob        *sbody;
         struct c2_fop_cob        *tbody;
         struct c2_site           *site;
-        struct c2_cob            *pcob_src;
-        struct c2_cob            *pcob_tgt;
         struct c2_cob            *cob;
         struct c2_fop_rename     *req;
-        struct c2_fop_rename_rep *rep;
         struct c2_fom_md         *fom_obj;
         struct c2_fop            *fop;
         struct c2_fop            *fop_rep;
@@ -480,37 +477,25 @@ static int c2_md_rename_fom_state(struct c2_fom *fom)
         tbody = &req->r_tbody;
 
         c2_md_make_fid(&pfid_src, &sbody->b_pfid);
-        rc = c2_md_store_locate(site->s_mdstore, &pfid_src, &pcob_src, 
-                                C2_MD_STORE_LOCATE_STORED,
-                                &ctx->fc_tx->tx_dbtx);
-        if (rc)
-                goto out;
-
         c2_md_make_fid(&pfid_tgt, &tbody->b_pfid);
-        rc = c2_md_store_locate(site->s_mdstore, &pfid_tgt, &pcob_tgt, 
-                                C2_MD_STORE_LOCATE_STORED,
-                                &ctx->fc_tx->tx_dbtx);
-        if (rc) {
-                c2_cob_put(pcob_src);
-                goto out;
-        }
-
         c2_md_make_fid(&tfid, &sbody->b_tfid);
+
         rc = c2_md_store_locate(site->s_mdstore, &tfid, &cob, 
                                 C2_MD_STORE_LOCATE_STORED,
                                 &ctx->fc_tx->tx_dbtx);
-        if (rc) {
-                c2_cob_put(pcob_src);
-                c2_cob_put(pcob_tgt);
+        if (rc)
                 goto out;
-        }
 
-        rep = c2_fop_data(fop_rep);
-        rc = c2_md_store_rename(site->s_mdstore, pcob_tgt, pcob_src, 
-                                cob, req, rep, ctx);
+        if (cob->co_nsrec.cnr_version > sbody->b_version) {
+                rc = c2_md_store_rename(site->s_mdstore, &pfid_tgt, 
+                                        &pfid_src, cob,
+                                        req->r_sname.n_name,
+                                        req->r_sname.n_count,
+                                        req->r_tname.n_name,
+                                        req->r_tname.n_count,
+                                        ctx);
+        }
         c2_cob_put(cob);
-        c2_cob_put(pcob_src);
-        c2_cob_put(pcob_tgt);
         if (rc == 0) {
                 svc = fom->fo_fop_ctx->fc_service;
 	        svc->s_ops->so_reply_post(svc, fop_rep, ctx->fc_cookie);
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 262f692..920752b 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -88,11 +88,11 @@ void c2_md_store_fini(struct c2_md_store *md)
 	c2_addb_ctx_fini(&md->md_addb);
 }
 
-int c2_md_store_create_raw(struct c2_md_store       *md,
-                           struct c2_fid            *pfid,
-                           struct c2_cob            *cob,
-                           struct c2_cob_attr       *attr,
-                           struct c2_fop_ctx        *ctx)
+int c2_md_store_create(struct c2_md_store       *md,
+                       struct c2_fid            *pfid,
+                       struct c2_cob            *cob,
+                       struct c2_cob_attr       *attr,
+                       struct c2_fop_ctx        *ctx)
 {
         struct c2_cob_nskey   *nskey;
         struct c2_cob_nsrec    nsrec;
@@ -133,16 +133,6 @@ int c2_md_store_create_raw(struct c2_md_store       *md,
         return rc;
 }
 
-int c2_md_store_create(struct c2_md_store       *md,
-                       struct c2_cob            *pcob,
-                       struct c2_cob            *cob,
-                       struct c2_cob_attr       *attr,
-                       struct c2_fop_ctx        *ctx)
-{
-        return c2_md_store_create_raw(md, pcob->co_fid, cob, 
-                                      attr, ctx);
-}
-
 int c2_md_store_link(struct c2_md_store         *md, 
                      struct c2_cob              *pcob,
                      struct c2_cob              *cob,
@@ -329,65 +319,14 @@ int c2_md_store_close(struct c2_md_store *md,
         return rc;
 }
 
-static int 
-c2_md_store_rename_sanity(struct c2_md_store    *md, 
-                          struct c2_fop_rename  *rename,
-                          struct c2_fop_ctx     *ctx)
-{
-        struct c2_cob_oikey  oikey;
-        struct c2_fid        tgtfid;
-        struct c2_fid        srcfid;
-        struct c2_cob       *tgt;
-        int                  rc;
-
-        c2_md_make_fid(&srcfid, &rename->r_sbody.b_tfid);
-        c2_md_make_fid(&tgtfid, &rename->r_tbody.b_tfid);
-        
-        /*
-         * Going up from the target starting point until root is
-         * reached.
-         */
-        do {
-                /* Is root reached? */
-                if (c2_fid_eq(md->md_root->co_fid, &tgtfid))
-                        return 0;
-                
-                /*
-                 * Let's lookup for a target cob.
-                 */
-                oikey.cok_fid = tgtfid;
-                oikey.cok_linkno = 0;
-
-                rc = c2_cob_locate(&md->md_dom, &oikey, &tgt, 
-                                   &ctx->fc_tx->tx_dbtx);
-                if (rc)
-                        return rc;
-                /*
-                 * Compare current tgt parent stobid with the src id.
-                 * If we found the same id then source is paent of tgt,
-                 * which means sanity did not pass.
-                 */
-                if (c2_fid_eq(&tgt->co_nskey->cnk_pfid, &srcfid)) {
-                        c2_cob_put(tgt);
-                        return -EINVAL;
-                }
-
-                /*
-                 * Get parent fid and repeat.
-                 */
-                tgtfid = tgt->co_nskey->cnk_pfid;
-                c2_cob_put(tgt);
-        } while (1);
-
-        return rc;
-}
-
 int c2_md_store_rename(struct c2_md_store       *md, 
-                       struct c2_cob            *pcob_tgt,
-                       struct c2_cob            *pcob_src,
+                       struct c2_fid            *pfid_tgt,
+                       struct c2_fid            *pfid_src,
                        struct c2_cob            *cob,
-                       struct c2_fop_rename     *req, 
-                       struct c2_fop_rename_rep *rep, 
+                       const char               *name_src,
+                       int                       len_src,
+                       const char               *name_tgt,
+                       int                       len_tgt,
                        struct c2_fop_ctx        *ctx)
 {
         struct c2_cob_nskey  *srckey;
@@ -395,39 +334,28 @@ int c2_md_store_rename(struct c2_md_store       *md,
         time_t                now;
         int                   rc;
 
-        C2_ASSERT(pcob_tgt != NULL);
-        C2_ASSERT(pcob_src != NULL);
+        C2_ASSERT(pfid_tgt != NULL);
+        C2_ASSERT(pfid_src != NULL);
         C2_ASSERT(cob != NULL);
 
         time(&now);
 
         /*
-         * Perform rename sanity checks (source should not be ancestor
-         * of target dir, etc).
-         */
-        rc = c2_md_store_rename_sanity(md, req, ctx);
-        if (rc)
-                goto out;
-
-        /*
          * Prepare src and dst keys.
          */                
-        c2_cob_make_nskey(&srckey, pcob_src->co_fid, 
-                          req->r_sname.n_name,
-                          req->r_sname.n_count);
-        c2_cob_make_nskey(&tgtkey, pcob_tgt->co_fid, 
-                          req->r_tname.n_name,
-                          req->r_tname.n_count);
+        c2_cob_make_nskey(&srckey, pfid_src, name_src, len_src);
+        c2_cob_make_nskey(&tgtkey, pfid_tgt, name_tgt, len_tgt);
 
         /*
          * Cob is just renamed in same parent, not much to do.
          */
-        if (c2_fid_eq(pcob_src->co_fid, pcob_tgt->co_fid)) {
+        if (c2_fid_eq(pfid_src, pfid_tgt)) {
                 rc = c2_cob_update_name(cob, srckey, tgtkey, 
                                         &ctx->fc_tx->tx_dbtx);
                 if (rc)
                         goto out;
 
+#if 0
                 /*
                  * Update mtime in parent.
                  */
@@ -441,6 +369,7 @@ int c2_md_store_rename(struct c2_md_store       *md,
                                    NULL, NULL, &ctx->fc_tx->tx_dbtx);
                 if (rc)
                         goto out;
+#endif
         } else {
                 /*
                  * Del name from src parent.
@@ -448,19 +377,20 @@ int c2_md_store_rename(struct c2_md_store       *md,
                 rc = c2_cob_del_name(cob, srckey, &ctx->fc_tx->tx_dbtx);
                 if (rc)
                         goto out;
-
+#if 0
                 /*
                  * Update mtime and links in src parent.
                  */
                 pcob_src->co_nsrec.cnr_nlink--;
                 pcob_src->co_nsrec.cnr_mtime = now;
-
+#endif
                 /*
                  * Add name to new location.
                  */
                 rc = c2_cob_add_name(cob, tgtkey, &ctx->fc_tx->tx_dbtx);
                 if (rc)
                         goto out;
+#if 0
                 /*
                  * Update mtime and links in tgt parent.
                  */
@@ -484,6 +414,7 @@ int c2_md_store_rename(struct c2_md_store       *md,
                                    NULL, NULL, &ctx->fc_tx->tx_dbtx);
                 if (rc)
                         goto out;
+#endif
         }
 out:
         c2_free(srckey);
diff --git a/mdstore/mdstore.h b/mdstore/mdstore.h
index 6d771f4..92dcd9c 100644
--- a/mdstore/mdstore.h
+++ b/mdstore/mdstore.h
@@ -200,28 +200,20 @@ int c2_md_store_unlink(struct c2_md_store *md,
                        struct c2_fop_ctx *ctx);
                        
 /**
-   Handle rename operation described by @req. Input cobs are so called
-   statdata cobs and returned by c2_cob_locate(). 
+   Handle rename operation described by params. Input cob is
+   statdata cob and returned by c2_cob_locate(). 
    
    Error code is returned in error case or zero otherwise.
 */
-int c2_md_store_rename(struct c2_md_store *md, 
-                       struct c2_cob *pcob_tgt,
-                       struct c2_cob *pcob_src,
-                       struct c2_cob *cob,
-                       struct c2_fop_rename *req, 
-                       struct c2_fop_rename_rep *rep, 
-                       struct c2_fop_ctx *ctx);
-
-/*
- * Create a cob in case that no pcob is availabe, only its fid
- * can be used.
- */
-int c2_md_store_create_raw(struct c2_md_store *md,
-                           struct c2_fid *pfid,
-                           struct c2_cob *cob,
-                           struct c2_cob_attr *attr,
-                           struct c2_fop_ctx *ctx);
+int c2_md_store_rename(struct c2_md_store       *md, 
+                       struct c2_fid            *pfid_tgt,
+                       struct c2_fid            *pfid_src,
+                       struct c2_cob            *cob,
+                       const char               *name_src,
+                       int                       len_src,
+                       const char               *name_tgt,
+                       int                       len_tgt,
+                       struct c2_fop_ctx        *ctx);
 
 /**
    Handle create operation described by @attr on @cob. Input @cob
@@ -230,7 +222,7 @@ int c2_md_store_create_raw(struct c2_md_store *md,
    Error code is returned in error case or zero otherwise.
 */
 int c2_md_store_create(struct c2_md_store *md, 
-                       struct c2_cob *pcob,
+                       struct c2_fid *pfid,
                        struct c2_cob *cob,
                        struct c2_cob_attr *attr,
                        struct c2_fop_ctx *ctx);
-- 
1.8.3.2

