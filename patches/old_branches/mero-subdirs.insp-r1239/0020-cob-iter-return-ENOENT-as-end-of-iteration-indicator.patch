From 15808dc9aa3f7f39cb54d6692757f186d36e9132 Mon Sep 17 00:00:00 2001
From: Alexander Gattin <alexander_gattin@xyratex.com>
Date: Sun, 10 Feb 2013 18:00:08 +0200
Subject: [PATCH 20/25] cob/iter: return -ENOENT as end-of-iteration indicator
 instead of 1

---
 cob/cob.c | 25 ++++---------------------
 cob/cob.h |  8 ++++++++
 2 files changed, 12 insertions(+), 21 deletions(-)

diff --git a/cob/cob.c b/cob/cob.c
index e8336b4..6c35f2c 100644
--- a/cob/cob.c
+++ b/cob/cob.c
@@ -892,20 +892,7 @@ M0_INTERNAL int m0_cob_iterator_init(struct m0_cob *cob,
 
 M0_INTERNAL int m0_cob_iterator_get(struct m0_cob_iterator *it)
 {
-        int rc;
-
-        rc = m0_db_cursor_get(&it->ci_cursor, &it->ci_pair);
-
-        /*
-         * Exact position found.
-         */
-        if (rc == 0)
-                return 1;
-
-        /*
-         * Not exact position found.
-         */
-        return 0;
+        return m0_db_cursor_get(&it->ci_cursor, &it->ci_pair);
 }
 
 M0_INTERNAL int m0_cob_iterator_next(struct m0_cob_iterator *it)
@@ -913,15 +900,11 @@ M0_INTERNAL int m0_cob_iterator_next(struct m0_cob_iterator *it)
         int rc;
 
         rc = m0_db_cursor_next(&it->ci_cursor, &it->ci_pair);
-        if (rc == -ENOENT)
-                return 1;
-        else if (rc != 0)
-                return rc;
 
-        if (!m0_fid_eq(&it->ci_key->cnk_pfid, it->ci_cob->co_fid))
-                return 1;
+        if (rc == 0 && !m0_fid_eq(&it->ci_key->cnk_pfid, it->ci_cob->co_fid))
+                return -ENOENT;
 
-        return 0;
+        return rc;
 }
 
 M0_INTERNAL void m0_cob_iterator_fini(struct m0_cob_iterator *it)
diff --git a/cob/cob.h b/cob/cob.h
index 9ef69cc..1d2bff1 100644
--- a/cob/cob.h
+++ b/cob/cob.h
@@ -679,11 +679,19 @@ M0_INTERNAL int m0_cob_iterator_init(struct m0_cob *cob,
 
 /**
  * Position to next name in a dir cob.
+ *
+ * @retval 0        Success.
+ * @retval -ENOENT  Next name not found in directory.
+ * @retval -errno   Other error.
  */
 M0_INTERNAL int m0_cob_iterator_next(struct m0_cob_iterator *it);
 
 /**
  * Position in table according with @it properties.
+ *
+ * @retval 0        Success.
+ * @retval -ENOENT  Specified position not found in table.
+ * @retval -errno   Other error.
  */
 M0_INTERNAL int m0_cob_iterator_get(struct m0_cob_iterator *it);
 
-- 
1.8.3.2

