From 659d87a2b5ca73e63b1b33eaad859d1262c7b6e0 Mon Sep 17 00:00:00 2001
From: Maxim Medved <max_medved@xyratex.com>
Date: Mon, 9 Dec 2013 05:23:28 +0200
Subject: [PATCH 3/7] stap-allocator: added script to find backtrace for each
 size

---
 scripts/systemtap/be-allocator-size-backtrace.sh  | 14 ++++++++++++++
 scripts/systemtap/be-allocator-size-backtrace.stp | 22 ++++++++++++++++++++++
 scripts/systemtap/run.sh                          |  4 +++-
 3 files changed, 39 insertions(+), 1 deletion(-)
 create mode 100755 scripts/systemtap/be-allocator-size-backtrace.sh
 create mode 100644 scripts/systemtap/be-allocator-size-backtrace.stp

diff --git a/scripts/systemtap/be-allocator-size-backtrace.sh b/scripts/systemtap/be-allocator-size-backtrace.sh
new file mode 100755
index 0000000..9e80be4
--- /dev/null
+++ b/scripts/systemtap/be-allocator-size-backtrace.sh
@@ -0,0 +1,14 @@
+#!/bin/bash
+set -eux
+
+CWD=$(cd "$( dirname "$0")" && pwd)
+SH_SCRIPT="$(basename $0)"
+STP_SCRIPT="$CWD/${SH_SCRIPT%.*}.stp"
+
+LIBMERO="$CWD/../../mero/.libs/libmero-0.1.0.so"
+M0D="$CWD/../../mero/.libs/m0d"
+M0TAPSET="$CWD/tapset"
+
+stap -vv -d "$LIBMERO" -d "$M0D" --ldd -DMAXTRACE=10 -DSTP_NO_OVERLOAD	\
+	-DMAXSKIPPED=1000000 -DMAXERRORS=1000 -I "$M0TAPSET"		\
+	"$STP_SCRIPT" "$LIBMERO" "$M0D"
diff --git a/scripts/systemtap/be-allocator-size-backtrace.stp b/scripts/systemtap/be-allocator-size-backtrace.stp
new file mode 100644
index 0000000..a342ab8
--- /dev/null
+++ b/scripts/systemtap/be-allocator-size-backtrace.stp
@@ -0,0 +1,22 @@
+#!/usr/bin/env stap
+
+global alloc_size_bt
+
+probe m0_be_alloc
+{
+	++alloc_size_bt[size, m0_bt()]
+}
+
+probe begin
+{
+	printf("begin\n");
+}
+
+probe end
+{
+	foreach ([size+, bt] in alloc_size_bt) {
+		printf("size = %d, hits = %d, backtrace: \n%s",
+		       size, alloc_size_bt[size, bt], bt);
+	}
+	printf("end\n");
+}
diff --git a/scripts/systemtap/run.sh b/scripts/systemtap/run.sh
index 9e80be4..d50e867 100755
--- a/scripts/systemtap/run.sh
+++ b/scripts/systemtap/run.sh
@@ -7,8 +7,10 @@ STP_SCRIPT="$CWD/${SH_SCRIPT%.*}.stp"
 
 LIBMERO="$CWD/../../mero/.libs/libmero-0.1.0.so"
 M0D="$CWD/../../mero/.libs/m0d"
+UT="$CWD/../../utils/.libs/lt-ut"
 M0TAPSET="$CWD/tapset"
 
-stap -vv -d "$LIBMERO" -d "$M0D" --ldd -DMAXTRACE=10 -DSTP_NO_OVERLOAD	\
+stap -vv -d "$LIBMERO" -d "$M0D" -d "$UT" --ldd				\
+	-DMAXTRACE=10 -DSTP_NO_OVERLOAD					\
 	-DMAXSKIPPED=1000000 -DMAXERRORS=1000 -I "$M0TAPSET"		\
 	"$STP_SCRIPT" "$LIBMERO" "$M0D"
-- 
1.8.3.2

