From 87a1d7582fb12034cc58bcb2910f9686ea4403a6 Mon Sep 17 00:00:00 2001
From: Anatoliy Bilenko <anatoliy_bilenko@xyratex.com>
Date: Fri, 21 Jun 2013 10:40:17 +0300
Subject: [PATCH 198/290] be: The first tx-test passes after this commit.
 Allocator is not capturing yet.

---
 be/be.c     | 7 +++++--
 be/tx_fom.c | 2 +-
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/be/be.c b/be/be.c
index d03d2c7..cf97980 100644
--- a/be/be.c
+++ b/be/be.c
@@ -122,10 +122,13 @@ M0_INTERNAL void m0_be_op_state_set(struct m0_be_op *op,
 M0_INTERNAL int m0_be_op_tick_ret(struct m0_be_op *op, struct m0_fom *fom,
 				  int next_state)
 {
-	if (M0_IN(op->bo_sm.sm_state, (M0_BOS_SUCCESS, M0_BOS_FAILURE)))
+	m0_sm_group_lock(op->bo_sm.sm_grp);
+
+	if (M0_IN(op->bo_sm.sm_state, (M0_BOS_SUCCESS, M0_BOS_FAILURE))) {
+		m0_sm_group_unlock(op->bo_sm.sm_grp);
 		return M0_FSO_AGAIN;
+	}
 
-	m0_sm_group_lock(op->bo_sm.sm_grp);
 	m0_fom_wait_on(fom, &op->bo_sm.sm_chan, &fom->fo_cb);
 	m0_sm_group_unlock(op->bo_sm.sm_grp);
 
diff --git a/be/tx_fom.c b/be/tx_fom.c
index 16b17cd..11e8a82 100644
--- a/be/tx_fom.c
+++ b/be/tx_fom.c
@@ -29,7 +29,7 @@
 #include "reqh/reqh.h"      /* m0_reqh_state_get */
 #include "lib/errno.h"      /* ENOMEM */
 
-#define XXX_MOCK_IO 1
+#define XXX_MOCK_IO 0
 #if XXX_MOCK_IO /* XXX <<<<<<< */
 #  include "lib/thread.h"
 #  include "lib/mutex.h"
-- 
1.8.3.2

