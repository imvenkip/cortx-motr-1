From ad193510ef3a8447cefe935be3d738c9fca338e5 Mon Sep 17 00:00:00 2001
From: "Valery V. Vorotyntsev" <valery_vorotyntsev@xyratex.com>
Date: Tue, 2 Jul 2013 15:14:04 +0300
Subject: [PATCH 258/290] be: complete implementation of tx_group_tick()

---
 be/tx_fom.c | 23 +++++++++++++++--------
 1 file changed, 15 insertions(+), 8 deletions(-)

diff --git a/be/tx_fom.c b/be/tx_fom.c
index 0b2c2b8..a55fe24 100644
--- a/be/tx_fom.c
+++ b/be/tx_fom.c
@@ -165,22 +165,29 @@ static int tx_group_tick(struct m0_fom *fom)
 		[TGS_LOGGING]    = TGS_COMMITTING,
 		[TGS_COMMITTING] = TGS_PLACING,
 		[TGS_PLACING]    = TGS_PLACED,
-		[TGS_PLACED]     = TGS_STABLE, /* is conditioned */
+		/*
+		 * Note, that we move a tx_group from TGS_PLACED to TGS_STABLE
+		 * only if all of its transactions are M0_BTS_STABLE.
+		 */
+		[TGS_PLACED]     = TGS_STABLE,
 		[TGS_STABLE]     = TGS_OPEN
 	};
-	const int state = m0_fom_phase(fom);
+	const struct m0_be_tx       *tx;
+	const struct m0_be_tx_group *gr =
+		&tx_group_fom(fom)->tgf_engine->te_group;
+	const int                    state = m0_fom_phase(fom);
 
 	M0_ENTRY("state=%u", state);
 	M0_PRE(IS_IN_ARRAY(state, next_state));
 
-	if (state == TGS_FINISH)
+	if (state == TGS_FINISH) {
 		M0_IMPOSSIBLE("XXX Not implemented");
-	else if (state == TGS_PLACED &&
-	    !(XXX all transactions of this tx_group are M0_BTS_STABLE))
-		; /* Stay in TGS_PLACED state. */
-	else
+	} else if (state != TGS_PLACED ||
+		   m0_tlist_forall(&gr_tl, tx, &gr->tg_tx,
+				   m0_be__tx_state(tx) == M0_BTS_STABLE)) {
+		M0_LOG(M0_DEBUG, "Move to state %d", next_state[state]);
 		m0_fom_phase_set(fom, next_state[state]);
-
+	}
 	M0_LEAVE();
 	return M0_FSO_WAIT;
 }
-- 
1.8.3.2

