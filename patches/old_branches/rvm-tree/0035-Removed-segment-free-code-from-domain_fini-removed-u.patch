From a63e58c764568c118392fc0688b60c5aa97ad531 Mon Sep 17 00:00:00 2001
From: Sachin Patil <sachin_patil@xyratex.com>
Date: Wed, 16 Jan 2013 07:22:36 -0800
Subject: [PATCH 35/94] Removed segment free code from domain_fini, removed
 unwanted code from be/ut/be.c

---
 be/be_domain.c |  9 ---------
 be/ut/be.c     | 19 +------------------
 2 files changed, 1 insertion(+), 27 deletions(-)

diff --git a/be/be_domain.c b/be/be_domain.c
index 5a9b44f..79ed756 100644
--- a/be/be_domain.c
+++ b/be/be_domain.c
@@ -206,12 +206,6 @@ M0_INTERNAL void m0_be_domain_fini(struct m0_be_domain *dom)
         m0_tlist_for(&m0_be_seg_tl, &(dom->bd_seg), seg_it) {
                 m0_be_seg_tlink_del_fini(seg_it);
                 m0_be_seg_fini(seg_it);
-
-                /**
-                 * Deallocated segment and stob as it is allocated in
-                 * m0_be_domain_lookup
-                 */
-                m0_free(seg_it);
         } m0_tlist_endfor;
 
         /* Finilize segment list */
@@ -220,9 +214,6 @@ M0_INTERNAL void m0_be_domain_fini(struct m0_be_domain *dom)
         /* Finilize transaction list */
         m0_be_tx_tlist_fini(&(dom->bd_tx));
 
-        /* Finalize named segment */
-        m0_be_seg_fini(&(dom->bd_data));
-
         /* Finalize log device stob */
         m0_stob_fini(dom->bd_impl.log_stob);
 
diff --git a/be/ut/be.c b/be/ut/be.c
index 32d09bc..e235cd8 100644
--- a/be/ut/be.c
+++ b/be/ut/be.c
@@ -34,7 +34,6 @@
 #include "be/be.h"
 
 struct m0_be_seg *seg;
-struct m0_be_seg *lseg;
 struct m0_be_domain dom;
 
 int main()
@@ -68,24 +67,8 @@ int main()
                 printf("\nFailed to create segment \n");
                 return -1;
         }
-        printf("\nSegment is created\n");
 
-        /**
-         * @todo :Implement UT to test segment open
-         */
-
-        printf("\nWaiting for segment to be active\n");
-        m0_be_domain_lookup(&dom, 1, &lseg);
-
-        m0_sm_group_lock(seg->bs_impl.sm_group);
-        m0_sm_timedwait(&(seg->bs_sm),
-                        (1 << M0_BESEG_ACTIVE) | (1 << M0_BESEG_FAILED),
-                        M0_TIME_NEVER);
-        m0_sm_group_unlock(seg->bs_impl.sm_group);
-
-        seg = lseg;
-
-        printf("\nSegment is opened\n");
+        printf("\nSegment is created and opened\n");
 
         printf("\ndata_file_path : %s\n", seg->bs_impl.path_name);
 
-- 
1.8.3.2

