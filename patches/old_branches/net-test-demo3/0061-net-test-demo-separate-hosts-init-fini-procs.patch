From c23d08cb8950446e32c0693395f34147820bec62 Mon Sep 17 00:00:00 2001
From: Alexander Gattin <alexander_gattin@xyratex.com>
Date: Wed, 13 Feb 2013 20:06:45 +0200
Subject: [PATCH 61/99] net-test/demo: separate hosts init/fini procs

---
 net/test/demo/demo.exp | 24 ++++++++++++++++++++----
 1 file changed, 20 insertions(+), 4 deletions(-)

diff --git a/net/test/demo/demo.exp b/net/test/demo/demo.exp
index b35deb1..0c85a73 100755
--- a/net/test/demo/demo.exp
+++ b/net/test/demo/demo.exp
@@ -65,6 +65,8 @@ proc init_host {addr {tmout 10}} {
     } eof {error eof}
 }
 
+# returns 2 lists and 3 flattened arrays:
+# ihosts ehosts pid_al sid_al nid_al
 proc init_hosts {shosts chosts ntopts_al} {
     array set ntopts $ntopts_al
     # create list of unique addresses:
@@ -93,8 +95,10 @@ proc init_hosts {shosts chosts ntopts_al} {
     }
     # execute "date" on initialized hosts and "exit":
     foreach h $ihosts {
-        foreach c [list "sudo lctl net down" "sudo rmmod lnet"\
-        "sudo modprobe lnet" "sudo lctl net up"] {
+        foreach c [list "sudo lctl net down"\
+        "sudo rmmod ksocklnd lnet"\
+        "sudo modprobe lnet"\
+        "sudo lctl net up"] {
             exec_cmd $pid($h) $sid($h) $c 10
         }
         set r [exec_cmd $pid($h) $sid($h) "sudo lctl list_nids" 10]
@@ -105,8 +109,19 @@ proc init_hosts {shosts chosts ntopts_al} {
             }
         }
         if {! [info exists nids($h)]} {error "no NIDs found on $h"}
-        exec_cmd $pid($h) $sid($h) exit 10 wait_eof
     }
+    return [list $ihosts $ehosts [array get pid] [array get sid]\
+        [array get nid]]
+}
+
+proc fini_hosts {ihosts pid_al sid_al} {
+    array set pid $pid_al
+    array set sid $sid_al
+    foreach h $ihosts {catch {
+        exec_cmd $pid($h) $sid($h) "sudo lctl net down" 10
+        exec_cmd $pid($h) $sid($h) "sudo rmmod ksocklnd lnet" 10
+        exec_cmd $pid($h) $sid($h) exit 10 wait_eof
+    }}
 }
 
 proc main {argv0 argv} {
@@ -128,7 +143,8 @@ proc main {argv0 argv} {
     }
     set shosts [split [lindex $argv 0] ,]
     set chosts [split [lindex $argv 1] ,]
-    init_hosts $shosts $chosts [array get ntopts]
+    set r [init_hosts $shosts $chosts [array get ntopts]]
+    fini_hosts [lindex $r 0] [lindex $r 2] [lindex $r 3]
 }
 
 main $argv0 $argv
-- 
1.8.3.2

