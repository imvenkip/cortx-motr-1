From 661ec935e6678a89a5eb1bd08a706167039e6294 Mon Sep 17 00:00:00 2001
From: Alexander Gattin <alexander_gattin@xyratex.com>
Date: Wed, 13 Feb 2013 21:02:34 +0200
Subject: [PATCH 65/99] net-test/demo: allocate unique ctrl/data endpoints for
 hosts/roles

---
 net/test/demo/demo.exp | 29 ++++++++++++++++++++++++++---
 1 file changed, 26 insertions(+), 3 deletions(-)

diff --git a/net/test/demo/demo.exp b/net/test/demo/demo.exp
index c972513..9a434b8 100755
--- a/net/test/demo/demo.exp
+++ b/net/test/demo/demo.exp
@@ -62,8 +62,8 @@ proc init_host {addr {tmout 10}} {
 # 2. pid_al - ssh pid
 # 3. sid_al - ssh spawn_id
 # 4. nid_al - NID
-# 5. cid_al - command EP: 
-# 6. 
+# 5. cep_al - command EP - NID:LNETPID:PORTAL:TMID0
+# 6. dep_al - data EP - NID:LNETPID:PORTAL:TMID1
 proc init_hosts {shosts chosts consoles ntopts_al} {
     array set ntopts $ntopts_al
     # create list of unique addresses:
@@ -107,9 +107,24 @@ proc init_hosts {shosts chosts consoles ntopts_al} {
             }
         }
         if {! [info exists nids($h)]} {error "no NIDs found on $h"}
+        set nid($h) [lindex $nids($h) 0]  ;# XXX: use 1st NID
+    }
+    # assign pair of endpoints to each server, client and console:
+    set tmid $ntopts(e)  ;# counter
+    array set role {consoles con shosts srv chosts clnt}
+    foreach l {shosts chosts consoles} {
+        set r $role($l)
+        foreach h [set $l] {  ;# contents of the list named by $l
+            if {[info exists nid($h)]} {
+                set cep($h,$r) $nid($h):$ntopts(p):$ntopts(o):$tmid
+                incr tmid
+                set dep($h,$r) $nid($h):$ntopts(p):$ntopts(o):$tmid
+                incr tmid
+            }
+        }
     }
     return [list $ihosts $ehosts [array get pid] [array get sid]\
-        [array get nid]]
+        [array get nid] [array get cep] [array get dep]]
 }
 
 proc fini_hosts {ihosts pid_al sid_al tmout} {
@@ -125,6 +140,7 @@ proc fini_hosts {ihosts pid_al sid_al tmout} {
 proc main {argv0 argv} {
     package require cmdline
     set optdesc {
+        {e.arg    3000      "starting TMID for endpoints"}
         {o.arg    42        "portal"}
         {p.arg    12345     "LNET pid"}
         {t.arg    tcp       "network type: tcp or o2ib"}
@@ -145,6 +161,13 @@ proc main {argv0 argv} {
     if {[llength $argv] == 3} {set console [lindex $argv 2]} {
         set console localhost}
     set r [init_hosts $shosts $chosts [list $console] [array get ntopts]]
+    array set cep [lindex $r 5]
+    array set dep [lindex $r 6]
+    send_user "\n"
+    foreach h_r [lsort [array names cep]] {
+        send_user "$h_r ctrl EP = $cep($h_r)\n"
+        send_user "$h_r data EP = $dep($h_r)\n"
+    }
     fini_hosts [lindex $r 0] [lindex $r 2] [lindex $r 3] $ntopts(w)
 }
 
-- 
1.8.3.2

