From 2ce13f8832173a60c63352b7eea53cf94c09b50a Mon Sep 17 00:00:00 2001
From: Maxim Medved <Max_Medved@xyratex.com>
Date: Sun, 3 Feb 2013 21:01:32 +0200
Subject: [PATCH 46/99] LogD 1884: strncat() always nul terminates

---
 net/test/ut/client_server.c | 16 ++++++++--------
 net/test/ut/commands.c      |  5 ++---
 2 files changed, 10 insertions(+), 11 deletions(-)

diff --git a/net/test/ut/client_server.c b/net/test/ut/client_server.c
index 807ff0e..0cf2b59 100644
--- a/net/test/ut/client_server.c
+++ b/net/test/ut/client_server.c
@@ -56,10 +56,10 @@ static struct m0_semaphore	   node_init_sem;
 
 static char *addr_console4clients;
 static char *addr_console4servers;
-static char  clients[(NTCS_NODES_MAX + 1) * NTCS_NODE_ADDR_MAX];
-static char  servers[(NTCS_NODES_MAX + 1) * NTCS_NODE_ADDR_MAX];
-static char  clients_data[(NTCS_NODES_MAX + 1) * NTCS_NODE_ADDR_MAX];
-static char  servers_data[(NTCS_NODES_MAX + 1) * NTCS_NODE_ADDR_MAX];
+static char  clients[NTCS_NODES_MAX * NTCS_NODE_ADDR_MAX];
+static char  servers[NTCS_NODES_MAX * NTCS_NODE_ADDR_MAX];
+static char  clients_data[NTCS_NODES_MAX * NTCS_NODE_ADDR_MAX];
+static char  servers_data[NTCS_NODES_MAX * NTCS_NODE_ADDR_MAX];
 
 /* s/NTCS_TIMEOUT/NTCS_TIMEOUT_GDB/ while using gdb */
 static m0_time_t timeout = M0_MKTIME(NTCS_TIMEOUT, 0);
@@ -117,10 +117,10 @@ static void node_cfg_fill(struct m0_net_test_node_cfg *ncfg,
 	ncfg->ntnc_addr_console = addr_console;
 	ncfg->ntnc_send_timeout = timeout;
 
-	strncat(addr_cmd_list, ncfg->ntnc_addr, NTCS_NODE_ADDR_MAX);
-	strncat(addr_cmd_list, last_node ? "" : ",", 2);
-	strncat(addr_data_list, addr_data, NTCS_NODE_ADDR_MAX);
-	strncat(addr_data_list, last_node ? "" : ",", 2);
+	strncat(addr_cmd_list, ncfg->ntnc_addr, NTCS_NODE_ADDR_MAX - 1);
+	strncat(addr_cmd_list, last_node ? "" : ",", 1);
+	strncat(addr_data_list, addr_data, NTCS_NODE_ADDR_MAX - 1);
+	strncat(addr_data_list, last_node ? "" : ",", 1);
 
 	addr_free(addr_data);
 }
diff --git a/net/test/ut/commands.c b/net/test/ut/commands.c
index 3bf09eb..8259060 100644
--- a/net/test/ut/commands.c
+++ b/net/test/ut/commands.c
@@ -666,11 +666,10 @@ static void commands_node_thread2(struct net_test_cmd_node *node)
 	if (console_thread) {
 		buf[0] = '\0';
 		for (i = 1; i < ARRAY_SIZE(nodes); ++i) {
-			strncat(buf, nodes[i].ntcn_addr, ARRAY_SIZE(buf));
+			strncat(buf, nodes[i].ntcn_addr, NTC_ADDR_LEN_MAX - 1);
 			if (i != ARRAY_SIZE(nodes) - 1)
-				strncat(buf, ",", ARRAY_SIZE(buf));
+				strncat(buf, ",", 1);
 		}
-		buf[ARRAY_SIZE(buf) - 1] = '\0';
 		rc = m0_net_test_slist_init(&endpoints, buf, ',');
 		M0_UT_ASSERT(rc == 0);
 	} else {
-- 
1.8.3.2

