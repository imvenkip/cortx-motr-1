From ed5a8e7b731f726e4cbe5d0d196ac48fd1ad1cb2 Mon Sep 17 00:00:00 2001
From: Alexander Gattin <alexander_gattin@xyratex.com>
Date: Wed, 13 Feb 2013 20:09:31 +0200
Subject: [PATCH 62/99] net-test/demo: use standard exp_continue
 -continue_timer

---
 net/test/demo/demo.exp | 19 +++----------------
 1 file changed, 3 insertions(+), 16 deletions(-)

diff --git a/net/test/demo/demo.exp b/net/test/demo/demo.exp
index 0c85a73..4f25c79 100755
--- a/net/test/demo/demo.exp
+++ b/net/test/demo/demo.exp
@@ -13,16 +13,6 @@ proc finish {pid sid} {
     } timeout {terminate $pid $sid}
 }
 
-# check current time -- if timed out, finish program and ssh
-# and raise a "timeout" exception
-proc tm_ok_or_bomb {pid sid tmout t0} {
-    set t [timestamp]
-    if {$t < $t0 || [expr $t - $t0] > $tmout} {
-        finish $pid $sid
-        error timeout
-    }
-}
-
 # start a command and wait for shell prompt/eof
 # return command output as raw multiline string
 proc exec_cmd {pid sid cmd {tmout 10} {e 0}} {
@@ -30,9 +20,8 @@ proc exec_cmd {pid sid cmd {tmout 10} {e 0}} {
     set r ""
     set t0 [timestamp]
     expect -i $sid -timeout $tmout -re {^([^\r\n]*\r*\n)} {
-        tm_ok_or_bomb $pid $sid $tmout $t0
         append r $expect_out(1,string)
-        exp_continue
+        exp_continue -continue_timer
     } -re {^(([^\r\n]*)[#>$] )$} {
         # got shell prompt
         if {"z$e" != "zwait_eof"} {return $r}
@@ -48,12 +37,10 @@ proc init_host {addr {tmout 10}} {
     set sid $spawn_id
     set t0 [timestamp]
     expect -i $sid -timeout $tmout -re {^[^\r\n]*\r*\n} {
-        tm_ok_or_bomb $pid $sid $tmout $t0
-        exp_continue
+        exp_continue -continue_timer
     } -re {^([^\r\n]*\(yes/no\)\?) ?$} {
-        tm_ok_or_bomb $pid $sid $tmout $t0
         send -i $sid yes\r
-        exp_continue
+        exp_continue -continue_timer
     } -re {^([^\r\n]*([Pp]assword:|\(yes/no\)\?)) ?$} {
         set err $expect_out(1,string)
         finish $pid $sid
-- 
1.8.3.2

