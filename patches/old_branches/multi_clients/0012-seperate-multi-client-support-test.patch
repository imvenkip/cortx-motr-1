From 521b38ac3013f11ddb597f05df670518b2ba467e Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Thu, 6 Mar 2014 16:05:38 +0800
Subject: [PATCH 12/26] seperate multi-client support test.

---
 m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh    |  6 ----
 m0t1fs/linux_kernel/st/m0t1fs_multi_clients.sh | 45 ++++++++++++++++++++++++++
 scripts/m0                                     |  3 ++
 3 files changed, 48 insertions(+), 6 deletions(-)
 create mode 100755 m0t1fs/linux_kernel/st/m0t1fs_multi_clients.sh

diff --git a/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh b/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
index 5d8266b..139dcdb 100644
--- a/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
+++ b/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
@@ -467,16 +467,10 @@ m0t1fs_system_tests()
                 echo "Failed: File creation test failed."
 		return 1
 	}
-	multi_client_test $NR_CLIENTS || {
-                echo "Failed: multi-client test failed."
-		return 1
-	}
-	return 0
 	io_combinations $POOL_WIDTH $NR_DATA $NR_PARITY || {
 		echo "Failed: IO failed.."
 		return 1
 	}
-
 	rmw_test || {
 		echo "Failed: IO-RMW failed.."
 		return 1
diff --git a/m0t1fs/linux_kernel/st/m0t1fs_multi_clients.sh b/m0t1fs/linux_kernel/st/m0t1fs_multi_clients.sh
new file mode 100755
index 0000000..c079d3c
--- /dev/null
+++ b/m0t1fs/linux_kernel/st/m0t1fs_multi_clients.sh
@@ -0,0 +1,45 @@
+#!/bin/sh
+
+#set -x
+
+. `dirname $0`/common.sh
+. `dirname $0`/m0t1fs_common_inc.sh
+. `dirname $0`/m0t1fs_client_inc.sh
+. `dirname $0`/m0t1fs_server_inc.sh
+. `dirname $0`/m0t1fs_rsink.sh
+
+main()
+{
+	NODE_UUID=`uuidgen`
+	mero_service start
+	if [ $? -ne "0" ]
+	then
+		echo "Failed to start Mero Service."
+		return 1
+	fi
+
+        multi_client_test $NR_CLIENTS
+	rc=$?
+
+	# mero_service stop --collect-addb
+	mero_service stop
+	if [ $? -ne "0" ]
+	then
+		echo "Failed to stop Mero Service."
+		return 1
+	fi
+
+	if [ $rc -ne "0" ]
+	then
+		echo "Failed m0t1fs multi-clients tests."
+		return 1
+	fi
+
+	echo "m0t1fs multi-clients tests status: SUCCESS."
+	echo "Test log available at $MERO_TEST_LOGFILE."
+
+	return $rc
+}
+
+trap unprepare EXIT
+main
diff --git a/scripts/m0 b/scripts/m0
index 96c17a0..a85303a 100755
--- a/scripts/m0
+++ b/scripts/m0
@@ -71,6 +71,9 @@ run_st() {
 
     ## other ST
     $SUDO "$SRC/m0t1fs/linux_kernel/st/m0t1fs_test.sh"
+
+    ## multi-clients support ST
+    $SUDO "$SRC/m0t1fs/linux_kernel/st/m0t1fs_multi_clients.sh"
     return
     ## Pool machine query/set testing.
     $SUDO "$SRC/m0t1fs/linux_kernel/st/m0t1fs_poolmach.sh"
-- 
1.8.3.2

