From e2ef3e9aa3fad0f06baa36862b0baffe7d7cfecd Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Sat, 22 Feb 2014 21:43:41 +0800
Subject: [PATCH 04/26] remove duplicated reqh_fini() in m0t1fs_teardown()

---
 m0t1fs/linux_kernel/m0t1fs.c                |  2 --
 m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh | 14 +++++++++-----
 m0t1fs/linux_kernel/st/m0t1fs_test.sh       |  1 -
 m0t1fs/linux_kernel/super.c                 |  5 +++--
 4 files changed, 12 insertions(+), 10 deletions(-)

diff --git a/m0t1fs/linux_kernel/m0t1fs.c b/m0t1fs/linux_kernel/m0t1fs.c
index 43f29c3..b3a1c0a 100644
--- a/m0t1fs/linux_kernel/m0t1fs.c
+++ b/m0t1fs/linux_kernel/m0t1fs.c
@@ -26,8 +26,6 @@
 #define M0_TRACE_SUBSYSTEM M0_TRACE_SUBSYS_M0T1FS
 #include "lib/trace.h"  /* M0_LOG and M0_ENTRY */
 #include "lib/memory.h"
-#include "lib/uuid.h"   /* m0_uuid_generate */
-#include "net/lnet/lnet.h"
 #include "fid/fid.h"
 #include "ioservice/io_fops.h"
 #include "mdservice/md_fops.h"
diff --git a/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh b/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
index 96fef9e..841e4c4 100644
--- a/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
+++ b/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
@@ -364,12 +364,17 @@ multi_client_test()
 		cat $MERO_TEST_LOGFILE
 		return 1
 	}
+	df
 	mount_m0t1fs ${mount_dir_2} 4 $NR_DATA $NR_PARITY $POOL_WIDTH "fid_start=1004" &>> $MERO_TEST_LOGFILE || {
 		cat $MERO_TEST_LOGFILE
+		unmount_m0t1fs ${mount_dir_1} &>> $MERO_TEST_LOGFILE
 		return 1
 	}
+	df
 	mount_m0t1fs ${mount_dir_3} 4 $NR_DATA $NR_PARITY $POOL_WIDTH "fid_start=2004" &>> $MERO_TEST_LOGFILE || {
 		cat $MERO_TEST_LOGFILE
+		unmount_m0t1fs ${mount_dir_1} &>> $MERO_TEST_LOGFILE
+		unmount_m0t1fs ${mount_dir_2} &>> $MERO_TEST_LOGFILE
 		return 1
 	}
 	echo "Three clients mounted:"
@@ -457,11 +462,10 @@ rmw_test()
 
 m0t1fs_system_tests()
 {
-#	file_creation_test $MAX_NR_FILES || {
-#               echo "Failed: File creation test failed."
-#		return 1
-#	}
-
+	file_creation_test $MAX_NR_FILES || {
+                echo "Failed: File creation test failed."
+		return 1
+	}
 	multi_client_test $NR_CLIENTS || {
                 echo "Failed: multi-client test failed."
 		return 1
diff --git a/m0t1fs/linux_kernel/st/m0t1fs_test.sh b/m0t1fs/linux_kernel/st/m0t1fs_test.sh
index 7e3f999..62d188e 100755
--- a/m0t1fs/linux_kernel/st/m0t1fs_test.sh
+++ b/m0t1fs/linux_kernel/st/m0t1fs_test.sh
@@ -51,5 +51,4 @@ main()
 }
 
 trap unprepare EXIT
-
 main
diff --git a/m0t1fs/linux_kernel/super.c b/m0t1fs/linux_kernel/super.c
index cee893e..1f86207 100644
--- a/m0t1fs/linux_kernel/super.c
+++ b/m0t1fs/linux_kernel/super.c
@@ -37,6 +37,7 @@
 #include "rpc/rpclib.h"    /* m0_rcp_client_connect */
 #include "addb/addb.h"
 #include "lib/uuid.h"   /* m0_uuid_generate */
+#include "net/lnet/lnet.h"
 #include "rpc/rpc_internal.h"
 
 extern struct io_mem_stats iommstats;
@@ -988,6 +989,7 @@ static int m0t1fs_net_init(struct m0t1fs_sb *csb)
 
 	M0_ENTRY();
 
+	csb->csb_m0t1fs_globals.g_xprt  = &m0_net_lnet_xprt;;
 	csb->csb_m0t1fs_globals.g_laddr = local_addr;
 	xprt =  csb->csb_m0t1fs_globals.g_xprt;
 	ndom = &csb->csb_m0t1fs_globals.g_ndom;
@@ -1346,10 +1348,9 @@ static void m0t1fs_teardown(struct m0t1fs_sb *csb)
 	m0_addb_mc_fini(&m0_addb_gmc);
 	m0_addb_mc_init(&m0_addb_gmc);
 	disconnect_from_services(csb);
-	m0_reqh_services_terminate(&csb->csb_m0t1fs_globals.g_reqh);
-	m0_reqh_fini(&csb->csb_m0t1fs_globals.g_reqh);
 	m0t1fs_layout_fini(csb);
 	m0t1fs_addb_mon_total_io_size_fini(csb);
+	m0_reqh_services_terminate(&csb->csb_m0t1fs_globals.g_reqh);
 	m0t1fs_rpc_fini(csb);
 	m0t1fs_net_fini(csb);
 }
-- 
1.8.3.2

