From b99bac3259fff1b0056127fead8205d8fbb05ff9 Mon Sep 17 00:00:00 2001
From: Maxim Medved <Max_Medved@xyratex.com>
Date: Mon, 14 Jan 2013 09:28:24 +0200
Subject: [PATCH 67/71] c2_net_buffer_event_pending() used in
 node_bulk_worker()

---
 net/test/node_bulk.c | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/net/test/node_bulk.c b/net/test/node_bulk.c
index 901f387..7b420a4 100644
--- a/net/test/node_bulk.c
+++ b/net/test/node_bulk.c
@@ -1230,7 +1230,7 @@ static void node_bulk_worker(struct node_bulk_ctx *ctx)
 {
 	struct c2_clink	tm_clink;
 	struct c2_chan	tm_chan;
-	bool		notify;
+	bool		pending;
 
 	C2_PRE(ctx != NULL);
 
@@ -1245,7 +1245,6 @@ static void node_bulk_worker(struct node_bulk_ctx *ctx)
 	c2_chan_init(&tm_chan);
 	c2_clink_add(&tm_chan, &tm_clink);
 	/* main loop */
-	notify = true;
 	while (1) {
 		if (ctx->nbc_nh.ntnh_role == C2_NET_TEST_ROLE_CLIENT) {
 			client_process_unused_bulk(ctx);
@@ -1254,14 +1253,15 @@ static void node_bulk_worker(struct node_bulk_ctx *ctx)
 			server_process_unused_ping(ctx);
 		}
 		/* notification for buffer events */
-		if (notify) {
+		pending = c2_net_buffer_event_pending(ctx->nbc_net.ntc_tm);
+		if (!pending) {
 			c2_net_buffer_event_notify(ctx->nbc_net.ntc_tm,
 						   &tm_chan);
-			notify = false;
 		}
 		ctx->nbc_callback_executed = false;
 		/* execute network buffer callbacks in this thread context */
 		c2_net_buffer_event_deliver_all(ctx->nbc_net.ntc_tm);
+		C2_ASSERT(ergo(pending, ctx->nbc_callback_executed));
 		/* state transitions from final states */
 		node_bulk_state_transition_auto_all(ctx);
 		/* update copy of statistics */
@@ -1272,8 +1272,6 @@ static void node_bulk_worker(struct node_bulk_ctx *ctx)
 		/* it was STOP command */
 		if (ctx->nbc_stop_flag)
 			break;
-		if (!ctx->nbc_callback_executed)
-			notify = true;
 	}
 	/* dequeue all queued network buffers */
 	node_bulk_buf_dequeue(ctx);
-- 
1.8.3.2

