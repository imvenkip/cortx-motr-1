From 2ec06557b50ed09eeb5d623d9983a1b626fb4ef0 Mon Sep 17 00:00:00 2001
From: Rohan Puri <rohan_puri@xyratex.com>
Date: Wed, 28 Aug 2013 11:19:56 +0530
Subject: [PATCH 047/121] Fix module insert panic & existing addb uts.

---
 addb/addb_rec.c              | 19 ++++++++++++++-----
 m0t1fs/linux_kernel/m0t1fs.c |  2 +-
 2 files changed, 15 insertions(+), 6 deletions(-)

diff --git a/addb/addb_rec.c b/addb/addb_rec.c
index d79504e..22247f3 100644
--- a/addb/addb_rec.c
+++ b/addb/addb_rec.c
@@ -152,11 +152,20 @@ static void addb_rec_post(struct m0_addb_mc *mc,
 	 */
 	mc->am_evmgr->evm_post(mc, rec);
 
-	/* Invoke all the monitor's filters */
-	m0_tl_for(addb_mon, &mc->am_reqh->rh_addb_monitoring_ctx.amc_list, mon) {
-		M0_ASSERT(m0_addb_monitor_invariant(mon));
-		mon->am_ops->amo_watch(mon, rec, mc->am_reqh);
-	} m0_tl_endfor;
+	/**
+	 * This conditional traversing is required, since for many UTs
+	 * we do not have reqh and so we do not want to traverse.
+	 * @todo: Find a way to remove this condition and instead assert
+	 * on not NULL.
+	 */
+	if (mc->am_reqh != NULL) {
+		/* Invoke all the monitor's filters */
+		m0_tl_for(addb_mon,
+			  &mc->am_reqh->rh_addb_monitoring_ctx.amc_list, mon) {
+			M0_ASSERT(m0_addb_monitor_invariant(mon));
+			mon->am_ops->amo_watch(mon, rec, mc->am_reqh);
+		} m0_tl_endfor;
+	}
 }
 
 #ifndef __KERNEL__
diff --git a/m0t1fs/linux_kernel/m0t1fs.c b/m0t1fs/linux_kernel/m0t1fs.c
index 700f8e9..fe1d741 100644
--- a/m0t1fs/linux_kernel/m0t1fs.c
+++ b/m0t1fs/linux_kernel/m0t1fs.c
@@ -78,7 +78,7 @@ static int m0t1fs_addb_monitor_pfom_tick(struct m0_fom *fom, void *data,
 	/**
 	 * @todo: Implement ADDB summary record posting logic.
 	 */
-	return 0;
+	return -1;
 }
 
 static struct file_system_type m0t1fs_fs_type = {
-- 
1.8.3.2

