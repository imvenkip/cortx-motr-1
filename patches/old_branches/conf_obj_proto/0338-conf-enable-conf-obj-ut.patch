From 46ad3fd48f306e689fd4349bf7c5003b579999de Mon Sep 17 00:00:00 2001
From: "Valery V. Vorotyntsev" <valery_vorotyntsev@xyratex.com>
Date: Wed, 29 Aug 2012 18:53:57 +0300
Subject: [PATCH 338/370] conf: enable conf-obj-ut

---
 conf/obj_ops.c      | 16 ++++++++++++++--
 conf/obj_ops.h      |  3 +++
 conf/ut/Makefile.am |  1 +
 conf/ut/obj.c       | 32 ++++++++++++++++++++++++++------
 4 files changed, 44 insertions(+), 8 deletions(-)

diff --git a/conf/obj_ops.c b/conf/obj_ops.c
index 32cddb2..869e3fd 100644
--- a/conf/obj_ops.c
+++ b/conf/obj_ops.c
@@ -100,6 +100,8 @@ _BOB_TYPE_DEFINE(sdev,       SDEV_MAGIC);
 _BOB_TYPE_DEFINE(partition,  PARTITION_MAGIC);
 #undef _BOB_TYPE_DEFINE
 
+void dummy_fini_XXX(struct c2_conf_obj *obj) {}
+
 /** Configuration object type. */
 static const struct obj_type {
 	/** Size of object. */
@@ -125,7 +127,7 @@ static const struct obj_type {
 			.coo_readdir = NULL, /*XXX*/                          \
 			.coo_fill    = abbrev ## _fill,                       \
 			.coo_match   = abbrev ## _match,                      \
-			.coo_fini    = NULL /*XXX*/			      \
+			.coo_fini    = dummy_fini_XXX                         \
 		}                                                             \
 	}
 
@@ -469,6 +471,16 @@ static int dir_new(const struct c2_buf *dir_id, enum c2_conf_objtype child_type,
 }
 
 /* ------------------------------------------------------------------
+ * Destructors
+ * ------------------------------------------------------------------ */
+
+void c2_conf_obj_delete(struct c2_conf_obj *obj)
+{
+	obj->co_ops->coo_fini(obj);
+	/* XXX Finalise generic object. */
+}
+
+/* ------------------------------------------------------------------
  * c2_conf_match()
  * ------------------------------------------------------------------ */
 
@@ -632,7 +644,7 @@ void c2_conf_obj_put(struct c2_conf_obj *obj)
 }
 
 /* ------------------------------------------------------------------
- * Stubs filling
+ * Fillers
  * ------------------------------------------------------------------ */
 
 static int endpoints_populate(const char ***dest, const struct arr_buf *src);
diff --git a/conf/obj_ops.h b/conf/obj_ops.h
index 858ea44..1fcfbe5 100644
--- a/conf/obj_ops.h
+++ b/conf/obj_ops.h
@@ -176,6 +176,9 @@ void c2_conf_obj_put(struct c2_conf_obj *obj);
 struct c2_conf_obj *c2_conf_obj_new(enum c2_conf_objtype type,
 				    const struct c2_buf *id);
 
+/** XXX */
+void c2_conf_obj_delete(struct c2_conf_obj *obj);
+
 /**
  * Returns false iff cached configuration object and on-wire object
  * have conflicting data.
diff --git a/conf/ut/Makefile.am b/conf/ut/Makefile.am
index 25bd4d4..0dd64a6 100644
--- a/conf/ut/Makefile.am
+++ b/conf/ut/Makefile.am
@@ -1,2 +1,3 @@
 noinst_LTLIBRARIES    = libconf-ut.la
 libconf_ut_la_SOURCES = obj.c reg.c
+libconf_ut_la_LIBADD  = $(top_builddir)/colibri/libcolibri.la
diff --git a/conf/ut/obj.c b/conf/ut/obj.c
index 75f9996..1a8bfa5 100644
--- a/conf/ut/obj.c
+++ b/conf/ut/obj.c
@@ -21,22 +21,42 @@
 #ifdef HAVE_CONFIG_H
 #  include "config.h"
 #endif
-/* #include "conf/obj_ops.c" */
+#include "conf/obj_ops.h"
+#include "conf/reg.h"
+#include "lib/buf.h"
 #include "lib/ut.h"
 
-#if 0 /*XXX*/
-static void test_XXX(void)
+static void test_new(void)
 {
-	XXX;
+	struct c2_conf_obj *obj;
+	struct c2_conf_reg  reg;
+	int                 rc;
+	struct c2_buf       buf = C2_BUF_INITS("profile");
+
+	c2_conf_reg_init(&reg);
+
+	obj = c2_conf_obj_new(C2_CO_PROFILE, &buf /* XXX inline ctor? */);
+	C2_UT_ASSERT(obj != NULL);
+
+	/* XXX TODO: check generic fields */
+
+	/* rc = c2_conf_obj_fill(obj, objx, &reg); */
+	/* C2_UT_ASSERT(rc == 0); */
+	(void)reg;
+	(void)rc;
+
+	/* XXX TODO: check concrete fields */
+
+	c2_conf_obj_delete(obj);
+	c2_conf_reg_fini(&reg);
 }
-#endif /*XXX*/
 
 const struct c2_test_suite conf_obj_ut = {
 	.ts_name  = "conf-obj-ut",
 	.ts_init  = NULL,
 	.ts_fini  = NULL,
 	.ts_tests = {
-		/* { "conf-obj-XXX", test_XXX }, */
+		{ "conf-obj", test_new },
 		{ NULL, NULL }
 	}
 };
-- 
1.8.3.2

