From c0125d1c044bae77fb13506e4159ad7ab07f391f Mon Sep 17 00:00:00 2001
From: Alexander Gattin <alexander_gattin@xyratex.com>
Date: Sat, 9 Feb 2013 20:00:37 +0200
Subject: [PATCH 05/22] m0t1fs/st: do mount/umount without restarting md/io/etc
 services

---
 m0t1fs/linux_kernel/st/st | 16 ++++++++++------
 1 file changed, 10 insertions(+), 6 deletions(-)

diff --git a/m0t1fs/linux_kernel/st/st b/m0t1fs/linux_kernel/st/st
index fade2f7..34822ca 100755
--- a/m0t1fs/linux_kernel/st/st
+++ b/m0t1fs/linux_kernel/st/st
@@ -22,10 +22,7 @@ M0_CORE_DIR=${M0_CORE_DIR%/*/*/*/*}
 ## Path to the file with configuration string for confd.
 CONF_FILE=$SANDBOX_DIR/conf.txt
 
-### Starts LNET. (Note that the script never stops LNET.)
-lnet_up() {
-    modprobe lnet
-    lctl network up >/dev/null
+export_lnet_nid_endpoints() {
     local LNET_NID=`lctl list_nids | head -1`
 
     export M0T1FS_ENDPOINT="$LNET_NID:12345:34:6"
@@ -35,6 +32,13 @@ lnet_up() {
     export CONFD_ENDPOINT="$IOS0_ENDPOINT"
 }
 
+### Starts LNET. (Note that the script never stops LNET.)
+lnet_up() {
+    modprobe lnet
+    lctl network up >/dev/null
+    export_lnet_nid_endpoints
+}
+
 sandbox_init() {
     rm -rf $SANDBOX_DIR
     mkdir -p $SANDBOX_DIR/mnt
@@ -236,8 +240,8 @@ case "${1:-}" in
     rmmod) modules_remove; exit;;
     sstart) _init; exit;;
     sstop) _fini; exit;;
-    mount) _init; _mount local; exit;;
-    umount) umount $SANDBOX_DIR/mnt; _fini; exit;;
+    mount) export_lnet_nid_endpoints; _mount local; exit;;
+    umount) umount $SANDBOX_DIR/mnt; exit;;
     help) usage; exit;;
     *) usage >&2; die;;
 esac
-- 
1.8.3.2

