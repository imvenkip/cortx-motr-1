From ff86cb19b48260b51265b4b94ebb346137e711bf Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Tue, 1 Apr 2014 20:07:56 +0400
Subject: [PATCH 03/13] - fixed some style issues

---
 m0t1fs/linux_kernel/inode.c |  8 +++++---
 m0t1fs/linux_kernel/super.c | 12 ++++++------
 mdstore/mdstore.c           | 24 ++++++++++++------------
 3 files changed, 23 insertions(+), 21 deletions(-)

diff --git a/m0t1fs/linux_kernel/inode.c b/m0t1fs/linux_kernel/inode.c
index 3adb573..9132f08 100644
--- a/m0t1fs/linux_kernel/inode.c
+++ b/m0t1fs/linux_kernel/inode.c
@@ -456,15 +456,17 @@ M0_INTERNAL int m0t1fs_inode_layout_init(struct m0t1fs_inode *ci)
 
 	csb = M0T1FS_SB(ci->ci_inode.i_sb);
 
-        /* 
-         * Obf directory ".mero" is created (currently) on server in mkfs time.
-         * It has zero layout_id and should be handled by setting sb layout id.
+        /*
+         * Obf (open by fid) directory ".mero" is created (currently) on server
+         * in mkfs time. It has zero layout_id and should be handled by setting
+         * sb layout id.
          *
          * @todo: check for name or fid or whatever in order to filter out
          * possible cases when not obf dir has zero layout id.
          */
         if (ci->ci_layout_id == 0)
                 ci->ci_layout_id = csb->csb_layout_id;
+
 	rc = m0t1fs_build_layout_instance(csb, ci->ci_layout_id,
 					  m0t1fs_inode_fid(ci), &linst);
 	if (rc == 0)
diff --git a/m0t1fs/linux_kernel/super.c b/m0t1fs/linux_kernel/super.c
index 6191588..5ded570 100644
--- a/m0t1fs/linux_kernel/super.c
+++ b/m0t1fs/linux_kernel/super.c
@@ -286,7 +286,7 @@ static int mount_opts_validate(const struct mount_opts *mops)
 			       "profile");
 
 	if (!ergo(mops->mo_fid_start != 0, mops->mo_fid_start > 4))
-		M0_RETERR(-EINVAL, "fid_start must be greater than 4");
+		return M0_ERR(-EINVAL, "fid_start must be greater than 4");
 
 	return M0_RC(0);
 }
@@ -304,8 +304,8 @@ static int mount_opts_parse(char *options, struct mount_opts *dest)
 
 	M0_LOG(M0_INFO, "Mount options: `%s'", options);
 
-	M0_SET0(dest);
-	dest->mo_fid_start = 5;   /* Default value */
+	*dest = (struct mount_opts){ .mo_fid_start = 5 /* default value */ };
+
 	while ((op = strsep(&options, ",")) != NULL && *op != '\0') {
 		switch (match_token(op, m0t1fs_mntopt_tokens, args)) {
 		case M0T1FS_MNTOPT_CONFD:
@@ -1454,17 +1454,17 @@ static int m0t1fs_obf_alloc(struct super_block *sb)
 
         obf_dentry = d_alloc_name(sb->s_root, M0_COB_OBF_NAME);
         if (obf_dentry == NULL)
-                M0_RETURN(-ENOMEM);
+                return M0_RC(-ENOMEM);
 
         obf_inode = m0t1fs_iget(sb, &M0_COB_OBF_FID, body);
         if (IS_ERR(obf_inode)) {
                 dput(obf_dentry);
-                M0_RETURN((int)PTR_ERR(obf_inode));
+                return M0_RC((int)PTR_ERR(obf_inode));
         }
 
         d_add(obf_dentry, obf_inode);
         csb->csb_obf_dentry = obf_dentry;
-	M0_RETURN(0);
+	return M0_RC(0);
 }
 
 static void m0t1fs_obf_dealloc(struct super_block *sb) {
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 90c1cfa..3f38328 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -222,7 +222,7 @@ M0_INTERNAL int m0_mdstore_fcreate(struct m0_mdstore     *md,
 	M0_ENTRY();
 	M0_ASSERT(pfid != NULL);
 
-        /* We don't allow normal fs things in obf directory. */
+        /* We don't allow create in obf directory. */
         if (m0_fid_eq(pfid, &M0_COB_OBF_FID)) {
                 rc = -EINVAL;
                 goto out;
@@ -307,7 +307,7 @@ M0_INTERNAL int m0_mdstore_link(struct m0_mdstore       *md,
 	M0_ASSERT(pfid != NULL);
 	M0_ASSERT(cob != NULL);
 
-        /* We don't allow normal fs things in obf directory. */
+        /* We don't allow link in obf directory. */
         if (m0_fid_eq(pfid, &M0_COB_OBF_FID)) {
                 rc = -EINVAL;
                 goto out;
@@ -415,7 +415,7 @@ M0_INTERNAL int m0_mdstore_unlink(struct m0_mdstore     *md,
 	M0_ASSERT(pfid != NULL);
 	M0_ASSERT(cob != NULL);
 
-        /* We don't allow normal fs things in obf directory. */
+        /* We don't allow unlink in obf directory. */
         if (m0_fid_eq(pfid, &M0_COB_OBF_FID)) {
                 rc = -EINVAL;
                 goto out;
@@ -597,8 +597,11 @@ M0_INTERNAL int m0_mdstore_rename(struct m0_mdstore     *md,
 
 	time(&now);
 
-        /* We don't allow normal fs things in obf directory. */
-        if (m0_fid_eq(pfid_tgt, &M0_COB_OBF_FID) || m0_fid_eq(pfid_src, &M0_COB_OBF_FID)) {
+        /* We don't allow rename in/with obf directory. */
+        if (m0_fid_eq(pfid_tgt, &M0_COB_OBF_FID) ||
+            m0_fid_eq(pfid_src, &M0_COB_OBF_FID) ||
+            m0_fid_eq(m0_cob_fid(cob_tgt), &M0_COB_OBF_FID) ||
+            m0_fid_eq(m0_cob_fid(cob_src), &M0_COB_OBF_FID)) {
                 rc = -EINVAL;
                 goto out;
         }
@@ -886,7 +889,7 @@ out:
 }
 
 /**
-   Find cob by @fid and store its pointer to passed @cob.
+   Finds cob by @fid and store its pointer to passed @cob.
  */
 M0_INTERNAL int m0_mdstore_locate(struct m0_mdstore     *md,
 				  const struct m0_fid   *fid,
@@ -921,7 +924,7 @@ M0_INTERNAL int m0_mdstore_locate(struct m0_mdstore     *md,
 }
 
 /**
-   Find cob by name and store its pointer to passed @cob.
+   Finds cob by name and store its pointer to passed @cob.
 
    In order to handle possible obf-like names like this:
    (cat /mnt/mero/.mero/1:5), parent fid is checked and
@@ -951,12 +954,9 @@ M0_INTERNAL int m0_mdstore_lookup(struct m0_mdstore     *md,
           extracted from name.
          */
         if (m0_fid_eq(pfid, &M0_COB_OBF_FID)) {
-                m0_fid_set(&fid, 0, 0);
-                sscanf((char *)name->b_addr, FID_F, FID_R(&fid));
-                if (!m0_fid_is_set(&fid)) {
-                        rc = -EINVAL;
+                rc = m0_fid_sscanf((char *)name->b_addr, &fid);
+                if (rc != 0)
                         goto out;
-                }
                 rc = m0_mdstore_locate(md, &fid, cob, M0_MD_LOCATE_STORED);
         } else {
 	        rc = m0_cob_nskey_make(&nskey, pfid, (char *)name->b_addr, name->b_nob);
-- 
1.8.3.2

