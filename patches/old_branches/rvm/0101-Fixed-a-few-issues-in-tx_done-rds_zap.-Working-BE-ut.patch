From dca37425b3501eaaf7c9acf8c518e452a1672024 Mon Sep 17 00:00:00 2001
From: Zishan Shaikh <zishan_shaikh@xyratex.com>
Date: Mon, 27 May 2013 08:09:18 -0700
Subject: [PATCH 101/121] Fixed a few issues in tx_done, rds_zap. Working BE
 ut. Commit contains debug prints.

---
 be/tx.c       | 27 +++++++++++----------------
 rvm/rds_zap.c |  2 +-
 2 files changed, 12 insertions(+), 17 deletions(-)

diff --git a/be/tx.c b/be/tx.c
index cd3037b..49481a3 100644
--- a/be/tx.c
+++ b/be/tx.c
@@ -203,13 +203,9 @@ M0_INTERNAL void m0_be_tx_done(struct m0_be_tx *tx, struct m0_be_cbinfo *cbinfo)
         M0_ALLOC_PTR(bt_cbdata);
         M0_ASSERT(bt_cbdata != NULL);
 
-        bt_cbdata->btc_tx      = tx;
-        bt_cbinfo              = &bt_cbdata->btc_cbinfo;
-        bt_cbinfo->bc_cb       = m0_be_tx_done_cb;
-        bt_cbinfo->bc_pcbinfo  = cbinfo;
-        bt_cbinfo->bc_sm_group = sm_group;
-        bt_cbinfo->bc_hq       = &tx->bt_dom->bd_hq;
-
+        bt_cbdata->btc_tx = tx;
+        bt_cbinfo         = &bt_cbdata->btc_cbinfo;
+	m0_be_cbinfo_copy_helper(cbinfo, bt_cbinfo, m0_be_tx_done_cb);
         m0_be_handler_post(bt_cbinfo, status, msg_type);
 }
 
@@ -283,25 +279,24 @@ tx_exit:
 M0_INTERNAL void m0_be_tx_done_cb(struct m0_be_cbinfo *cbinfo, int status,
                                   m0_be_msg_type_t msg_type)
 {
-        struct m0_be_tx_cbdata   *bt_cbdata;
+	struct m0_be_tx_cbdata   *bt_cbdata;
         struct m0_be_tx          *tx;
         rvm_return_t              ret;
         enum m0_be_tx_state       tx_state;
-        struct m0_be_cbinfo      *bt_cbinfo;
 
-        bt_cbdata = container_of(cbinfo, struct m0_be_tx_cbdata, btc_cbinfo);
+	bt_cbdata = container_of(cbinfo, struct m0_be_tx_cbdata, btc_cbinfo);
         if(status != 0)
                 goto tx_exit;
 
         tx = bt_cbdata->btc_tx;
         M0_ASSERT(tx != NULL);
-        bt_cbinfo              = &bt_cbdata->btc_cbinfo;
-        bt_cbinfo->bc_cb       = td_rvm_end_transaction_cb;
-        bt_cbinfo->bc_pcbinfo  = cbinfo;
-        bt_cbinfo->bc_sm_group = cbinfo->bc_sm_group;
-        bt_cbinfo->bc_hq       = &tx->bt_dom->bd_hq;
+	/*bt_cbinfo              = &bt_cbdata->btc_cbinfo;*/
+        cbinfo->bc_cb       = td_rvm_end_transaction_cb;
+	/*bt_cbinfo->bc_pcbinfo  = cbinfo;*/
+	/*bt_cbinfo->bc_sm_group = cbinfo->bc_sm_group;*/
+	/*bt_cbinfo->bc_hq       = &tx->bt_dom->bd_hq;*/
 
-        ret = rvm_end_transaction(tx->bt_impl.tx_id, flush, bt_cbinfo);
+        ret = rvm_end_transaction(tx->bt_impl.tx_id, flush, cbinfo);
         if (RVM_SUCCESS != ret) {
                 M0_LOG(M0_DEBUG, "rvm_end_transaction failed in tx_done_cb");
                 tx_state = M0_BETX_FAILED;
diff --git a/rvm/rds_zap.c b/rvm/rds_zap.c
index 70bd53b..e39fa06 100644
--- a/rvm/rds_zap.c
+++ b/rvm/rds_zap.c
@@ -311,7 +311,7 @@ void rd_rvm_truncate_cb(struct m0_be_cbinfo *cbinfo, int status,
 	rvm_release_segment(seg_hdr->n_loadregions, &seg_hdr->regions, seg_hdr);
 
 	if (cbinfo->bc_pcbinfo != NULL && cbinfo->bc_pcbinfo->bc_cb != NULL) {
-                m0_be_handler_post(cbinfo, status, msg_type);
+                m0_be_handler_post(cbinfo->bc_pcbinfo, status, msg_type);
         }
 	m0_free(rd_cbdata);
 }
-- 
1.8.3.2

