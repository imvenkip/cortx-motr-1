From 448a3553b1407a2ec22128bc39b91e8b7899f82d Mon Sep 17 00:00:00 2001
From: Zishan Shaikh <zishan_shaikh@xyratex.com>
Date: Wed, 5 Jun 2013 22:00:06 -0700
Subject: [PATCH 118/121] Fixed an issue in scan_wrap_reverse and related CB

---
 be/ut/be.c          |  3 +--
 rvm/rvm_logrecovr.c | 30 +++++++++++++-----------------
 2 files changed, 14 insertions(+), 19 deletions(-)

diff --git a/be/ut/be.c b/be/ut/be.c
index 6874482..cd0dbbe 100644
--- a/be/ut/be.c
+++ b/be/ut/be.c
@@ -62,7 +62,6 @@ char be_cmd[512];
 static const char        *stob_dir  = "/tmp/__be/o";
 static const char        *stob_file = "0000000000000000.0000000000000001";
 #endif
-extern const char        *log_file;
 struct m0_stob           *log_stob;
 struct m0_stob_domain    *stob_dom;
 struct m0_be_cbinfo       pcbinfo;
@@ -119,7 +118,7 @@ static int log_stob_create(void)
         result = m0_stob_create(log_stob, NULL);
 
         if (result < 0) {
-                M0_LOG(M0_ERROR, "Failed to creat stob in m0_be_seg_create_cb");
+                M0_LOG(M0_ERROR, "Failed to create log stob");
                 return -1;
         }
 
diff --git a/rvm/rvm_logrecovr.c b/rvm/rvm_logrecovr.c
index fc9b9d7..c49120b 100644
--- a/rvm/rvm_logrecovr.c
+++ b/rvm/rvm_logrecovr.c
@@ -869,10 +869,10 @@ void scan_wrap_reverse_cb(struct m0_be_cbinfo *cbinfo, int  be_status,
 			   m0_be_msg_type_t msg_type)
 {
 	log_t		*log;
-	log_buf_t       *log_buf; /* log buffer descriptor */
-	rec_hdr_t       *rec_hdr;           /* temporary cast for record header */
-	log_wrap_t      *log_wrap;          /* temporary cast for wrap marker */
-	long            tmp_ptr;            /* temporary buffer ptr */
+	log_buf_t       *log_buf;
+	rec_hdr_t       *rec_hdr;
+	log_wrap_t      *log_wrap;
+	long            tmp_ptr;
 	lrc_cbdata_t   *lrc_cbdata;
 
 	M0_ASSERT(cbinfo != NULL);
@@ -890,6 +890,7 @@ void scan_wrap_reverse_cb(struct m0_be_cbinfo *cbinfo, int  be_status,
 	that we must interpret it first, otherwise, we may possibly
 	mis-interpret other field of the record to have a struct_id of
 	log_wrap_id ! */
+
 	for (tmp_ptr = (log_buf->ptr - sizeof(log_wrap_t));
 	 tmp_ptr >= 0; tmp_ptr -= sizeof(rvm_length_t))
 	{
@@ -916,8 +917,8 @@ void scan_wrap_reverse_cb(struct m0_be_cbinfo *cbinfo, int  be_status,
 	else assert(rvm_false);
 
 exit:
-        if (cbinfo != NULL && cbinfo->bc_cb != NULL) {
-                m0_be_handler_post(cbinfo, be_status, msg_type);
+        if (cbinfo->bc_pcbinfo != NULL && cbinfo->bc_pcbinfo->bc_cb != NULL) {
+                m0_be_handler_post(cbinfo->bc_pcbinfo, be_status, msg_type);
 		m0_free(lrc_cbdata);
         }
 }
@@ -925,7 +926,7 @@ exit:
 rvm_return_t scan_wrap_reverse(log_t *log, rvm_bool_t synch,
 				struct m0_be_cbinfo *cbinfo)
 {
-	rvm_return_t    retval = RVM_EINTERNAL;
+	rvm_return_t         retval = RVM_EINTERNAL;
 
 	lrc_cbdata_t        *lrc_cbdata;
 	struct m0_be_cbinfo *lrc_cbinfo;
@@ -940,27 +941,23 @@ rvm_return_t scan_wrap_reverse(log_t *log, rvm_bool_t synch,
         }
 
         lrc_cbdata->lrc_log   = log;
-        lrc_cbdata->lrc_synch = synch;
         lrc_cbinfo            = &lrc_cbdata->lrc_cbinfo;
 
 	m0_be_cbinfo_copy_helper(cbinfo, lrc_cbinfo, scan_wrap_reverse_cb);
 	/* load last sectors of log */
-        retval = init_buffer(log, &log->dev.num_bytes, REVERSE, synch, cbinfo);
+        retval = init_buffer(log, &log->dev.num_bytes, REVERSE, synch,
+			     lrc_cbinfo);
+
 	if (retval != RVM_SUCCESS) {
 	     be_status = -1;
 	     msg_type  = retval;
-	     goto exit_err;
 	}
-exit_err:
-	m0_free(lrc_cbdata);
-
 exit:
-       if (retval != RVM_SUCCESS && cbinfo != NULL &&
-            cbinfo->bc_cb != NULL) {
+       if (be_status != 0 && cbinfo != NULL && cbinfo->bc_cb != NULL) {
                 m0_be_handler_post(cbinfo, be_status, msg_type);
+		m0_free(lrc_cbdata);
         }
 	return retval;
-
 }
 
 void __validate_rec_reverse_cb(struct m0_be_cbinfo *cbinfo,
@@ -1562,7 +1559,6 @@ rvm_return_t scan_reverse(log, synch, cbinfo)
 	m0_be_cbinfo_copy_helper(cbinfo, lrc_cbinfo, NULL);
 
 	scan_reverse_cb(lrc_cbinfo, be_status, msg);
-
 exit:
 	if (be_status != 0 && cbinfo->bc_pcbinfo != NULL &&
             cbinfo->bc_pcbinfo->bc_cb != NULL) {
-- 
1.8.3.2

