From ffe0d14ae2e9d88ac0b849bf75f4f5875031e9f1 Mon Sep 17 00:00:00 2001
From: Prashant Dhange <prashant_dhange@xyratex.com>
Date: Mon, 24 Dec 2012 02:53:02 -0800
Subject: [PATCH 015/121] Added M0_BETX_INIT state to tx sm and M0_SDF flags to
 seg state descriptors

---
 be/be.h     |  1 +
 be/be_seg.c |  8 +++-----
 be/be_tx.c  | 18 ++++++++++++++----
 3 files changed, 18 insertions(+), 9 deletions(-)

diff --git a/be/be.h b/be/be.h
index edf143b..32c0dca 100644
--- a/be/be.h
+++ b/be/be.h
@@ -554,6 +554,7 @@ enum m0_be_seg_state {
 
 
 enum m0_be_tx_state {
+        M0_BETX_INIT,
         M0_BETX_PREPARING,
         /* M0_BETX_OPENING renamed to M0_BETX_PREPARED */
         M0_BETX_PREPARED,
diff --git a/be/be_seg.c b/be/be_seg.c
index 7f0f4ff..a3cf3c1 100644
--- a/be/be_seg.c
+++ b/be/be_seg.c
@@ -66,7 +66,7 @@ static const struct m0_sm_state_descr m0_be_seg_states[] = {
         },
 
         [M0_BESEG_OPENING] = {
-                .sd_flags     = M0_SDF_INITIAL,
+                .sd_flags     = 0,
                 .sd_name      = "BE SEG OPENING",
                 .sd_in        = NULL,
                 .sd_ex        = NULL,
@@ -106,9 +106,7 @@ static const struct m0_sm_state_descr m0_be_seg_states[] = {
                 .sd_allowed   = (1 << M0_BESEG_CREATING) |
                                 (1 << M0_BESEG_OPENING)  |
                                 (1 << M0_BESEG_ACTIVE)   |
-                                (1 << M0_BESEG_FAILED)   |
-                                (1 << M0_BESEG_CHECKING) |
-                                (1 << M0_BESEG_DELETING)
+                                (1 << M0_BESEG_FAILED)   
         },
 
         [M0_BESEG_CHECKING] = {
@@ -134,7 +132,7 @@ static const struct m0_sm_state_descr m0_be_seg_states[] = {
         },
 
         [M0_BESEG_FAILED] = {
-                .sd_flags     = 0,
+                .sd_flags     = M0_SDF_FINAL,
                 .sd_name      = "BE SEG FAILED",
                 .sd_in        = NULL,
                 .sd_ex        = NULL,
diff --git a/be/be_tx.c b/be/be_tx.c
index c7593a7..5dbb1c9 100644
--- a/be/be_tx.c
+++ b/be/be_tx.c
@@ -51,13 +51,22 @@
 
 /* State machine variable declarations  */
 static const struct m0_sm_state_descr tx_states[] = {
-        [M0_BETX_PREPARING] = {
+        [M0_BETX_INIT] = {
                 .sd_flags     = M0_SDF_INITIAL,
+                .sd_name      = "BE TX INIT",
+                .sd_in        = NULL,
+                .sd_ex        = NULL,
+                .sd_invariant = NULL,
+                .sd_allowed   = (1 << M0_BETX_PREPARING)   |
+                                (1 << M0_BETX_FAILED)
+        },
+        [M0_BETX_PREPARING] = {
+                .sd_flags     = 0,
                 .sd_name      = "BE TX PREPARING",
                 .sd_in        = NULL,
                 .sd_ex        = NULL,
                 .sd_invariant = NULL,
-                .sd_allowed   = (1 << M0_BETX_PREPARED)     |
+                .sd_allowed   = (1 << M0_BETX_PREPARED)    |
                                 (1 << M0_BETX_PREPARING)   |
                                 (1 << M0_BETX_OPEN)        |
                                 (1 << M0_BETX_FAILED)
@@ -68,7 +77,7 @@ static const struct m0_sm_state_descr tx_states[] = {
                 .sd_in        = NULL,
                 .sd_ex        = NULL,
                 .sd_invariant = NULL,
-                .sd_allowed   = (1 << M0_BETX_PREPARED)     |
+                .sd_allowed   = (1 << M0_BETX_PREPARED)    |
                                 (1 << M0_BETX_OPEN)        |
                                 (1 << M0_BETX_FAILED)
         },
@@ -157,7 +166,7 @@ M0_INTERNAL void m0_be_tx_init(struct m0_be_tx *tx,
         m0_sm_group_lock(tx->bt_impl.sm_group);
 
         /* Register the state machine of the tx into sm_group */
-        m0_sm_init(&tx->bt_sm, &tx_conf, M0_BETX_PREPARING,
+        m0_sm_init(&tx->bt_sm, &tx_conf, M0_BETX_INIT,
                    tx->bt_impl.sm_group, NULL);
 
         /* unlock locked sm group */
@@ -324,6 +333,7 @@ M0_INTERNAL void m0_be_tx_init_cb(struct m0_sm_group *sm_group,
                 /* TODO@ add error log message */
                 goto exit_begin_tx;
         }
+        m0_sm_state_set(&(tx->bt_sm), M0_BETX_PREPARING);
         goto exit;
 
 exit_begin_tx:
-- 
1.8.3.2

