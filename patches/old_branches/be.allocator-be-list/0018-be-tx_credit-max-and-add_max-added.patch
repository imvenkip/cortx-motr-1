From fa4ba1f504a1a4e7b6ccde24fb236068e9bb6644 Mon Sep 17 00:00:00 2001
From: Maxim Medved <max_medved@xyratex.com>
Date: Wed, 20 Nov 2013 01:41:15 +0200
Subject: [PATCH 18/26] be/tx_credit: max() and add_max() added

---
 be/tx_credit.c | 23 ++++++++++++++++++++++-
 be/tx_credit.h | 14 ++++++++++++++
 2 files changed, 36 insertions(+), 1 deletion(-)

diff --git a/be/tx_credit.c b/be/tx_credit.c
index 25520ba..4c5d956 100644
--- a/be/tx_credit.c
+++ b/be/tx_credit.c
@@ -19,7 +19,9 @@
  */
 
 #include "be/tx_credit.h"
-#include "lib/assert.h"    /* M0_PRE */
+
+#include "lib/assert.h"		/* M0_PRE */
+#include "lib/arith.h"		/* max_check */
 
 /**
  * @addtogroup be
@@ -77,6 +79,25 @@ M0_INTERNAL bool m0_be_tx_credit_eq(const struct m0_be_tx_credit *c0,
 	       c0->tc_reg_size == c1->tc_reg_size;
 }
 
+M0_INTERNAL void m0_be_tx_credit_max(struct m0_be_tx_credit *c,
+				     const struct m0_be_tx_credit *c0,
+				     const struct m0_be_tx_credit *c1)
+{
+	*c = M0_BE_TX_CREDIT(max_check(c0->tc_reg_nr,	 c1->tc_reg_nr),
+			     max_check(c0->tc_reg_size, c1->tc_reg_size));
+}
+
+M0_INTERNAL void m0_be_tx_credit_add_max(struct m0_be_tx_credit *c,
+					 const struct m0_be_tx_credit *c0,
+					 const struct m0_be_tx_credit *c1)
+{
+	struct m0_be_tx_credit cred;
+
+	m0_be_tx_credit_max(&cred, c0, c1);
+	m0_be_tx_credit_add(c, &cred);
+}
+
+
 /** @} end of be group */
 
 /*
diff --git a/be/tx_credit.h b/be/tx_credit.h
index dfede40..63ae8ca 100644
--- a/be/tx_credit.h
+++ b/be/tx_credit.h
@@ -112,6 +112,19 @@ M0_INTERNAL void m0_be_tx_credit_mac(struct m0_be_tx_credit *c,
 				     const struct m0_be_tx_credit *c1,
 				     m0_bcount_t k);
 
+/**
+ * c = maximal credit cred: m0_be_tx_credit_le(c0, cred) &&
+ *			    m0_be_tx_credit_le(c1, cred)
+ */
+M0_INTERNAL void m0_be_tx_credit_max(struct m0_be_tx_credit *c,
+				     const struct m0_be_tx_credit *c0,
+				     const struct m0_be_tx_credit *c1);
+
+/* c += m0_be_tx_credit_max(c, c0, c1) */
+M0_INTERNAL void m0_be_tx_credit_add_max(struct m0_be_tx_credit *c,
+					 const struct m0_be_tx_credit *c0,
+					 const struct m0_be_tx_credit *c1);
+
 /* c0 <= c1 */
 M0_INTERNAL bool m0_be_tx_credit_le(const struct m0_be_tx_credit *c0,
 				    const struct m0_be_tx_credit *c1);
@@ -120,6 +133,7 @@ M0_INTERNAL bool m0_be_tx_credit_le(const struct m0_be_tx_credit *c0,
 M0_INTERNAL bool m0_be_tx_credit_eq(const struct m0_be_tx_credit *c0,
 				    const struct m0_be_tx_credit *c1);
 
+
 /** @} end of be group */
 #endif /* __MERO_BE_TX_CREDIT_H__ */
 
-- 
1.8.3.2

