From 7c2cbe69b310a7de03e85ec3ec0b9d370fc7f07e Mon Sep 17 00:00:00 2001
From: Anatoliy Bilenko <anatoliy_bilenko@xyratex.com>
Date: Tue, 5 Mar 2013 22:34:19 +0200
Subject: [PATCH 03/24] XXX: Added bulk-mem transport into rpc/ut for
 experiments.

---
 rpc/ut/clnt_srv_ctx.c | 29 +++++++++++++++++++++++------
 1 file changed, 23 insertions(+), 6 deletions(-)

diff --git a/rpc/ut/clnt_srv_ctx.c b/rpc/ut/clnt_srv_ctx.c
index 4816f10..aef355d 100644
--- a/rpc/ut/clnt_srv_ctx.c
+++ b/rpc/ut/clnt_srv_ctx.c
@@ -22,16 +22,13 @@
 #include "fop/fop.h"               /* m0_fop_alloc */
 #include "ut/cs_fop_foms.h"        /* cs_ds2_req_fop_fopt */
 #include "ut/cs_fop_foms_xc.h"     /* cs_ds2_req_fop */
-#include "net/lnet/lnet.h"  /* m0_net_lnet_xprt */
+#include "net/lnet/lnet.h"         /* m0_net_lnet_xprt */
+#include "net/bulk_mem.h"          /* m0_net_bulk_mem_xprt */
 #include "rpc/rpclib.h"
 
 #ifndef __KERNEL__
 
-#define CLIENT_ENDPOINT_ADDR       "0@lo:12345:34:*"
 #define CLIENT_DB_NAME		   "rpclib_ut_client.db"
-
-#define SERVER_ENDPOINT_ADDR	   "0@lo:12345:34:1"
-#define SERVER_ENDPOINT		   "lnet:" SERVER_ENDPOINT_ADDR
 #define SERVER_DB_FILE_NAME	   "rpc_ut_server.db"
 #define SERVER_STOB_FILE_NAME	   "rpc_ut_server.stob"
 #define SERVER_ADDB_STOB_FILE_NAME "rpc_ut_server.addb_stob"
@@ -45,7 +42,27 @@ enum {
 	MAX_RETRIES        = 5,
 };
 
-static struct m0_net_xprt    *xprt = &m0_net_lnet_xprt;
+/*
+ * Network layer transport selection:
+ * 0 - mem-bulk;
+ * 1 - lnet.
+ */
+#if 0
+
+#define CLIENT_ENDPOINT_ADDR    "0@lo:12345:34:*"
+#define SERVER_ENDPOINT_ADDR    "0@lo:12345:34:1"
+#define SERVER_ENDPOINT         "lnet:" SERVER_ENDPOINT_ADDR
+static struct m0_net_xprt *xprt = &m0_net_lnet_xprt;
+
+#else
+
+#define CLIENT_ENDPOINT_ADDR    "127.0.0.1:12345"
+#define SERVER_ENDPOINT_ADDR    "127.0.0.1:12345"
+#define SERVER_ENDPOINT         "bulk-mem:" SERVER_ENDPOINT_ADDR
+static struct m0_net_xprt *xprt = &m0_net_bulk_mem_xprt;
+
+#endif
+
 static struct m0_net_domain   client_net_dom = { };
 static struct m0_dbenv        client_dbenv;
 static struct m0_cob_domain   client_cob_dom;
-- 
1.8.3.2

