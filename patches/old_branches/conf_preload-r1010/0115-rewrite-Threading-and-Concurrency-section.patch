From 3b7648d2acd1f25e5e191673c79a4c9cb7e8992d Mon Sep 17 00:00:00 2001
From: "Valery V. Vorotyntsev" <valery_vorotyntsev@xyratex.com>
Date: Mon, 2 Apr 2012 21:34:07 +0300
Subject: [PATCH 115/311] rewrite `Threading and Concurrency' section

---
 conf/confc.c | 31 ++++++++++++++++++-------------
 1 file changed, 18 insertions(+), 13 deletions(-)

diff --git a/conf/confc.c b/conf/confc.c
index 7734336..85d4f5f 100644
--- a/conf/confc.c
+++ b/conf/confc.c
@@ -424,19 +424,24 @@
  * <!------------------------------------------------------------------>
  * @subsection confc-dld-lspec-thread Threading and Concurrency Model
  *
- * When a confc instance is started (c2_confc_init()), it gets
- * associated with a state machine group (c2_sm_group).  Confc state
- * machine transitions occur under state machine group lock.
- *
- * A user managing the state machine group is responsible for making
- * sure c2_sm_asts_run() is called when c2_sm_group::s_clink is
- * signaled.  See @ref sm (search for `"ast" thread'.)
- *
- * A confc instance locks c2_conf_cache::cc_lock when performing any
- * of the following operations:
- * - updating c2_conf_cache::cc_registry;
- * - updating c2_conf_obj::co_status;
- * - updating c2_conf_obj::co_nrefs.
+ * There are as many state machines in operation as there are
+ * unfinished c2_confc_*open*() requests.
+ *
+ * At most one state transition (c2_sm_state_descr::sd_in) can be
+ * running at any given time.  Such synchronization of state
+ * transitions is achieved by using c2_sm_group (c2_confc::cc_group).
+ *
+ * A function modifying the cache (adding new object, enriching
+ * existing one, or changing object's reference counter) must hold
+ * cache lock (c2_confc::cc_lock).
+ *
+ * If a function needs both locks -- group lock and cache lock -- for
+ * its operation, group lock must be acquired first.
+ *
+ * A user managing the state machine group (c2_confc::cc_group) is
+ * responsible for making sure c2_sm_asts_run() is called when
+ * c2_sm_group::s_clink is signaled.  See @ref sm (search for `"ast"
+ * thread'.)
  *
  * <hr> <!------------------------------------------------------------->
  * @section confc-dld-conformance Conformance
-- 
1.8.3.2

