From db0927bf1d68cfb09adf2755e0df2743c7fa4c21 Mon Sep 17 00:00:00 2001
From: Amit Jambure <Amit_Jambure@xyratex.com>
Date: Thu, 23 May 2013 13:24:57 +0530
Subject: [PATCH 17/60] rpc: Remove code related to creation/lookup of
 root-session-cob.

---
 mero/setup.c          | 25 -------------------------
 reqh/ut/reqh_fom_ut.c | 12 +-----------
 ut/ut_rpc_machine.c   | 12 +-----------
 3 files changed, 2 insertions(+), 47 deletions(-)

diff --git a/mero/setup.c b/mero/setup.c
index e2acc21..bbc04be 100644
--- a/mero/setup.c
+++ b/mero/setup.c
@@ -1212,25 +1212,6 @@ static void cs_net_domains_fini(struct m0_mero *cctx)
 		m0_net_xprt_fini(xprts[idx]);
 }
 
-static int cs_storage_prepare(struct m0_reqh_context *rctx)
-{
-	struct m0_db_tx tx;
-	int rc;
-
-	rc = m0_db_tx_init(&tx, &rctx->rc_db, 0);
-	if (rc != 0)
-		return rc;
-
-	rc = m0_cob_domain_mkfs(&rctx->rc_mdstore.md_dom, &M0_COB_SLASH_FID,
-				&M0_COB_SESSIONS_FID, &tx);
-	if (rc == 0)
-		m0_db_tx_commit(&tx);
-	else
-		m0_db_tx_abort(&tx);
-
-	return rc;
-}
-
 /**
    Initializes storage for ADDB depending on the type of specified
    while running m0d. It also creates a hard-coded stob on
@@ -1349,14 +1330,8 @@ static int cs_request_handler_start(struct m0_reqh_context *rctx)
 			M0_LOG(M0_ERROR, "m0_mdstore_init");
 			goto cleanup_addb_stob;
 		}
-		rc = cs_storage_prepare(rctx);
-		if (rc != 0) {
-			M0_LOG(M0_ERROR, "cs_storage_prepare");
-			goto cleanup_mdstore;
-		}
 		m0_mdstore_fini(&rctx->rc_mdstore);
 	}
-
 	rc = m0_mdstore_init(&rctx->rc_mdstore, &rctx->rc_cdom_id, &rctx->rc_db,
 			     true);
 	if (rc != 0) {
diff --git a/reqh/ut/reqh_fom_ut.c b/reqh/ut/reqh_fom_ut.c
index 16a5332..68a53b2 100644
--- a/reqh/ut/reqh_fom_ut.c
+++ b/reqh/ut/reqh_fom_ut.c
@@ -223,17 +223,7 @@ static int server_init(const char             *stob_path,
         /* Init mdstore without reading root cob. */
         rc = m0_mdstore_init(&srv_mdstore, &srv_cob_dom_id, &srv_db, 0);
         M0_UT_ASSERT(rc == 0);
-
-	rc = m0_db_tx_init(&tx, &srv_db, 0);
-	M0_UT_ASSERT(rc == 0);
-
-	/* Create root session cob and other structures */
-	rc = m0_cob_domain_mkfs(&srv_mdstore.md_dom, &M0_COB_SLASH_FID,
-				&M0_COB_SESSIONS_FID, &tx);
-	M0_UT_ASSERT(rc == 0);
-
-	/* Comit and finalize old mdstore. */
-	m0_db_tx_commit(&tx);
+        m0_mdstore_fini(&srv_mdstore);
 
         m0_mdstore_fini(&srv_mdstore);
         /* Init new mdstore with open root flag. */
diff --git a/ut/ut_rpc_machine.c b/ut/ut_rpc_machine.c
index 3c2d3b8..7fa182e 100644
--- a/ut/ut_rpc_machine.c
+++ b/ut/ut_rpc_machine.c
@@ -44,8 +44,7 @@ static void buf_dummy(struct m0_net_buffer_pool *bp)
 
 M0_INTERNAL void m0_ut_rpc_mach_init_and_add(struct m0_ut_rpc_mach_ctx *ctx)
 {
-	struct m0_db_tx tx;
-	int             rc;
+	int rc;
 
 	ctx->rmc_xprt = &m0_net_lnet_xprt;
 	rc = m0_net_xprt_init(ctx->rmc_xprt);
@@ -74,15 +73,6 @@ M0_INTERNAL void m0_ut_rpc_mach_init_and_add(struct m0_ut_rpc_mach_ctx *ctx)
 			     &ctx->rmc_dbenv, 0);
 	M0_ASSERT(rc == 0);
 
-	rc = m0_db_tx_init(&tx, &ctx->rmc_dbenv, 0);
-	M0_ASSERT(rc == 0);
-
-	rc = m0_cob_domain_mkfs(&ctx->rmc_mdstore.md_dom, &M0_COB_SLASH_FID,
-				&M0_COB_SESSIONS_FID, &tx);
-	M0_ASSERT(rc == 0);
-
-	m0_db_tx_commit(&tx);
-
 	/*
 	 * Instead of using m0d and dealing with network, database and
 	 * other subsystems, request handler is initialised in a 'special way'.
-- 
1.8.3.2

