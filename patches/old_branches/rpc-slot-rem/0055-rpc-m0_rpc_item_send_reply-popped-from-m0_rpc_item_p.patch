From 5b6be1f91beb2357ebfb1d90540dd728c3f02556 Mon Sep 17 00:00:00 2001
From: Andriy Tkachuk <andriy_tkachuk@xyratex.com>
Date: Tue, 25 Feb 2014 14:46:38 +0200
Subject: [PATCH 55/60] rpc: m0_rpc_item_send_reply() popped from
 m0_rpc_item_process_reply()

---
 rpc/item.c          | 24 ++++++++++++++++++------
 rpc/item_internal.h |  3 +++
 rpc/rpc.c           |  2 +-
 3 files changed, 22 insertions(+), 7 deletions(-)

diff --git a/rpc/item.c b/rpc/item.c
index 5faf21d..983a1df 100644
--- a/rpc/item.c
+++ b/rpc/item.c
@@ -892,7 +892,6 @@ M0_INTERNAL void m0_rpc_item_process_reply(struct m0_rpc_item *req,
 	M0_PRE(req != NULL && reply != NULL);
 	M0_PRE(m0_rpc_item_is_request(req));
 	M0_PRE(M0_IN(req->ri_sm.sm_state, (M0_RPC_ITEM_WAITING_FOR_REPLY,
-					   M0_RPC_ITEM_ACCEPTED,
 					   M0_RPC_ITEM_ENQUEUED,
 					   M0_RPC_ITEM_URGENT)));
 
@@ -903,11 +902,24 @@ M0_INTERNAL void m0_rpc_item_process_reply(struct m0_rpc_item *req,
 
 	m0_rpc_item_change_state(req, M0_RPC_ITEM_REPLIED);
 
-	if (m0_rpc_conn_is_rcv(req->ri_session->s_conn)) {
-		m0_rpc_session_release(req->ri_session);
-		reply->ri_header = req->ri_header;
-		m0_rpc_item_send(reply);
-	}
+	M0_LEAVE();
+}
+
+M0_INTERNAL void m0_rpc_item_send_reply(struct m0_rpc_item *req,
+					struct m0_rpc_item *reply)
+{
+	M0_ENTRY("req: %p", req);
+
+	M0_PRE(req != NULL && reply != NULL);
+	M0_PRE(m0_rpc_item_is_request(req));
+	M0_PRE(M0_IN(req->ri_sm.sm_state, (M0_RPC_ITEM_ACCEPTED)));
+
+	req->ri_reply = reply;
+	m0_rpc_item_change_state(req, M0_RPC_ITEM_REPLIED);
+
+	m0_rpc_session_release(req->ri_session);
+	reply->ri_header = req->ri_header;
+	m0_rpc_item_send(reply);
 
 	M0_LEAVE();
 }
diff --git a/rpc/item_internal.h b/rpc/item_internal.h
index 44bc329..13272ee 100644
--- a/rpc/item_internal.h
+++ b/rpc/item_internal.h
@@ -66,5 +66,8 @@ M0_INTERNAL int m0_rpc_item_received(struct m0_rpc_item *item,
 M0_INTERNAL void m0_rpc_item_process_reply(struct m0_rpc_item *req,
 					   struct m0_rpc_item *reply);
 
+M0_INTERNAL void m0_rpc_item_send_reply(struct m0_rpc_item *req,
+					struct m0_rpc_item *reply);
+
 /** @} */
 #endif /* __MERO_RPC_ITEM_INT_H__ */
diff --git a/rpc/rpc.c b/rpc/rpc.c
index 2e837b8..a217cde 100644
--- a/rpc/rpc.c
+++ b/rpc/rpc.c
@@ -232,7 +232,7 @@ int m0_rpc_reply_post(struct m0_rpc_item *request, struct m0_rpc_item *reply)
 
 	m0_rpc_machine_lock(machine);
 	m0_rpc_item_sm_init(reply, M0_RPC_ITEM_OUTGOING);
-	m0_rpc_item_process_reply(request, reply);
+	m0_rpc_item_send_reply(request, reply);
 	m0_rpc_machine_unlock(machine);
 	M0_RETURN(0);
 }
-- 
1.8.3.2

