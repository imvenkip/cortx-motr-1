From 899b346cebf34fd235c6ec0dd2c58314a748cb0c Mon Sep 17 00:00:00 2001
From: Alexander Gattin <alexander_gattin@xyratex.com>
Date: Fri, 28 Jun 2013 14:12:23 +0300
Subject: [PATCH 215/228] be/tx: add tx hdr and group hdr magics.

---
 be/tx.c       | 1 +
 be/tx.h       | 1 +
 be/tx_group.c | 1 +
 be/tx_group.h | 1 +
 mero/magic.h  | 4 ++++
 5 files changed, 8 insertions(+)

diff --git a/be/tx.c b/be/tx.c
index 7b38c62..8eb00f4 100644
--- a/be/tx.c
+++ b/be/tx.c
@@ -287,6 +287,7 @@ M0_INTERNAL void m0_be_tx_init(struct m0_be_tx *tx, uint64_t tid,
 		    &m0_be_txs_stype);
 	m0_stob_io_init(&tx->t_stobio);
 	tx->t_root                = NULL;
+	tx->t_hdr.th_magic        = M0_TRACE_TX_HDR_MAGIC;
 	tx->t_hdr.th_id           = tid;
 	tx->t_be                  = be;
 	tx->t_persistent          = persistent;
diff --git a/be/tx.h b/be/tx.h
index c5504a0..ed2ac5d 100644
--- a/be/tx.h
+++ b/be/tx.h
@@ -264,6 +264,7 @@ M0_INTERNAL void m0_be_tx_engine_fini(struct m0_be_tx_engine *engine);
 
 /** On-disk transaction header.*/
 struct m0_be_tx_hdr {
+	uint64_t               th_magic;
 	uint64_t               th_id;  /* Transaction id. */
 	uint64_t               th_lsn; /* Transaction offset. */
 	/**
diff --git a/be/tx_group.c b/be/tx_group.c
index 362239b..5b9aa29 100644
--- a/be/tx_group.c
+++ b/be/tx_group.c
@@ -50,6 +50,7 @@ M0_INTERNAL void tx_group_init(struct m0_be_tx_group *gr,
 			       struct m0_be_tx_engine *eng)
 {
 	m0_mutex_init(&gr->tg_lock);
+	tx->tg_hdr.gh_magic   = M0_TRACE_TG_HDR_MAGIC;
 	gr->tg_hdr.gh_tx_nr   = 0;
 	gr->tg_hdr.gh_tx_size = 0;
 	gr->tg_eng            = eng;
diff --git a/be/tx_group.h b/be/tx_group.h
index 0e023cd..3c48a2e 100644
--- a/be/tx_group.h
+++ b/be/tx_group.h
@@ -51,6 +51,7 @@ enum m0_be_tg_state {
 
 /** On-disk group header. */
 struct m0_be_tg_hdr {
+	uint64_t                gh_magic;
 	m0_bindex_t             gh_lsn;
 	uint64_t                gh_id;    /* id of 1st transaction in group. */
 	m0_bcount_t             gh_tx_nr; /* Number of transactions in group. */
diff --git a/mero/magic.h b/mero/magic.h
index f08203a..7b251d1 100644
--- a/mero/magic.h
+++ b/mero/magic.h
@@ -732,6 +732,10 @@ enum m0_magic_satchel {
 	M0_TRACE_TG_MAGIC            = 0x3357a35412e77777,
 	/* m0_be_tx_engine::te_groups head magic (double bass) */
 	M0_TRACE_TG_HEAD_MAGIC       = 0x33d08b1eba557777,
+	/* m0_be_tx_hdr magic (19-2000) */
+	M0_TRACE_TX_HDR_MAGIC        = 0x3319200077777777,
+	/* m0_be_tg_hdr magic (Clint Eastwood) */
+	M0_TRACE_TG_HDR_MAGIC        = 0x33c1127ea57300d7,
 };
 
 #endif /* __MERO_MERO_MAGIC_H__ */
-- 
1.8.3.2

