From a13f3bb94a79c6932a21d4cc726040bdfdd3669e Mon Sep 17 00:00:00 2001
From: Andriy Tkachuk <andriy_tkachuk@xyratex.com>
Date: Mon, 17 Jun 2013 14:13:14 +0300
Subject: [PATCH 157/228] be: extmap compilation fixed & restored

---
 be/Makefile.sub    | 31 +++++++++++++++----------------
 be/extmap.c        |  7 +++----
 be/ut/Makefile.sub |  7 +++----
 3 files changed, 21 insertions(+), 24 deletions(-)

diff --git a/be/Makefile.sub b/be/Makefile.sub
index 9d8b782..87638be 100644
--- a/be/Makefile.sub
+++ b/be/Makefile.sub
@@ -1,18 +1,17 @@
-# XXX TODO FIXME extmap compiling disabled by max because of compilation errors
-nobase_mero_include_HEADERS += be/alloc.h	\
-			       be/list.h	\
-			       be/seg.h 	\
-			       be/tx_service.h  \
-			       be/tx_fom.h
-# be/extmap.h \
-# be/extmap_internal.h
+nobase_mero_include_HEADERS += be/alloc.h		\
+                               be/list.h		\
+                               be/seg.h			\
+                               be/tx_service.h		\
+                               be/tx_fom.h		\
+                               be/extmap.h		\
+                               be/extmap_internal.h
 
-mero_libmero_la_SOURCES += be/alloc.c   	\
-                           be/list.c    	\
-                           be/seg.c     	\
-                           be/be.c      	\
-                           be/btree.c   	\
-                           be/tx.c      	\
+mero_libmero_la_SOURCES += be/alloc.c		\
+                           be/list.c		\
+                           be/seg.c		\
+                           be/be.c		\
+                           be/btree.c		\
+                           be/tx.c		\
                            be/tx_service.c	\
-			   be/tx_fom.c		\
-                           #be/extmap.c
+                           be/tx_fom.c		\
+                           be/extmap.c
diff --git a/be/extmap.c b/be/extmap.c
index 7b17f34..235d03f 100644
--- a/be/extmap.c
+++ b/be/extmap.c
@@ -25,7 +25,6 @@
 #include "lib/errno.h"
 #include "lib/arith.h"   /* M0_3WAY */
 #include "be/extmap.h"
-#include "be/extmap_xc.h"
 
 /**
    @addtogroup extmap
@@ -89,19 +88,19 @@ static int be_emap_cmp(const void *key0, const void *key1)
 		M0_3WAY(a0->ek_offset, a1->ek_offset);
 }
 
-static unsigned be_emap_ksize(const void* k)
+static m0_bcount_t be_emap_ksize(const void* k)
 {
 	return sizeof(struct m0_be_emap_key);
 }
 
-static unsigned be_emap_dsize(const void* d)
+static m0_bcount_t be_emap_vsize(const void* d)
 {
 	return sizeof(struct m0_be_emap_rec);
 }
 
 static const struct m0_be_btree_kv_ops be_emap_ops = {
         .ko_ksize =   be_emap_ksize,
-        .ko_dsize =   be_emap_dsize,
+        .ko_vsize =   be_emap_vsize,
         .ko_compare = be_emap_cmp
 };
 
diff --git a/be/ut/Makefile.sub b/be/ut/Makefile.sub
index 1f9eff3..20c6664 100644
--- a/be/ut/Makefile.sub
+++ b/be/ut/Makefile.sub
@@ -1,9 +1,8 @@
-# XXX TODO FIXME extmap compiling disabled by max because of compilation errors
 ut_libmero_ut_la_SOURCES += be/ut/alloc.c  \
                             be/ut/helper.c \
                             be/ut/list.c   \
                             be/ut/main.c   \
                             be/ut/seg.c    \
-			    be/ut/btree.c  \
-			    be/ut/tx.c
-# be/ut/extmap.c
+                            be/ut/btree.c  \
+                            be/ut/tx.c     \
+                            be/ut/extmap.c
-- 
1.8.3.2

