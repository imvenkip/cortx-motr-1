From 53cb0475c225776c96a3c363e7ec7a43b2bd005f Mon Sep 17 00:00:00 2001
From: Anatoliy Bilenko <anatoliy_bilenko@xyratex.com>
Date: Mon, 28 Oct 2013 10:48:04 +0200
Subject: [PATCH 2/2] perf: add --collect-perf option to enable perf samples
 gathering.

---
 m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh | 48 +++++++++++++++++++----------
 m0t1fs/linux_kernel/st/m0t1fs_test.sh       |  3 +-
 2 files changed, 33 insertions(+), 18 deletions(-)

diff --git a/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh b/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
index adc4fb5..095a6d9 100644
--- a/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
+++ b/m0t1fs/linux_kernel/st/m0t1fs_client_inc.sh
@@ -97,11 +97,12 @@ perf_sample_collect()
 	$stride_size=$1
 	$io_counts=$2
 	$io_size=$3
+	$ttype=$4
 
 	pids=$(__pids_pidof $prog_exec)
 	for pid in $pids; do
 		echo Collecting samples into perf_${pid}_${cmd}_${now}.dat
-		perf record -g -p $pid -o perf_${pid}_${stride_size}x${io_counts}x${io_size}.dat 2>&1 &
+		perf record -g -p $pid -o perf_${ttype}_${pid}_${stride_size}x${io_counts}x${io_size}.dat 2>&1 &
 	done
 
 	return 0
@@ -121,6 +122,9 @@ bulkio_test()
 	m0t1fs_file=$m0t1fs_mount_dir/file.data
 	stride_size=$1
 	io_counts=$2
+	test_type=$3
+	collect_perf=$4
+
 
 	mount_m0t1fs $m0t1fs_mount_dir $stride_size $NR_DATA $NR_PARITY $POOL_WIDTH || return 1
 
@@ -134,7 +138,10 @@ bulkio_test()
 		return 1
 	fi
 
-	perf_sample_collect $stride_size $io_counts $io_size
+	if [ "$collect_perf" = "--collect-perf" ]
+	then
+		perf_sample_collect $stride_size $io_counts $io_size $test_type
+	fi
 
 	echo "Writing data to m0t1fs file ..."
 	cmd="dd if=$local_input of=$m0t1fs_file bs=$io_size count=$io_counts"
@@ -182,7 +189,10 @@ bulkio_test()
 
 	unmount_and_clean &>> $MERO_TEST_LOGFILE
 
-	perf_sample_collected
+	if [ "$collect_perf" = "--collect-perf" ]
+	then
+		perf_sample_collected
+	fi
 
 	return 0
 }
@@ -202,6 +212,7 @@ io_combinations()
 	pool_width=$1
 	data_units=$2
 	parity_units=$3
+	collect_perf=$4
 
 	p=`expr $data_units + 2 '*' $parity_units`
 	if [ $p -gt $pool_width ]
@@ -225,7 +236,7 @@ io_combinations()
 		io_size=${io_size}K
 		echo -n "Test: I/O for stripe = ${stripe_size}K," \
 		     "bs = $io_size, count = 1... "
-		bulkio_test $stride_size 1 &>> $MERO_TEST_LOGFILE
+		bulkio_test $stride_size 1 "ioc" $collect_perf &>> $MERO_TEST_LOGFILE
 		if [ $? -ne "0" ]
 		then
 			return 1
@@ -235,7 +246,7 @@ io_combinations()
 		# Multiple I/Os
 		echo -n "Test: I/O for stripe = ${stripe_size}K," \
 		     "bs = $io_size, count = 2... "
-		bulkio_test $stride_size 2 &>> $MERO_TEST_LOGFILE
+		bulkio_test $stride_size 2  "ioc" $collect_perf &>> $MERO_TEST_LOGFILE
 		if [ $? -ne "0" ]
 		then
 			return 1
@@ -252,7 +263,7 @@ io_combinations()
 		io_size=${io_size}K
 		echo -n "Test: I/O for stripe = ${stripe_size}K," \
 		     "bs = $io_size, count = 1... "
-		bulkio_test $stride_size 1 &>> $MERO_TEST_LOGFILE
+		bulkio_test $stride_size 1  "ioc" $collect_perf &>> $MERO_TEST_LOGFILE
 		if [ $? -ne "0" ]
 		then
 			return 1
@@ -262,7 +273,7 @@ io_combinations()
 		# Multiple I/Os
 		echo -n "Test: I/O for stripe = ${stripe_size}K," \
 		     "bs = $io_size, count = 2... "
-		bulkio_test $stride_size 2 &>> $MERO_TEST_LOGFILE
+		bulkio_test $stride_size 2  "ioc" $collect_perf &>> $MERO_TEST_LOGFILE
 		if [ $? -ne "0" ]
 		then
 			return 1
@@ -388,6 +399,7 @@ file_creation_test()
 
 rmw_test()
 {
+	collect_perf=$1
 	max_stride_size=32
 	max_count=2
 
@@ -398,7 +410,7 @@ rmw_test()
 			io_size=${io}K
 			echo -n "IORMW Test: I/O for stride ="\
 			     "${stride_size}K, bs = $io_size, count = 1... "
-			bulkio_test $stride_size 1 &>> $MERO_TEST_LOGFILE ||
+			bulkio_test $stride_size 1 "rmw" $collect_perf &>> $MERO_TEST_LOGFILE ||
 				return 1
 			show_write_speed
 
@@ -407,7 +419,7 @@ rmw_test()
 			# Multiple I/O
 			    echo -n "IORMW Test: I/O for stride ="\
 			       "${stride_size}K, bs = $io_size, count = $j... "
-			    bulkio_test $stride_size $j &>> \
+			    bulkio_test $stride_size $j "rmw" $collect_perf &>> \
 			          $MERO_TEST_LOGFILE || return 1
 			    show_write_speed
 			done
@@ -422,7 +434,7 @@ rmw_test()
 			io_size=$i
 			echo -n "IORMW Small IO Test: I/O for stride ="\
 			     "${stride_size}K, bs = $io_size, count = 1... "
-			bulkio_test $stride_size 1 &>> $MERO_TEST_LOGFILE ||
+			bulkio_test $stride_size 1 "rmw" $collect_perf &>> $MERO_TEST_LOGFILE ||
 				return 1
 			show_write_speed
 
@@ -432,7 +444,7 @@ rmw_test()
 				echo -n "IORMW Small IO Test: I/O for stride"\
 				        "= ${stride_size}K, bs = $io_size,"\
 				        "count = $j... "
-				bulkio_test $stride_size $j &>> \
+				bulkio_test $stride_size $j "rmw" $collect_perf &>> \
 					$MERO_TEST_LOGFILE || return 1
 				show_write_speed
 			done
@@ -447,7 +459,7 @@ rmw_test()
 			io_size=${io}M
 			echo -n "IORMW Large IO Test: I/O for stride ="\
 			     "${stride_size}K, bs = $io_size, count = 1... "
-			bulkio_test $stride_size 1 &>> $MERO_TEST_LOGFILE ||
+			bulkio_test $stride_size 1 "rmw" $collect_perf &>> $MERO_TEST_LOGFILE ||
 				return 1
 			show_write_speed
 			for((j=2; j<=$max_count; j*=2))
@@ -456,7 +468,7 @@ rmw_test()
 				echo -n "IORMW Large IO Test: I/O for stride"\
 				        "= ${stride_size}K, bs = $io_size,"\
 				        "count = $j... "
-				bulkio_test $stride_size $j &>> \
+				bulkio_test $stride_size "rmw" $collect_perf $j &>> \
 					$MERO_TEST_LOGFILE || return 1
 				show_write_speed
 			done
@@ -471,7 +483,7 @@ rmw_test()
 			io_size=1M
 			echo -n "IORMW Large Count Test: I/O for stride ="\
 			     "${stride_size}K, bs = $io_size, count = $i... "
-			bulkio_test $stride_size $i &>> \
+			bulkio_test $stride_size $i "rmw" $collect_perf &>> \
 				$MERO_TEST_LOGFILE || return 1
 			show_write_speed
 		done
@@ -484,7 +496,7 @@ rmw_test()
 				io_size=$i
 				echo -n "IORMW Large Block Test: I/O for stride ="\
 				"${stride_size}K, bs = $io_size, count = 1... "
-				bulkio_test $stride_size 1 &>> \
+				bulkio_test $stride_size 1 "rmw" $collect_perf &>> \
 				$MERO_TEST_LOGFILE || return 1
 				show_write_speed
 			done
@@ -500,17 +512,19 @@ rmw_test()
 
 m0t1fs_system_tests()
 {
+	collect_perf=$1
+
 	file_creation_test $MAX_NR_FILES || {
                 echo "Failed: File creation test failed."
 		return 1
 	}
 
-	io_combinations $POOL_WIDTH $NR_DATA $NR_PARITY || {
+	io_combinations $POOL_WIDTH $NR_DATA $NR_PARITY $collect_perf || {
 		echo "Failed: IO failed.."
 		return 1
 	}
 
-	rmw_test || {
+	rmw_test $collect_perf || {
 		echo "Failed: IO-RMW failed.."
 		return 1
 	}
diff --git a/m0t1fs/linux_kernel/st/m0t1fs_test.sh b/m0t1fs/linux_kernel/st/m0t1fs_test.sh
index fbcb6f2..e212148 100755
--- a/m0t1fs/linux_kernel/st/m0t1fs_test.sh
+++ b/m0t1fs/linux_kernel/st/m0t1fs_test.sh
@@ -21,7 +21,8 @@ main()
 		return 1
 	fi
 
-	m0t1fs_system_tests
+	m0t1fs_system_tests --collect-perf
+	#m0t1fs_system_tests
 	rc=$?
 
 	# mero_service stop --collect-addb
-- 
1.8.3.2

