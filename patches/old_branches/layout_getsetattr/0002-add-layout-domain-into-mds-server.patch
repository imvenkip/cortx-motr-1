From 6f7d6bb0c1b6cea048b72d3c47a50770e26cacc3 Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Mon, 28 Jan 2013 21:22:37 +0800
Subject: [PATCH 02/11] add layout domain into mds server.

---
 mdservice/md_foms.c    |  2 +-
 mdservice/md_fops.h    |  9 ++++++++-
 mdservice/md_service.c | 23 ++++++++++++++++++++---
 mdservice/md_service.h |  3 +++
 4 files changed, 32 insertions(+), 5 deletions(-)

diff --git a/mdservice/md_foms.c b/mdservice/md_foms.c
index 0597a02..2f3c702 100644
--- a/mdservice/md_foms.c
+++ b/mdservice/md_foms.c
@@ -1032,7 +1032,7 @@ static int m0_md_tick_layout(struct m0_fom *fom)
                 goto out;
 
         m0_fom_block_enter(fom);
-       // rc = layout_decode(...);
+        // rc = layout_decode(...);
         m0_fom_block_leave(fom);
         if (rc == 0)
                 ;//md_statfs_mem2wire(rep, &statfs);
diff --git a/mdservice/md_fops.h b/mdservice/md_fops.h
index f1f98f1..954cd62 100644
--- a/mdservice/md_fops.h
+++ b/mdservice/md_fops.h
@@ -208,8 +208,15 @@ struct m0_fop_statfs_rep {
         struct m0_fid f_root;
 } M0_XCA_RECORD;
 
+enum m0_layout_opcode {
+        M0_LAYOUT_OP_NOOP   = 0,
+        M0_LAYOUT_OP_CREATE = 1,
+        M0_LAYOUT_OP_DELETE = 2,
+        M0_LAYOUT_OP_LOOKUP = 3
+};
+
 struct m0_fop_layout {
-        uint32_t          l_op;
+        uint32_t          l_op; /*< m0_layout_opcode */
         uint64_t          l_lid;
         struct m0_fop_buf l_buf;
 } M0_XCA_RECORD;
diff --git a/mdservice/md_service.c b/mdservice/md_service.c
index de13351..cf446a6 100644
--- a/mdservice/md_service.c
+++ b/mdservice/md_service.c
@@ -30,6 +30,7 @@
 #include "mero/magic.h"
 #include "reqh/reqh_service.h"
 #include "reqh/reqh.h"
+#include "layout/layout.h"
 #include "mdservice/md_fops.h"
 #include "mdservice/md_service.h"
 
@@ -101,7 +102,6 @@ static int mds_allocate(struct m0_reqh_service **service,
 
         *service = &mds->rmds_gen;
         (*service)->rs_ops = &mds_ops;
-
         return 0;
 }
 
@@ -131,9 +131,21 @@ static void mds_fini(struct m0_reqh_service *service)
  */
 static int mds_start(struct m0_reqh_service *service)
 {
-        int rc = 0;
+        struct m0_reqh_md_service *serv_obj;
+        int rc;
         M0_PRE(service != NULL);
-        return rc;
+
+        serv_obj = container_of(service, struct m0_reqh_md_service, rmds_gen);
+        rc = m0_layout_domain_init(&serv_obj->rmds_layout_dom,
+				   service->rs_reqh->rh_dbenv);
+        if (rc == 0) {
+                rc = m0_layout_standard_types_register(
+					&serv_obj->rmds_layout_dom);
+		if (rc != 0)
+			m0_layout_domain_fini(&serv_obj->rmds_layout_dom);
+	}
+
+       return rc;
 }
 
 /**
@@ -144,7 +156,12 @@ static int mds_start(struct m0_reqh_service *service)
  */
 static void mds_stop(struct m0_reqh_service *service)
 {
+        struct m0_reqh_md_service *serv_obj;
         M0_PRE(service != NULL);
+
+        serv_obj = container_of(service, struct m0_reqh_md_service, rmds_gen);
+        m0_layout_standard_types_unregister(&serv_obj->rmds_layout_dom);
+        m0_layout_domain_fini(&serv_obj->rmds_layout_dom);
 }
 
 /** @} endgroup mdservice */
diff --git a/mdservice/md_service.h b/mdservice/md_service.h
index 2e43352..d45318c 100644
--- a/mdservice/md_service.h
+++ b/mdservice/md_service.h
@@ -47,6 +47,9 @@ struct m0_reqh_md_service {
         struct m0_reqh_service       rmds_gen;
         /** Magic to check io service object */
         uint64_t                     rmds_magic;
+
+        /** layout domain for this mdservice */
+        struct m0_layout_domain      rmds_layout_dom;
 };
 
 M0_INTERNAL void m0_mds_unregister(void);
-- 
1.8.3.2

