From 392c28f5719ecc0cea38267637ed70f7b301d791 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Thu, 31 Mar 2011 12:01:32 -0600
Subject: [PATCH 037/158] - make addb things in cob and mdstore simpler

---
 addb/addb.h       | 17 -----------------
 cob/cob.c         | 36 ++++++++++++------------------------
 mdstore/mdstore.c | 46 ++++++++++++++++++----------------------------
 3 files changed, 30 insertions(+), 69 deletions(-)

diff --git a/addb/addb.h b/addb/addb.h
index b8599b8..ebe61ad 100644
--- a/addb/addb.h
+++ b/addb/addb.h
@@ -195,23 +195,6 @@ enum c2_addb_event_id {
 	C2_ADDB_EVENT_EXIST                 = 0x21ULL,
 	C2_ADDB_EVENT_NOENT                 = 0x22ULL,
 	C2_ADDB_EVENT_NOMEM                 = 0x23ULL,
-
-	C2_ADDB_EVENT_COB_CREATE            = 0x24ULL,
-	C2_ADDB_EVENT_COB_DELETE            = 0x25ULL,
-	C2_ADDB_EVENT_COB_UPDATE            = 0x26ULL,
-	C2_ADDB_EVENT_COB_ADD_NAME          = 0x27ULL,
-	C2_ADDB_EVENT_COB_DEL_NAME          = 0x28ULL,
-	C2_ADDB_EVENT_COB_UPDATE_NAME       = 0x29ULL,
-
-	C2_ADDB_EVENT_MDSTORE_CREATE        = 0x30ULL,
-	C2_ADDB_EVENT_MDSTORE_OPEN          = 0x31ULL,
-	C2_ADDB_EVENT_MDSTORE_CLOSE         = 0x32ULL,
-	C2_ADDB_EVENT_MDSTORE_LINK          = 0x33ULL,
-	C2_ADDB_EVENT_MDSTORE_UNLINK        = 0x34ULL,
-	C2_ADDB_EVENT_MDSTORE_SETATTR       = 0x35ULL,
-	C2_ADDB_EVENT_MDSTORE_GETATTR       = 0x36ULL,
-	C2_ADDB_EVENT_MDSTORE_READDIR       = 0x37ULL,
-	C2_ADDB_EVENT_MDSTORE_RENAME        = 0x38ULL
 };
 
 /**
diff --git a/cob/cob.c b/cob/cob.c
index 3300162..78e8322 100644
--- a/cob/cob.c
+++ b/cob/cob.c
@@ -36,20 +36,6 @@ C2_ADDB_EV_DEFINE(cob_enoent,      "cob_noent",
 C2_ADDB_EV_DEFINE(cob_enomem,      "cob_nomem",
                   C2_ADDB_EVENT_NOMEM, C2_ADDB_INVAL);
 
-C2_ADDB_EV_DEFINE(cob_add_name,    "cob_add_name",
-                  C2_ADDB_EVENT_COB_ADD_NAME, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(cob_del_name,    "cob_del_name",
-                  C2_ADDB_EVENT_COB_DEL_NAME, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(cob_update_name, "cob_update_name", 
-                  C2_ADDB_EVENT_COB_UPDATE_NAME, C2_ADDB_FLAG);
-
-C2_ADDB_EV_DEFINE(cob_create,      "cob_create",
-                  C2_ADDB_EVENT_COB_CREATE, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(cob_delete,      "cob_delete",
-                  C2_ADDB_EVENT_COB_DELETE, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(cob_update,      "cob_update",
-                  C2_ADDB_EVENT_COB_UPDATE, C2_ADDB_FLAG);
-
 int c2_cob_nskey_cmp(const struct c2_cob_nskey *k0, 
                      const struct c2_cob_nskey *k1)
 {
@@ -609,7 +595,8 @@ int c2_cob_create(struct c2_cob        *cob,
         c2_db_pair_release(&pair);
 	c2_db_pair_fini(&pair);
 out:
-        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, cob_create, rc == 0);
+        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
+                    c2_addb_func_fail, "cob_create", rc);
         return rc;
 }
 
@@ -660,7 +647,8 @@ int c2_cob_delete(struct c2_cob *cob, struct c2_db_tx *tx)
         c2_db_pair_release(&pair);
 	c2_db_pair_fini(&pair);
 out:
-        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, cob_delete, rc == 0);
+        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
+                    c2_addb_func_fail, "cob_delete", rc);
         return rc;
 }
 
@@ -725,7 +713,8 @@ int c2_cob_update(struct c2_cob         *cob,
                 c2_db_pair_fini(&pair);
         }
 out:
-        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, cob_update, rc == 0);
+        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
+                    c2_addb_func_fail, "cob_update", rc);
         return rc;
 }
 /**
@@ -803,7 +792,8 @@ int c2_cob_add_name(struct c2_cob        *cob,
 	return 0;
 
 out_free:
-        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, cob_add_name, rc == 0);
+        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
+                    c2_addb_func_fail, "cob_add_name", rc);
         return rc;
 }
 
@@ -850,11 +840,8 @@ int c2_cob_del_name(struct c2_cob        *cob,
         c2_db_pair_fini(&pair);
 
 out:
-        /*
-         * If the op failed, assume we're not going to do anything else about
-         * it, so log and drop in all cases. 
-         */
-        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, cob_del_name, rc == 0);
+        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
+                    c2_addb_func_fail, "cob_del_name", rc);
         return rc;
 }
 
@@ -929,7 +916,8 @@ int c2_cob_update_name(struct c2_cob        *cob,
         c2_db_pair_release(&pair);
         c2_db_pair_fini(&pair);
 out:
-        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, cob_update_name, rc == 0);
+        C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
+                    c2_addb_func_fail, "cob_update_name", rc);
         return rc;
 }
 
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 304736d..ffee909 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -29,25 +29,6 @@ static const struct c2_addb_loc mdstore_addb_loc = {
 	.al_name = "mdstore"
 };
 
-C2_ADDB_EV_DEFINE(md_link,    "md_link",
-                  C2_ADDB_EVENT_MDSTORE_LINK, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_unlink,  "md_unlink",
-                  C2_ADDB_EVENT_MDSTORE_UNLINK, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_rename,  "md_rename", 
-                  C2_ADDB_EVENT_MDSTORE_RENAME, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_create,  "md_create",
-                  C2_ADDB_EVENT_MDSTORE_CREATE, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_setattr, "md_setattr",
-                  C2_ADDB_EVENT_MDSTORE_SETATTR, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_getattr, "md_getattr",
-                  C2_ADDB_EVENT_MDSTORE_GETATTR, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_open, "md_open",
-                  C2_ADDB_EVENT_MDSTORE_OPEN, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_close, "md_close",
-                  C2_ADDB_EVENT_MDSTORE_CLOSE, C2_ADDB_FLAG);
-C2_ADDB_EV_DEFINE(md_readdir, "md_readdir",
-                  C2_ADDB_EVENT_MDSTORE_READDIR, C2_ADDB_FLAG);
-
 static const struct c2_fid C2_MD_ROOTID = {
         .f_container = 1024ULL, 
         .f_key       = 1ULL
@@ -143,7 +124,8 @@ int c2_md_store_create(struct c2_md_store *md,
         rc = c2_cob_create(cob, nskey, &nsrec, &fabrec, &omgrec, 0,
                            &ctx->fc_tx->tx_dbtx);
         c2_free(nskey);
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_create, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_create", rc);
         return rc;
 }
 
@@ -174,7 +156,8 @@ int c2_md_store_link(struct c2_md_store *md,
                            &ctx->fc_tx->tx_dbtx);
 out:
         c2_free(nskey);
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_link, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_link", rc);
         return rc;
 }
 
@@ -247,7 +230,8 @@ out:
         if (ncob)
                 c2_cob_put(ncob);
         c2_free(nskey);
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_unlink, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_unlink", rc);
         return rc;
 }
 
@@ -265,7 +249,8 @@ int c2_md_store_open(struct c2_md_store *md,
          * @todo: Place cob to open files table. 
          */
 
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_open, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_open", rc);
         return rc;
 }
 
@@ -285,7 +270,8 @@ int c2_md_store_close(struct c2_md_store *md,
          *   - quota handling?
          */
         
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_close, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_close", rc);
         return rc;
 }
 
@@ -373,7 +359,8 @@ int c2_md_store_rename(struct c2_md_store *md,
         c2_free(srckey);
         c2_free(tgtkey);
 out:
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_rename, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_rename", rc);
         return rc;
 }
 
@@ -414,7 +401,8 @@ int c2_md_store_setattr(struct c2_md_store *md,
         rc = c2_cob_update(cob, &nsrec, &fabrec, &omgrec, 
                            &ctx->fc_tx->tx_dbtx);
         
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_setattr, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_setattr", rc);
         return rc;
 }
 
@@ -433,7 +421,8 @@ int c2_md_store_getattr(struct c2_md_store *md,
          * to response.
          */
         
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_getattr, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_getattr", rc);
         return rc;
 }
 
@@ -452,7 +441,8 @@ int c2_md_store_readdir(struct c2_md_store *md,
          * to response @rep.
          */
         
-        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, md_readdir, rc == 0);
+        C2_ADDB_ADD(&md->md_addb, &mdstore_addb_loc, 
+                    c2_addb_func_fail, "md_readdir", rc);
         return rc;
 }
 
-- 
1.8.3.2

