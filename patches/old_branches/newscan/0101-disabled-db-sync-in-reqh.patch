From b5dceb83922f028078eafcfc05ccfc241e0e34e8 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Mon, 30 May 2011 14:46:26 -0600
Subject: [PATCH 101/158] - disabled db sync in reqh; - fixed rename about
 freeing old key.

---
 cob/cob.c   | 7 ++++++-
 reqh/reqh.c | 2 +-
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/cob/cob.c b/cob/cob.c
index 614f27b..b26c0c0 100644
--- a/cob/cob.c
+++ b/cob/cob.c
@@ -1148,10 +1148,15 @@ int c2_cob_update_name(struct c2_cob        *cob,
          * Update key to new one.
          */        
         if (rc == 0) {
-                c2_free(cob->co_nskey);
+                if (cob->co_valid & CA_NSKEY_FREE)
+                        c2_free(cob->co_nskey);
+                else if (cob->co_valid & CA_NSKEY_DB)
+                        c2_db_pair_fini(&cob->co_oipair);
+                cob->co_valid &= ~(CA_NSKEY_FREE | CA_NSKEY_DB);
                 c2_cob_make_nskey(&cob->co_nskey, &tgtkey->cnk_pfid,
                                   c2_bitstring_buf_get(&tgtkey->cnk_name),
                                   c2_bitstring_len_get(&tgtkey->cnk_name));
+                cob->co_valid |= CA_NSKEY_FREE;
         }
 out:
         C2_ADDB_ADD(&cob->co_dom->cd_addb, &cob_addb_loc, 
diff --git a/reqh/reqh.c b/reqh/reqh.c
index 025711c..e0b5a07 100644
--- a/reqh/reqh.c
+++ b/reqh/reqh.c
@@ -102,7 +102,7 @@ out:
                 c2_db_tx_abort(&tx.tx_dbtx);
         } else {
                 c2_db_tx_commit(&tx.tx_dbtx);
-                c2_dbenv_sync(reqh->rh_site->s_mdstore->md_dom.cd_dbenv);
+//                c2_dbenv_sync(reqh->rh_site->s_mdstore->md_dom.cd_dbenv);
         }
         
         return result;
-- 
1.8.3.2

