From 9630be8fa1fbd8788ab716133d38b17582f38f65 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Sat, 11 Jun 2011 07:15:08 -0600
Subject: [PATCH 124/158] - fixed bugs with handling rename corner cases;

---
 cob/cob.c           |  28 +++---
 mdservice/md_foms.c | 280 ++++++++++++++++++++++++++++++++++++++--------------
 mdstore/mdstore.c   |  21 ++--
 mdstore/mdstore.h   |   1 +
 reqh/reqh.c         |   1 +
 5 files changed, 235 insertions(+), 96 deletions(-)

diff --git a/cob/cob.c b/cob/cob.c
index 985e0f4..c9a5c2b 100644
--- a/cob/cob.c
+++ b/cob/cob.c
@@ -1108,7 +1108,6 @@ int c2_cob_update_name(struct c2_cob        *cob,
         struct c2_cob_nsrec  nsrec;
         struct c2_db_pair    pair;
         struct c2_cob_oikey  oikey;
-        int                  zombie;
         int                  rc;
 
         C2_PRE(c2_cob_is_valid(cob));
@@ -1126,7 +1125,6 @@ int c2_cob_update_name(struct c2_cob        *cob,
         if (rc)
                 goto out;
 
-        zombie = nsrec.cnr_zombie;
         nsrec.cnr_zombie = 0;
         
         c2_db_pair_setup(&pair, &cob->co_dom->cd_namespace,
@@ -1138,20 +1136,18 @@ int c2_cob_update_name(struct c2_cob        *cob,
         if (rc)
                 goto out;
         
-        if (!zombie) {
-                /*
-                 * Kill old record. Error will be returned if
-                 * nothing found.
-                 */
-                c2_db_pair_setup(&pair, &cob->co_dom->cd_namespace,
-	                         srckey, c2_cob_nskey_size(srckey),
-		                 NULL, 0);
-                rc = c2_table_delete(tx, &pair);
-                c2_db_pair_release(&pair);
-                c2_db_pair_fini(&pair);
-                if (rc)
-                        goto out;
-        }
+        /*
+         * Kill old record. Error will be returned if
+         * nothing found.
+         */
+        c2_db_pair_setup(&pair, &cob->co_dom->cd_namespace,
+                         srckey, c2_cob_nskey_size(srckey),
+                         NULL, 0);
+        rc = c2_table_delete(tx, &pair);
+        c2_db_pair_release(&pair);
+        c2_db_pair_fini(&pair);
+        if (rc)
+                goto out;
 
         /* Update object index */
         c2_cob_make_oikey(&oikey, cob->co_fid, nsrec.cnr_linkno);
diff --git a/mdservice/md_foms.c b/mdservice/md_foms.c
index 77b3780..a6357db 100644
--- a/mdservice/md_foms.c
+++ b/mdservice/md_foms.c
@@ -138,24 +138,10 @@ static void c2_md_fop_attr2cob(struct c2_fop_cob *body,
         body->b_version = attr->ca_version;
 }
 
-static int c2_md_zombie(struct c2_md_store *md, 
-                        struct c2_cob *cob,
-                        struct c2_db_tx *tx)
-{
-        struct c2_cob_attr attr;
-
-        C2_SET0(&attr);
-        attr.ca_flags = 0;
-        attr.ca_zombie = 1;
-        return c2_md_store_setattr(md, cob, &attr, tx);
-}
-
 static int c2_md_create(struct c2_md_store  *md, 
                         struct c2_fid       *pfid,
                         struct c2_fid       *tfid, 
                         struct c2_cob_attr  *attr, 
-                        int                  dlink,
-                        int                  zlink,
                         struct c2_db_tx     *tx)
 {
         struct c2_cob *scob = NULL;
@@ -180,31 +166,19 @@ static int c2_md_create(struct c2_md_store  *md,
                                 return rc;
 
                         rc = c2_md_store_create(md, pfid, scob, attr, tx);
-                } else if (rc == 0 && dlink) {
+                } else if (rc == 0) {
                         /*
                          * There is statdata name, this must be hardlink
                          * either from scan or changelog.
                          */
                         rc = c2_md_store_link(md, pfid, scob, attr->ca_name,
-                                              attr->ca_namelen, tx);
+                                              attr->ca_namelen, 0, tx);
                         /*
                          * Each operation changes target attributes (times).
                          * We want to keep them up-to-date.
                          */
-                        if (rc == 0) {
-                                if (zlink) {
-                                        rc = c2_md_store_lookup(md, pfid, 
-                                                            attr->ca_name, 
-                                                            attr->ca_namelen,
-                                                            &ncob, tx);
-                                        if (rc == 0) {
-                                                c2_md_zombie(md, ncob, tx);
-                                                c2_cob_put(ncob);
-                                                ncob = NULL;
-                                        }
-                                }
+                        if (rc == 0)
                                 rc = c2_md_store_setattr(md, scob, attr, tx);
-                        }
                 }
         } else if (rc == 0) {
                 /*
@@ -279,7 +253,7 @@ static int c2_md_create_fom_state(struct c2_fom *fom)
         c2_md_make_fid(&tfid, &body->b_tfid);
 
         rc = c2_md_create(site->s_mdstore, &pfid, &tfid,
-                          &attr, 1, 0, &ctx->fc_tx->tx_dbtx);
+                          &attr, &ctx->fc_tx->tx_dbtx);
         if (rc == 0) {
                 svc = fom->fo_fop_ctx->fc_service;
 	        svc->s_ops->so_reply_post(svc, fop_rep, ctx->fc_cookie);
@@ -332,7 +306,7 @@ static int c2_md_link_fom_state(struct c2_fom *fom)
         c2_md_make_fid(&tfid, &body->b_tfid);
 
         rc = c2_md_create(site->s_mdstore, &pfid, &tfid,
-                          &attr, 1, 0, &ctx->fc_tx->tx_dbtx);
+                          &attr, &ctx->fc_tx->tx_dbtx);
         if (rc == 0) {
                 svc = fom->fo_fop_ctx->fc_service;
 	        svc->s_ops->so_reply_post(svc, fop_rep, ctx->fc_cookie);
@@ -398,7 +372,8 @@ static int c2_md_unlink_fom_state(struct c2_fom *fom)
                 if (rc)
                         goto out;
 
-                rc = c2_md_zombie(md, ncob, tx);
+                ncob->co_nsrec.cnr_zombie = 1;
+                rc = c2_cob_update(ncob, &ncob->co_nsrec, NULL, NULL, tx);
                 if (rc) {
                         c2_cob_put(ncob);
                         goto out;
@@ -478,16 +453,169 @@ static int c2_md_rename(struct c2_md_store  *md,
                                 tattr->ca_name, tattr->ca_namelen,
                                 sattr->ca_name, sattr->ca_namelen, tx);
         if (rc)
-                goto out;
+                return rc;
         /*
          * Update attributes of source and target.
          */
         rc = c2_md_store_setattr(md, scob, sattr, tx);
         if (rc == 0 && !c2_fid_eq(scob->co_fid, tcob->co_fid))
                 rc = c2_md_store_setattr(md, tcob, tattr, tx);
-out:
-        if (tcob != NULL)
-                c2_cob_put(tcob);
+        return rc;
+}
+
+static int c2_md_rename_check_src(struct c2_md_store *md, 
+                                  struct c2_fid      *pfid_tgt, 
+                                  struct c2_fid      *pfid_src,
+                                  struct c2_fid      *tfid_tgt, 
+                                  struct c2_fid      *tfid_src,
+                                  struct c2_cob_attr *tattr, 
+                                  struct c2_cob_attr *sattr, 
+                                  struct c2_cob      *tcob,
+                                  int                 scan, 
+                                  struct c2_db_tx    *tx)
+{
+        struct c2_cob *sncob = NULL;
+        struct c2_cob *scob = NULL;
+        int rc;
+        
+        C2_ASSERT(tcob != NULL);
+        
+        if (c2_fid_eq(tfid_tgt, tfid_src)) {
+                /*
+                 * Same object, let's check the name.
+                 */
+                rc = c2_md_store_lookup(md, pfid_src, sattr->ca_name, 
+                                        sattr->ca_namelen, &sncob, tx);
+                if (rc == -ENOENT) {
+                        if (scan) {
+                                /*
+                                 * Just created tgt with correct name. Let's
+                                 * make sure that scan will not re-create src.
+                                 */
+                                rc = c2_md_store_link(md, pfid_src, tcob,
+                                                      sattr->ca_name,
+                                                      sattr->ca_namelen,
+                                                      1, tx);
+                        }
+                } else if (rc == 0) {
+                        /*
+                         * Name exists, let's do normal rename and create old
+                         * name with zombie flag.
+                         */
+                        rc = c2_md_rename(md, pfid_tgt, pfid_src, tfid_tgt,
+                                          tfid_src, tattr, sattr, tcob, tcob,
+                                          tx);
+                        if (rc) {
+                                c2_cob_put(sncob);
+                                return rc;
+                        }
+
+                        if (scan) {
+                                /*
+                                 * Src name is gone now but we want to make
+                                 * sure that scan will not re-create it so
+                                 * let's add some zombie name that will be
+                                 * killed after scan.
+                                 */
+                                rc = c2_md_store_link(md, pfid_src, tcob,
+                                                      sattr->ca_name,
+                                                      sattr->ca_namelen,
+                                                      1, tx);
+                        }
+                        c2_cob_put(sncob);
+                }
+        } else {
+                rc = c2_md_store_lookup(md, pfid_src, sattr->ca_name, 
+                                        sattr->ca_namelen, &sncob, tx);
+                if (rc == -ENOENT) {
+                        rc = c2_md_store_locate(md, tfid_src, &scob, 
+                                                C2_MD_LOCATE_STORED, tx);
+                        if (rc == -ENOENT) {
+                                /*
+                                 * No src object at all, let's create one.
+                                 */
+                                rc = c2_md_store_alloc(md, tfid_src, &scob);
+                                if (rc)
+                                        return rc;
+                                rc = c2_md_store_create(md, pfid_src,
+                                                        scob, sattr, tx);
+                                if (rc) {
+                                        c2_cob_put(scob);
+                                        return rc;
+                                }
+                                                
+                                /*
+                                 * Both object and names exist, let's do
+                                 * normal rename.
+                                 */
+                                rc = c2_md_rename(md, pfid_tgt, pfid_src, 
+                                                  tfid_tgt, tfid_src,
+                                                  tattr, sattr, tcob,
+                                                  scob, tx);
+                                if (rc) {
+                                        c2_cob_put(scob);
+                                        return rc;
+                                }
+                                                
+                                if (scan) {
+                                        /*
+                                         * Src name is gone now but we want to
+                                         * make sure that scan will not re-create
+                                         * it so let's add some zombie name that
+                                         * will be killed after scan.
+                                         */
+                                        rc = c2_md_store_link(md, pfid_src, scob,
+                                                              sattr->ca_name,
+                                                              sattr->ca_namelen,
+                                                              1, tx);
+                                }
+                        } else if (rc == 0) {
+                                /*
+                                 * Source object exists but no name. Let's
+                                 * create one.
+                                 */
+                                rc = c2_md_store_link(md, pfid_src, scob,
+                                                      sattr->ca_name,
+                                                      sattr->ca_namelen,
+                                                      0, tx);
+                                if (rc) {
+                                        c2_cob_put(scob);
+                                        return rc;
+                                }
+
+                                /*
+                                 * Both object and names exist, let's do
+                                 * normal rename.
+                                 */
+                                rc = c2_md_rename(md, pfid_tgt, pfid_src, 
+                                                  tfid_tgt, tfid_src,
+                                                  tattr, sattr, tcob,
+                                                  scob, tx);
+                                if (rc) {
+                                        c2_cob_put(scob);
+                                        return rc;
+                                }
+                                                
+                                if (scan) {
+                                        /*
+                                         * Src name is gone now but we want to
+                                         * make sure that scan will not re-create
+                                         * it so let's add some zombie name that
+                                         * will be killed after scan.
+                                         */
+                                        rc = c2_md_store_link(md, pfid_src, scob,
+                                                              sattr->ca_name,
+                                                              sattr->ca_namelen,
+                                                              1, tx);
+                                }
+                        }
+                }
+        }
+        if (scob) {
+                if (sattr->ca_version > scob->co_nsrec.cnr_version)
+                        rc = c2_md_store_setattr(md, scob, sattr, tx);
+                c2_cob_put(scob);
+        }
         return rc;
 }
 
@@ -501,8 +629,8 @@ static int c2_md_rename_fom_state(struct c2_fom *fom)
         struct c2_fop            *fop;
         struct c2_fop            *fop_rep;
         struct c2_fop_ctx        *ctx;
-        struct c2_cob            *scob = NULL;
         struct c2_cob            *tcob = NULL;
+        struct c2_cob            *tncob = NULL;
         struct c2_fid             tfid_src;
         struct c2_fid             tfid_tgt;
         struct c2_fid             pfid_tgt;
@@ -512,6 +640,7 @@ static int c2_md_rename_fom_state(struct c2_fom *fom)
         struct c2_service        *svc;
         struct c2_db_tx          *tx;
         struct c2_md_store       *md;
+        int                       scan;
         int                       rc;
 
         fom_obj = container_of(fom, struct c2_fom_md, fm_fom);
@@ -548,49 +677,56 @@ static int c2_md_rename_fom_state(struct c2_fom *fom)
         c2_md_fop_cob2attr(&sattr, sbody);
         sattr.ca_name = req->r_sname.s_buf;
         sattr.ca_namelen = req->r_sname.s_len;
+        scan = (sbody->b_bias & C2_MD_BIAS_SCAN_IN_PROGRESS);
 
-        /*
-         * Make sure that source name exists.
-         */        
-        rc = c2_md_create(md, &pfid_src, &tfid_src, &sattr, 1, 1, tx);
-        if (rc)
-                goto out;
-
-        /*
-         * Make sure that tgt name exists.
-         */
-        rc = c2_md_create(md, &pfid_tgt, &tfid_tgt, &tattr, 0, 0, tx);
-        if (rc)
-                goto out;
-
-        /*
-         * Find both, they now should exist.
-         */
-        rc = c2_md_store_locate(md, &tfid_src, &scob, C2_MD_LOCATE_STORED, tx);
-        C2_ASSERT(rc == 0 || rc == -EDEADLK);
-        if (rc)
-                goto out;
-
-        rc = c2_md_store_locate(md, &tfid_tgt, &tcob, C2_MD_LOCATE_STORED, tx);
-        C2_ASSERT(rc == 0 || rc == -EDEADLK);
-        if (rc) {
-                c2_cob_put(scob);
-                goto out;
+        rc = c2_md_store_lookup(md, &pfid_tgt, tattr.ca_name, 
+                                tattr.ca_namelen, &tncob, tx);
+        if (rc == -ENOENT) {
+                rc = c2_md_store_locate(md, &tfid_tgt, &tcob, 
+                                        C2_MD_LOCATE_STORED, tx);
+                if (rc == -ENOENT) {
+                        rc = c2_md_store_alloc(md, &tfid_tgt, &tcob);
+                        if (rc == 0)
+                                rc = c2_md_store_create(md, &pfid_tgt,
+                                                        tcob, &tattr, tx);
+                } else if (rc == 0 && !c2_fid_eq(&tfid_src, &tfid_tgt)) {
+                        rc = c2_md_store_link(md, &pfid_tgt, tcob, 
+                                              tattr.ca_name,
+                                              tattr.ca_namelen, 0, tx);
+                }
+                if (rc == 0)
+                        rc = c2_md_rename_check_src(md, &pfid_tgt, &pfid_src, 
+                                                    &tfid_tgt, &tfid_src,
+                                                    &tattr, &sattr, tcob, 
+                                                    scan, tx);
+        } else if (rc == 0) {
+                rc = c2_md_store_locate(md, &tfid_tgt, &tcob, 
+                                        C2_MD_LOCATE_STORED, tx);
+                if (rc == -ENOENT) {
+                        rc = c2_md_store_alloc(md, &tfid_tgt, &tcob);
+                        if (rc == 0)
+                                rc = c2_md_store_create(md, &pfid_tgt, tcob,
+                                                        &tattr, tx);
+                }
+                if (rc == 0)
+                        rc = c2_md_rename_check_src(md, &pfid_tgt, &pfid_src, 
+                                                    &tfid_tgt, &tfid_src,
+                                                    &tattr, &sattr, tcob,
+                                                    scan, tx);
+                c2_cob_put(tncob);
         }
 
-        /*
-         * Rename and update attributes.
-         */
-        rc = c2_md_rename(md, &pfid_tgt, &pfid_src, &tfid_tgt, &tfid_src,
-                          &tattr, &sattr, tcob, scob, tx);
-        c2_cob_put(tcob);
-        c2_cob_put(scob);
+        if (tcob) {
+                if (rc == 0 && tattr.ca_version > tcob->co_nsrec.cnr_version)
+                        rc = c2_md_store_setattr(md, tcob, &tattr, tx);
+                c2_cob_put(tcob);
+        }
 
         if (rc == 0) {
                 svc = fom->fo_fop_ctx->fc_service;
 	        svc->s_ops->so_reply_post(svc, fop_rep, ctx->fc_cookie);
 	}
-out:
+
 	ctx->fc_retval = rc;
         if (rc)
                 c2_fop_free(fop_rep);
diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 7c3c5e2..da8f116 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -173,6 +173,7 @@ int c2_md_store_link(struct c2_md_store         *md,
                      struct c2_cob              *cob,
                      const char                 *name,
                      int                         namelen,
+                     int                         zombie,
                      struct c2_db_tx            *tx)
 {
         struct c2_cob_nskey   *nskey;
@@ -191,6 +192,8 @@ int c2_md_store_link(struct c2_md_store         *md,
          */
         c2_cob_make_nskey(&nskey, pfid, name, namelen); 
         C2_PRE(c2_fid_is_set(&cob->co_nsrec.cnr_fid));
+
+        nsrec.cnr_zombie = zombie;
         nsrec.cnr_fid = cob->co_nsrec.cnr_fid;
         nsrec.cnr_linkno = cob->co_nsrec.cnr_cntr;
 
@@ -204,7 +207,6 @@ int c2_md_store_link(struct c2_md_store         *md,
          * save it to storage. 
          */
         cob->co_nsrec.cnr_cntr++;
-        cob->co_nsrec.cnr_nlink++;
 
         rc = c2_cob_update(cob, &cob->co_nsrec, NULL, NULL, tx);
         if (rc)
@@ -432,6 +434,7 @@ int c2_md_store_rename(struct c2_md_store       *md,
 {
         struct c2_cob_nskey  *srckey;
         struct c2_cob_nskey  *tgtkey;
+        struct c2_cob        *tncob = NULL;
         time_t                now;
         int                   rc;
 
@@ -440,19 +443,22 @@ int c2_md_store_rename(struct c2_md_store       *md,
 
         time(&now);
 
-#if 0
         /*
          * Let's kill existing target name.
          */
-        if (!c2_fid_eq(cob_tgt->co_fid, cob_src->co_fid) || 
-            (cob_src->co_nsrec.cnr_nlink > 0)) {
+        rc = c2_md_store_lookup(md, pfid_tgt, tname, tnamelen,
+                                &tncob, tx);
+        if (!c2_fid_eq(cob_tgt->co_fid, cob_src->co_fid) ||
+            (tncob && tncob->co_nsrec.cnr_linkno != 0)) {
                 rc = c2_md_store_unlink(md, pfid_tgt, cob_tgt,
                                         tname, tnamelen, tx);
-                if (rc)
+                if (rc) {
+                        c2_cob_put(tncob);
                         goto out;
+                }
         }
-#endif
-
+        if (tncob)
+                c2_cob_put(tncob);
         /*
          * Prepare src and dst keys.
          */                
@@ -584,7 +590,6 @@ int c2_md_store_setattr(struct c2_md_store      *md,
                 if (attr->ca_flags & C2_MD_NLINK)
                         nsrec->cnr_nlink = attr->ca_nlink;
                 nsrec->cnr_version = attr->ca_version;
-                nsrec->cnr_zombie = attr->ca_zombie;
         }
 
         /*
diff --git a/mdstore/mdstore.h b/mdstore/mdstore.h
index fc87af6..c9d2dc0 100644
--- a/mdstore/mdstore.h
+++ b/mdstore/mdstore.h
@@ -224,6 +224,7 @@ int c2_md_store_link(struct c2_md_store         *md,
                      struct c2_cob              *cob, 
                      const char                 *name,
                      int                         namelen,
+                     int                         zombie,
                      struct c2_db_tx            *tx);
                      
 /**
diff --git a/reqh/reqh.c b/reqh/reqh.c
index 539f330..e365969 100644
--- a/reqh/reqh.c
+++ b/reqh/reqh.c
@@ -122,6 +122,7 @@ out:
                         goto restart;
         } else {
                 c2_db_tx_commit(&tx.tx_dbtx);
+                c2_dbenv_sync(reqh->rh_site->s_mdstore->md_dom.cd_dbenv);
         }
         
         return result;
-- 
1.8.3.2

