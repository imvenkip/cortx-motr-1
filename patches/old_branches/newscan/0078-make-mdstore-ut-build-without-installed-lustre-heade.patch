From 554a7c67ea7d5a5d0cf09485b9a1d066bdc2e5a1 Mon Sep 17 00:00:00 2001
From: Yuriy Umanets <yuriy_umanets@xyratex.com>
Date: Wed, 4 May 2011 04:13:21 -0600
Subject: [PATCH 078/158] - make mdstore ut build without installed lustre
 headers.

---
 mdstore/mdstore.c   |  3 ++-
 mdstore/mdstore.h   |  2 ++
 mdstore/ut/lustre.c | 30 ++++++++++++++++++++++++------
 3 files changed, 28 insertions(+), 7 deletions(-)

diff --git a/mdstore/mdstore.c b/mdstore/mdstore.c
index 7aad167..c05d054 100644
--- a/mdstore/mdstore.c
+++ b/mdstore/mdstore.c
@@ -62,7 +62,8 @@ int c2_md_store_init(struct c2_md_store         *md,
         }
         if (init_root) {
                 c2_db_tx_init(&tx, db, 0);
-                rc = c2_md_store_lookup(md, NULL, "ROOT", 4, 
+                rc = c2_md_store_lookup(md, NULL, C2_MD_ROOT_NAME, 
+                                        strlen(C2_MD_ROOT_NAME), 
                                         &md->md_root, &tx);
                 if (rc) {
                         c2_db_tx_abort(&tx);
diff --git a/mdstore/mdstore.h b/mdstore/mdstore.h
index 236a4f6..8f3d6e7 100644
--- a/mdstore/mdstore.h
+++ b/mdstore/mdstore.h
@@ -24,6 +24,8 @@ struct c2_md_store {
         struct c2_addb_ctx    md_addb;
 };
 
+#define C2_MD_ROOT_NAME "ROOT"
+
 /**
    Flags supplied to c2_md_store_locate() to point out where a cob 
    should be found: on store, in opened files table or orhans table.
diff --git a/mdstore/ut/lustre.c b/mdstore/ut/lustre.c
index 5d43897..cc8ce67 100644
--- a/mdstore/ut/lustre.c
+++ b/mdstore/ut/lustre.c
@@ -4,9 +4,7 @@
 #  include <config.h>
 #endif
 
-#include <lustre/lustre_idl.h>
-#include <lustre/liblustreapi.h>
-#include <lustre/lu_object.h>
+#include <errno.h>
 
 #include "lib/memory.h"
 #include "lib/cdefs.h"
@@ -41,8 +39,25 @@ static int lustre_copy_name(struct c2_fop_name *n,
         return 0;
 }
 
+enum lustre_la_valid {
+        C2_LA_ATIME   = 1 << 0,
+        C2_LA_MTIME   = 1 << 1,
+        C2_LA_CTIME   = 1 << 2,
+        C2_LA_SIZE    = 1 << 3,
+        C2_LA_MODE    = 1 << 4,
+        C2_LA_UID     = 1 << 5,
+        C2_LA_GID     = 1 << 6,
+        C2_LA_BLOCKS  = 1 << 7,
+        C2_LA_TYPE    = 1 << 8,
+        C2_LA_FLAGS   = 1 << 9,
+        C2_LA_NLINK   = 1 << 10,
+        C2_LA_RDEV    = 1 << 11,
+        C2_LA_BLKSIZE = 1 << 12
+};
+
 static int lustre_get_flags(uint32_t flags)
 {
+#if 0
         uint32_t result = 0;
         
         if (flags & LA_ATIME)
@@ -71,7 +86,10 @@ static int lustre_get_flags(uint32_t flags)
                 result |= C2_MD_RDEV;
         if (flags & LA_BLKSIZE)
                 result |= C2_MD_BLKSIZE;
+
         return result;
+#endif
+        return flags;
 }
 
 static void lustre_copy_body(struct c2_fop_cob *body, 
@@ -83,11 +101,11 @@ static void lustre_copy_body(struct c2_fop_cob *body,
         body->b_gid = rec->cr_gid;
         body->b_sid = rec->cr_sid;
         body->b_nid = rec->cr_clnid;
-        if (rec->cr_flags & LA_ATIME)
+        if (rec->cr_flags & C2_MD_ATIME)
                 body->b_atime = rec->cr_atime;
-        if (rec->cr_flags & LA_MTIME)
+        if (rec->cr_flags & C2_MD_MTIME)
                 body->b_mtime = rec->cr_mtime;
-        if (rec->cr_flags & LA_CTIME)
+        if (rec->cr_flags & C2_MD_CTIME)
                 body->b_ctime = rec->cr_ctime;
         body->b_flags = lustre_get_flags(rec->cr_flags);
         lustre_copy_fid(&body->b_tfid, &rec->cr_tfid);
-- 
1.8.3.2

