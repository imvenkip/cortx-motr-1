From d536b72622d9445b6fa9630560f059484ecdd2a0 Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Tue, 18 Jun 2013 11:35:13 +0800
Subject: [PATCH 11/12] Revert "temporarily return success when double free is
 detected."

This reverts commit b59f44361e659de48b97a9c9aa5bb1133d4fbe63.
---
 balloc/balloc.c | 100 +++++++++++++++++++++++++++++++-------------------------
 1 file changed, 56 insertions(+), 44 deletions(-)

diff --git a/balloc/balloc.c b/balloc/balloc.c
index 002612a..f210474 100644
--- a/balloc/balloc.c
+++ b/balloc/balloc.c
@@ -1168,34 +1168,20 @@ static int balloc_update_db(struct m0_balloc *mero,
 
 		if (found && cur && tgt->e_end > cur->e_start) {
 			M0_LOG(M0_ERROR, "!!!!!!!!!!!!!double free: "
-			                 "tgt_start=%llu tgt_end=%llu "
-					 "cur_start=%llu cur_end=%llu\n",
-			       (unsigned long long)tgt->e_start,
+			                 "tgt_end=%llu cur_start=%llu\n",
 			       (unsigned long long)tgt->e_end,
-			       (unsigned long long)cur->e_start,
-			       (unsigned long long)cur->e_end);
+			       (unsigned long long)cur->e_start);
 			m0_balloc_debug_dump_group_extent(
 				    "double free with cur", grp);
-			/* FIXME this is a known bug.
-			 * When fixed, error should be returned.
-			 */
-			return 0;
 			return -EINVAL;
 		}
 		if (pre && pre->e_end > tgt->e_start) {
 			M0_LOG(M0_ERROR, "!!!!!!!!!!!!!double free: "
-			                 "pre_start=%llu pre_end=%llu "
-					 "tgt_start=%llu tgt_end=%llu\n",
-			       (unsigned long long)pre->e_start,
+			                 "pre_end=%llu tgt_start=%llu\n",
 			       (unsigned long long)pre->e_end,
-			       (unsigned long long)tgt->e_start,
-			       (unsigned long long)tgt->e_end);
+			       (unsigned long long)tgt->e_start);
 			m0_balloc_debug_dump_group_extent(
 				    "double free with pre", grp);
-			/* FIXME this is a known bug.
-			 * When fixed, error should be returned.
-			 */
-			return 0;
 			return -EINVAL;
 		}
 
@@ -1207,8 +1193,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &tgt->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 				grp->bgi_fragments++;
 			} else {
 				/* at the tail */
@@ -1219,8 +1207,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 							 &tgt->e_end, recsize);
 					rc = m0_table_insert(tx, &pair);
 					m0_db_pair_fini(&pair);
-					if (rc)
-						M0_RETURN(rc);
+					if (rc) {
+						M0_LEAVE();
+						return rc;
+					}
 					grp->bgi_fragments++;
 				} else {
 					pre->e_end = tgt->e_end;
@@ -1230,8 +1220,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 							 &pre->e_end, recsize);
 					rc = m0_table_update(tx, &pair);
 					m0_db_pair_fini(&pair);
-					if (rc)
-						M0_RETURN(rc);
+					if (rc) {
+						M0_LEAVE();
+						return rc;
+					}
 				}
 			}
 		} else if (found && pre == NULL) {
@@ -1244,8 +1236,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &tgt->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 				grp->bgi_fragments++;
 			} else {
 				/* join the first one */
@@ -1255,8 +1249,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_delete(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 				cur->e_start = tgt->e_start;
 
 				m0_db_pair_setup(&pair, db,
@@ -1264,8 +1260,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 			}
 		} else {
 			/* in the middle */
@@ -1278,8 +1276,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_delete(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 				pre->e_end = cur->e_end;
 
 				m0_db_pair_setup(&pair, db,
@@ -1287,8 +1287,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &pre->e_end, recsize);
 				rc = m0_table_update(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 				grp->bgi_fragments--;
 			} else
 			if (pre->e_end == tgt->e_start) {
@@ -1300,8 +1302,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &pre->e_end, recsize);
 				rc = m0_table_update(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 			} else
 			if (tgt->e_end == cur->e_start) {
 				/* joint with current */
@@ -1311,8 +1315,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_delete(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 				cur->e_start = tgt->e_start;
 
 				m0_db_pair_setup(&pair, db,
@@ -1320,8 +1326,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 			} else {
 				/* add a new one */
 
@@ -1330,8 +1338,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &tgt->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc)
-					M0_RETURN(rc);
+				if (rc) {
+					M0_LEAVE();
+					return rc;
+				}
 				grp->bgi_fragments++;
 			}
 		}
@@ -1347,9 +1357,10 @@ static int balloc_update_db(struct m0_balloc *mero,
 		if (rc == 0)
 			rc = balloc_sync_group_info(mero, tx, grp);
 
-		M0_LEAVE("rc = %d", rc);
+		M0_LEAVE();
 	} else {
-		M0_RETURN(-EINVAL);
+		rc = -EINVAL;
+		M0_LEAVE();
 	}
 	return rc;
 }
@@ -1971,6 +1982,7 @@ static int balloc_free_internal(struct m0_balloc *mero,
 		start += step;
 		len -= step;
 	}
+
 out:
 	M0_LEAVE();
 	return rc;
-- 
1.8.3.2

