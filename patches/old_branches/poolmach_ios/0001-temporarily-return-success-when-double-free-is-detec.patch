From b59f44361e659de48b97a9c9aa5bb1133d4fbe63 Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Thu, 6 Jun 2013 11:12:32 +0800
Subject: [PATCH 01/12] temporarily return success when double free is
 detected. M0_RETURN replaces M0_LEAVE.

---
 balloc/balloc.c | 100 +++++++++++++++++++++++++-------------------------------
 1 file changed, 44 insertions(+), 56 deletions(-)

diff --git a/balloc/balloc.c b/balloc/balloc.c
index f210474..002612a 100644
--- a/balloc/balloc.c
+++ b/balloc/balloc.c
@@ -1168,20 +1168,34 @@ static int balloc_update_db(struct m0_balloc *mero,
 
 		if (found && cur && tgt->e_end > cur->e_start) {
 			M0_LOG(M0_ERROR, "!!!!!!!!!!!!!double free: "
-			                 "tgt_end=%llu cur_start=%llu\n",
+			                 "tgt_start=%llu tgt_end=%llu "
+					 "cur_start=%llu cur_end=%llu\n",
+			       (unsigned long long)tgt->e_start,
 			       (unsigned long long)tgt->e_end,
-			       (unsigned long long)cur->e_start);
+			       (unsigned long long)cur->e_start,
+			       (unsigned long long)cur->e_end);
 			m0_balloc_debug_dump_group_extent(
 				    "double free with cur", grp);
+			/* FIXME this is a known bug.
+			 * When fixed, error should be returned.
+			 */
+			return 0;
 			return -EINVAL;
 		}
 		if (pre && pre->e_end > tgt->e_start) {
 			M0_LOG(M0_ERROR, "!!!!!!!!!!!!!double free: "
-			                 "pre_end=%llu tgt_start=%llu\n",
+			                 "pre_start=%llu pre_end=%llu "
+					 "tgt_start=%llu tgt_end=%llu\n",
+			       (unsigned long long)pre->e_start,
 			       (unsigned long long)pre->e_end,
-			       (unsigned long long)tgt->e_start);
+			       (unsigned long long)tgt->e_start,
+			       (unsigned long long)tgt->e_end);
 			m0_balloc_debug_dump_group_extent(
 				    "double free with pre", grp);
+			/* FIXME this is a known bug.
+			 * When fixed, error should be returned.
+			 */
+			return 0;
 			return -EINVAL;
 		}
 
@@ -1193,10 +1207,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &tgt->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 				grp->bgi_fragments++;
 			} else {
 				/* at the tail */
@@ -1207,10 +1219,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 							 &tgt->e_end, recsize);
 					rc = m0_table_insert(tx, &pair);
 					m0_db_pair_fini(&pair);
-					if (rc) {
-						M0_LEAVE();
-						return rc;
-					}
+					if (rc)
+						M0_RETURN(rc);
 					grp->bgi_fragments++;
 				} else {
 					pre->e_end = tgt->e_end;
@@ -1220,10 +1230,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 							 &pre->e_end, recsize);
 					rc = m0_table_update(tx, &pair);
 					m0_db_pair_fini(&pair);
-					if (rc) {
-						M0_LEAVE();
-						return rc;
-					}
+					if (rc)
+						M0_RETURN(rc);
 				}
 			}
 		} else if (found && pre == NULL) {
@@ -1236,10 +1244,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &tgt->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 				grp->bgi_fragments++;
 			} else {
 				/* join the first one */
@@ -1249,10 +1255,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_delete(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 				cur->e_start = tgt->e_start;
 
 				m0_db_pair_setup(&pair, db,
@@ -1260,10 +1264,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 			}
 		} else {
 			/* in the middle */
@@ -1276,10 +1278,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_delete(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 				pre->e_end = cur->e_end;
 
 				m0_db_pair_setup(&pair, db,
@@ -1287,10 +1287,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &pre->e_end, recsize);
 				rc = m0_table_update(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 				grp->bgi_fragments--;
 			} else
 			if (pre->e_end == tgt->e_start) {
@@ -1302,10 +1300,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &pre->e_end, recsize);
 				rc = m0_table_update(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 			} else
 			if (tgt->e_end == cur->e_start) {
 				/* joint with current */
@@ -1315,10 +1311,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_delete(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 				cur->e_start = tgt->e_start;
 
 				m0_db_pair_setup(&pair, db,
@@ -1326,10 +1320,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &cur->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 			} else {
 				/* add a new one */
 
@@ -1338,10 +1330,8 @@ static int balloc_update_db(struct m0_balloc *mero,
 						 &tgt->e_end, recsize);
 				rc = m0_table_insert(tx, &pair);
 				m0_db_pair_fini(&pair);
-				if (rc) {
-					M0_LEAVE();
-					return rc;
-				}
+				if (rc)
+					M0_RETURN(rc);
 				grp->bgi_fragments++;
 			}
 		}
@@ -1357,10 +1347,9 @@ static int balloc_update_db(struct m0_balloc *mero,
 		if (rc == 0)
 			rc = balloc_sync_group_info(mero, tx, grp);
 
-		M0_LEAVE();
+		M0_LEAVE("rc = %d", rc);
 	} else {
-		rc = -EINVAL;
-		M0_LEAVE();
+		M0_RETURN(-EINVAL);
 	}
 	return rc;
 }
@@ -1982,7 +1971,6 @@ static int balloc_free_internal(struct m0_balloc *mero,
 		start += step;
 		len -= step;
 	}
-
 out:
 	M0_LEAVE();
 	return rc;
-- 
1.8.3.2

