From 8d1046168f729a02a30fa0fbd662c2dd1e752e95 Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Tue, 12 Mar 2013 01:52:12 +0800
Subject: [PATCH 23/24] rebase to the latest origin/master

---
 fop/ub/ub.c              |  2 +-
 ioservice/io_service.c   | 27 +++++++++++++++------------
 ioservice/ut/bulkio_ut.c |  2 ++
 mero/setup.c             |  8 ++------
 mero/setup.h             |  2 +-
 5 files changed, 21 insertions(+), 20 deletions(-)

diff --git a/fop/ub/ub.c b/fop/ub/ub.c
index c71c25a..95c5cec 100644
--- a/fop/ub/ub.c
+++ b/fop/ub/ub.c
@@ -278,7 +278,7 @@ static const struct m0_reqh_service_ops dummy_service_ops = {
 
 static int dummy_service_allocate(struct m0_reqh_service **service,
 				  struct m0_reqh_service_type *stype,
-				  const char *arg)
+				  struct m0_reqh_context *rctx)
 {
 	struct m0_reqh_service *svc;
 
diff --git a/ioservice/io_service.c b/ioservice/io_service.c
index ae72842..dbe8669 100644
--- a/ioservice/io_service.c
+++ b/ioservice/io_service.c
@@ -604,20 +604,23 @@ static void ios_stats_post_addb(struct m0_reqh_service *service)
 
 M0_INTERNAL int m0_ios_mds_rpc_ctx_init(struct m0_reqh_service *service)
 {
-	struct m0_reqh            *reqh = service->rs_reqh;
-	struct m0_reqh_io_service *serv_obj;
-	struct m0_rpc_client_ctx  *rpc_client_ctx;
-	int                        rc;
-	const char                *dbname = "sr_cdb";
-	struct m0_net_domain      *cl_ndom;
-	struct m0_reqh_context    *reqh_ctx = service->rs_reqh_ctx;
-	const char                *cli_ep_addr;
-	const char                *srv_ep_addr;
+	struct m0_reqh             *reqh = service->rs_reqh;
+	struct m0_reqh_io_service  *serv_obj;
+	struct m0_rpc_client_ctx   *rpc_client_ctx;
+	int                         rc;
+	const char                 *dbname = "sr_cdb";
+	struct m0_net_domain       *cl_ndom;
+	struct m0_reqh_context     *reqh_ctx = service->rs_reqh_ctx;
+	const char                 *cli_ep_addr;
+	const char                 *srv_ep_addr;
 	enum {
 		RPC_TIMEOUT              = 8, /* seconds */
 		NR_SLOTS_PER_SESSION     = 2,
 		MAX_NR_RPC_IN_FLIGHT     = 5,
+		CLIENT_COB_DOM_ID        = 14,
 	};
+	static struct m0_dbenv      client_dbenv;
+	static struct m0_cob_domain client_cob_dom;
 
 	srv_ep_addr = reqh_ctx->rc_mero->cc_mds_epx.ex_endpoint;
 	cli_ep_addr = reqh_ctx->rc_mero->cc_cli2mds_epx.ex_endpoint;
@@ -646,9 +649,9 @@ M0_INTERNAL int m0_ios_mds_rpc_ctx_init(struct m0_reqh_service *service)
 	rpc_client_ctx->rcx_local_addr         = cli_ep_addr;
 	rpc_client_ctx->rcx_remote_addr        = srv_ep_addr;
 	rpc_client_ctx->rcx_db_name            = dbname;
-	rpc_client_ctx->rcx_dbenv              = reqh->rh_dbenv;
-	rpc_client_ctx->rcx_cob_dom_id         = service->rs_uuid;
-	rpc_client_ctx->rcx_cob_dom            = serv_obj->rios_cdom;
+	rpc_client_ctx->rcx_dbenv              = &client_dbenv;
+	rpc_client_ctx->rcx_cob_dom_id         = CLIENT_COB_DOM_ID;
+	rpc_client_ctx->rcx_cob_dom            = &client_cob_dom;
 	rpc_client_ctx->rcx_nr_slots           = NR_SLOTS_PER_SESSION;
 	rpc_client_ctx->rcx_timeout_s          = RPC_TIMEOUT;
 	rpc_client_ctx->rcx_max_rpcs_in_flight = MAX_NR_RPC_IN_FLIGHT;
diff --git a/ioservice/ut/bulkio_ut.c b/ioservice/ut/bulkio_ut.c
index e3181ce..94ec8b4 100644
--- a/ioservice/ut/bulkio_ut.c
+++ b/ioservice/ut/bulkio_ut.c
@@ -32,6 +32,7 @@
 #include "lib/finject.h"
 #include "fop/fom_generic.c"
 
+#define M0_TRACE_SUBSYSTEM M0_TRACE_SUBSYS_IOSERVICE
 static struct bulkio_params *bp;
 
 extern void bulkioapi_test(void);
@@ -1681,3 +1682,4 @@ const struct m0_test_suite bulkio_server_ut = {
 	}
 };
 M0_EXPORTED(bulkio_server_ut);
+#undef M0_TRACE_SUBSYSTEM
diff --git a/mero/setup.c b/mero/setup.c
index f94b2d6..19ad2d9 100644
--- a/mero/setup.c
+++ b/mero/setup.c
@@ -63,7 +63,7 @@ M0_TL_DESCR_DEFINE(cs_buffer_pools, "buffer pools in the mero context",
 		   M0_CS_BUFFER_POOL_MAGIC, M0_CS_BUFFER_POOL_HEAD_MAGIC);
 M0_TL_DEFINE(cs_buffer_pools, static, struct cs_buffer_pool);
 
-M0_TL_DESCR_DEFINE(cs_eps, "cs endpoints", M0_INTERNAL, struct cs_endpoint_and_xprt,
+M0_TL_DESCR_DEFINE(cs_eps, "cs endpoints", , struct cs_endpoint_and_xprt,
 		   ex_linkage, ex_magix, M0_CS_ENDPOINT_AND_XPRT_MAGIC,
 		   M0_CS_EPS_HEAD_MAGIC);
 
@@ -1040,11 +1040,7 @@ cs_service_init(const char *name, struct m0_reqh_context *rctx,
 	M0_RETURN(rc);
 }
 
-<<<<<<< HEAD
-static int reqh_services_init(struct cs_reqh_context *rctx)
-=======
-static int _services_init(struct m0_reqh_context *rctx)
->>>>>>> pass m0_reqh_context to service_alloc().
+static int reqh_services_init(struct m0_reqh_context *rctx)
 {
 	const char *name;
 	uint32_t    i;
diff --git a/mero/setup.h b/mero/setup.h
index 04d7ec7..d43c69e 100644
--- a/mero/setup.h
+++ b/mero/setup.h
@@ -491,7 +491,7 @@ M0_INTERNAL struct m0_mero *m0_cs_ctx_get(struct m0_reqh *reqh);
  */
 M0_INTERNAL struct m0_net_domain *m0_cs_net_domain_locate(struct m0_mero *cctx,
 							  const char *xprtname);
-M0_TL_DESCR_DECLARE(cs_eps, M0_INTERNAL);
+M0_TL_DESCR_DECLARE(cs_eps, extern);
 M0_TL_DECLARE(cs_eps, M0_INTERNAL, struct cs_endpoint_and_xprt);
 M0_BOB_DECLARE(M0_INTERNAL, cs_endpoint_and_xprt);
 
-- 
1.8.3.2

