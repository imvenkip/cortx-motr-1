From 66783204edf8b891fe1a70639e8645b6d19e4c3a Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Tue, 5 Mar 2013 21:26:33 +0800
Subject: [PATCH 17/24] add "-w" command line as pool width.

---
 addb/ut/addb_ut_svc.c                       |  1 +
 conf/ut/confc.c                             |  2 +-
 console/ut/console.c                        |  2 +-
 ioservice/ut/bulkio_common.c                |  2 ++
 ioservice/ut/cob_foms.c                     |  2 +-
 ioservice/ut/ios_buffer_pool.c              |  4 ++++
 m0t1fs/linux_kernel/st/m0t1fs_server_inc.sh |  1 +
 m0t1fs/linux_kernel/st/st                   |  2 +-
 mero/setup.c                                |  8 +++++++
 mero/setup.h                                | 25 ++++++++++++----------
 mero/ut/cs_ut_main.c                        | 33 ++++++++++++++++++++++++++++-
 rpc/ut/clnt_srv_ctx.c                       |  2 +-
 sns/cm/ut/cp_common.c                       |  1 +
 13 files changed, 68 insertions(+), 17 deletions(-)

diff --git a/addb/ut/addb_ut_svc.c b/addb/ut/addb_ut_svc.c
index ae44794..344c375 100644
--- a/addb/ut/addb_ut_svc.c
+++ b/addb/ut/addb_ut_svc.c
@@ -38,6 +38,7 @@
 static char *addb_ut_svc[] = { "m0d", "-r", "-p", "-T", "linux",
 			       "-D", "as_db", "-S", "as_stob",
 			       "-A", "as_addb_stob",
+			       "-w", "10",
 			       "-e", "lnet:0@lo:12345:34:1",
 			       "-s", M0_ADDB_SVC_NAME};
 static struct m0_net_xprt *as_xprts[] = {
diff --git a/conf/ut/confc.c b/conf/ut/confc.c
index 1bb7ea1..3db023d 100644
--- a/conf/ut/confc.c
+++ b/conf/ut/confc.c
@@ -352,7 +352,7 @@ static void test_confc_net(void)
 #define NAME(ext) "ut_confd" ext
 	char *argv[] = {
 		NAME(""), "-r", "-p", "-T", "AD", "-D", NAME(".db"),
-		"-S", NAME(".stob"), "-A", NAME("-addb.stob"),
+		"-S", NAME(".stob"), "-A", NAME("-addb.stob"), "-w", "10",
 		"-e", SERVER_ENDPOINT, "-s", "confd",
 		"-c", M0_CONF_UT_PATH("conf-str.txt")
 	};
diff --git a/console/ut/console.c b/console/ut/console.c
index 521b88e..ef7d8ac 100644
--- a/console/ut/console.c
+++ b/console/ut/console.c
@@ -102,7 +102,7 @@ static struct m0_rpc_client_ctx cctx = {
 static char *server_argv[] = {
 	"console_ut", "-r", "-p", "-T", "AD", "-D", SERVER_DB_FILE_NAME,
 	"-S", SERVER_STOB_FILE_NAME, "-A", SERVER_ADDB_STOB_FILE_NAME,
-	"-e", SERVER_ENDPOINT, "-s", "ds1", "-s", "ds2"
+	"-e", SERVER_ENDPOINT, "-s", "ds1", "-s", "ds2", "-w", "10"
 };
 
 static struct m0_rpc_server_ctx sctx = {
diff --git a/ioservice/ut/bulkio_common.c b/ioservice/ut/bulkio_common.c
index a3e3bf7..9e4cf9c 100644
--- a/ioservice/ut/bulkio_common.c
+++ b/ioservice/ut/bulkio_common.c
@@ -111,6 +111,8 @@ int bulkio_server_start(struct bulkio_params *bp, const char *saddr)
 	strcat(server_args[22], xprt);
 	strcat(server_args[22], saddr);
 	strcat(server_args[22], "01");
+	strcpy(server_args[23], "-w");
+	strcpy(server_args[24], "10");
 
 
 	M0_ALLOC_ARR(stypes, IO_SERVER_SERVICE_NR);
diff --git a/ioservice/ut/cob_foms.c b/ioservice/ut/cob_foms.c
index be9c83f..e92f89c 100644
--- a/ioservice/ut/cob_foms.c
+++ b/ioservice/ut/cob_foms.c
@@ -99,7 +99,7 @@ struct cobthread_arg {
 static char *server_args[] = {
 	"m0d", "-r", "-p", "-T", "Linux", "-D", "cobfoms_ut.db", "-S",
 	"cobfoms_ut_stob", "-A", "cobfoms_ut_addb_stob", "-e", SERVER_ENDP,
-	"-s", "ioservice"
+	"-s", "ioservice", "-w", "10"
 };
 
 static void cobfoms_utinit(void)
diff --git a/ioservice/ut/ios_buffer_pool.c b/ioservice/ut/ios_buffer_pool.c
index 87614b4..6ec95ff 100644
--- a/ioservice/ut/ios_buffer_pool.c
+++ b/ioservice/ut/ios_buffer_pool.c
@@ -43,22 +43,26 @@ static char *ios_ut_bp_singledom_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
                                 "-e", "lnet:0@lo:12345:34:1",
+				"-w", "10",
                                 "-s", "ioservice"};
 static char *ios_ut_bp_multidom_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-e", "bulk-mem:127.0.0.1:35678",
                                 "-s", "ioservice"};
 static char *ios_ut_bp_repeatdom_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "bulk-mem:127.0.0.1:35678",
                                 "-e", "bulk-mem:127.0.0.1:35679",
                                 "-s", "ioservice"};
 static char *ios_ut_bp_onerepeatdom_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:35:1",
                                 "-e", "bulk-mem:127.0.0.1:35678",
                                 "-e", "bulk-mem:127.0.0.1:35679",
diff --git a/m0t1fs/linux_kernel/st/m0t1fs_server_inc.sh b/m0t1fs/linux_kernel/st/m0t1fs_server_inc.sh
index 7858f5a..06e7b9c 100644
--- a/m0t1fs/linux_kernel/st/m0t1fs_server_inc.sh
+++ b/m0t1fs/linux_kernel/st/m0t1fs_server_inc.sh
@@ -31,6 +31,7 @@ mero_service()
 			$prog_start -r $PREPARE_STORAGE \
 			 -T $MERO_STOB_DOMAIN \
 			 -D db -S stobs -A addb-stobs \
+			 -w $POOL_WIDTH \
 			 -G $XPT:${lnet_nid}:${EP[0]} \
 			 -e $XPT:${lnet_nid}:${EP[$i]} \
 			 $ios_eps \
diff --git a/m0t1fs/linux_kernel/st/st b/m0t1fs/linux_kernel/st/st
index 26486a0..50908b4 100755
--- a/m0t1fs/linux_kernel/st/st
+++ b/m0t1fs/linux_kernel/st/st
@@ -132,7 +132,7 @@ EOF`"
 -r -p -D $SANDBOX_DIR/db -T linux -S $SANDBOX_DIR/stobs
 -A $SANDBOX_DIR/addb-stobs
 -e lnet:$IOS0_ENDPOINT $CONFD_SPEC -s mdservice -s addb -s ioservice
- -m $MAX_RPC_MSG_SIZE -q $TM_MIN_RECV_QUEUE_LEN
+ -m $MAX_RPC_MSG_SIZE -q $TM_MIN_RECV_QUEUE_LEN -w 3
 EOF`"
     [ "$MODE" = autoconf ] && OPTIONS="-C $CONFD_ENDPOINT -P prof-ac"
 
diff --git a/mero/setup.c b/mero/setup.c
index e6a33fd..372335a 100644
--- a/mero/setup.c
+++ b/mero/setup.c
@@ -1580,6 +1580,7 @@ static void cs_help(FILE *out)
 "Global options:\n"
 "  -Q num   Minimum length of TM receive queue.\n"
 "  -M num   Maximum RPC message size.\n"
+"  -w num   Pool width.\n"
 "  -C addr  Endpoint address of confd service.\n"
 "  -G addr  Endpoint address of mdservice service.\n"
 "  -L addr  Client Endpoint address to mdservice service.\n"
@@ -1714,6 +1715,11 @@ static int reqh_ctxs_are_valid(struct m0_mero *cctx)
 				 "Use -L to provide a valid one");
 	}
 
+	if (cctx->cc_pool_width <= 0) {
+		M0_LOG(M0_ERROR, "Invalid pool width.\n"
+				 "Use -w to provide a valid integer");
+		M0_RETURN(-EINVAL);
+	}
 	M0_RETURN(rc);
 }
 
@@ -1800,6 +1806,8 @@ static int _args_parse(struct m0_mero *cctx, int argc, char **argv,
 					M0_LOG(M0_DEBUG, "adding %s to ios "
 							 "ep list %d", s, rc);
 				})),
+			M0_FORMATARG('w', "Pool Width", "%i",
+				     &cctx->cc_pool_width),
 
 			/* -------------------------------------------
 			 * Request handler options
diff --git a/mero/setup.h b/mero/setup.h
index 776aaeb..03d3967 100644
--- a/mero/setup.h
+++ b/mero/setup.h
@@ -190,24 +190,24 @@ struct cs_endpoint_and_xprt {
  */
 struct m0_mero {
 	/** Protects access to m0_mero members. */
-	struct m0_rwlock          cc_rwlock;
+	struct m0_rwlock            cc_rwlock;
 
 	/**
 	   Array of network transports supported in a mero context.
 	 */
-	struct m0_net_xprt      **cc_xprts;
+	struct m0_net_xprt        **cc_xprts;
 
 	/**
 	   Size of cc_xprts array.
 	 */
-	size_t                    cc_xprts_nr;
+	size_t                      cc_xprts_nr;
 
         /**
            List of network domain per mero context.
 
 	   @see m0_net_domain::nd_app_linkage
          */
-        struct m0_tl              cc_ndoms;
+        struct m0_tl                cc_ndoms;
 
         /**
            List of request handler contexts running under one mero context
@@ -215,7 +215,7 @@ struct m0_mero {
 
 	   @see m0_reqh_context::rc_linkage
          */
-	struct m0_tl              cc_reqh_ctxs;
+	struct m0_tl                cc_reqh_ctxs;
 
 	/**
 	   File to which the output is written.
@@ -224,25 +224,25 @@ struct m0_mero {
 	   Default is set to stdout.
 	   @see m0_cs_init()
 	 */
-	FILE                     *cc_outfile;
+	FILE                       *cc_outfile;
 	/**
 	 * List of buffer pools in mero context.
 	 * @see cs_buffer_pool::cs_bp_linkage
 	 */
-	struct m0_tl             cc_buffer_pools;
+	struct m0_tl                cc_buffer_pools;
 
 	/**
 	 * Minimum number of buffers in TM receive queue.
 	 * @see m0_net_transfer_mc:ntm_recv_queue_length
 	 * Default is set to M0_NET_TM_RECV_QUEUE_DEF_LEN.
 	 */
-	size_t                   cc_recv_queue_min_length;
+	size_t                      cc_recv_queue_min_length;
 
 	/** Maximum RPC message size. */
-	size_t                   cc_max_rpc_msg_size;
+	size_t                      cc_max_rpc_msg_size;
 
 	/** Segment size for any ADDB stob. */
-	size_t                   cc_addb_stob_segment_size;
+	size_t                      cc_addb_stob_segment_size;
 
 	/** mdservice endpoint */
 	struct cs_endpoint_and_xprt cc_mds_epx;
@@ -253,8 +253,11 @@ struct m0_mero {
 	/** list of ioservice end points */
 	struct m0_tl                cc_ios_eps;
 
+	/** Pool width */
+	uint32_t                    cc_pool_width;
+
 	/** command line arguments */
-	struct cs_args		 cc_args;
+	struct cs_args		    cc_args;
 };
 
 enum {
diff --git a/mero/ut/cs_ut_main.c b/mero/ut/cs_ut_main.c
index b6cccd8..0b1f282 100644
--- a/mero/ut/cs_ut_main.c
+++ b/mero/ut/cs_ut_main.c
@@ -56,11 +56,19 @@ static char *cs_ut_service_one_cmd[] = { "m0d", "-r", "-p", "-T", "linux",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
                                 "-e", "lnet:0@lo:12345:34:1",
+				"-w", "10",
+                                "-s", "ds1"};
+
+static char *cs_ut_missing_pool[] = { "m0d", "-r", "-p", "-T", "linux",
+                                "-D", "cs_sdb", "-S", "cs_stob",
+                                "-A", "cs_addb_stob",
+                                "-e", "lnet:0@lo:12345:34:1",
                                 "-s", "ds1"};
 
 static char *cs_ut_services_many_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-e", "bulk-mem:127.0.0.1:35678",
                                 "-s", "ds1", "-s" "ds2"};
@@ -68,6 +76,7 @@ static char *cs_ut_services_many_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
 static char *cs_ut_reqhs_many_cmd[] = { "m0d", "-r", "-p", "-T", "linux",
                                 "-D", "cs_r1sdb", "-S", "cs_r1stob",
                                 "-A", "cs_r1addb_stob",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-s", "ds1",
                                 "-r", "-p", "-T", "AD",
@@ -78,12 +87,14 @@ static char *cs_ut_reqhs_many_cmd[] = { "m0d", "-r", "-p", "-T", "linux",
 
 static char *cs_ut_opts_jumbled_cmd[] = { "m0d", "-r", "-p", "-D",
                                 "cs_sdb", "-T", "AD", "-s", "ds1",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-S", "cs_stob", "-A", "cs_addb_stob"};
 
 static char *cs_ut_dev_stob_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-d", "devices.conf",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-s", "ds1"};
@@ -91,52 +102,60 @@ static char *cs_ut_dev_stob_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
 static char *cs_ut_reqh_none_cmd[] = { "m0d", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-s", "ds1"};
 
 static char *cs_ut_stype_bad_cmd[] = { "m0d", "-r", "-p", "-T", "asdadd",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_sdb",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-s", "ds1"};
 
 static char *cs_ut_xprt_bad_cmd[] = { "m0d", "-r", "-p","-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_sdb",
+				"-w", "10",
                                 "-e", "asdasdada:172.18.50.40@o2ib1:34567:2",
                                 "-s", "ds1"};
 
 static char *cs_ut_ep_bad_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_sdb",
+				"-w", "10",
                                 "-e", "lnet:asdad:asdsd:sadasd",
                                 "-s", "ds1"};
 
 static char *cs_ut_service_bad_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_sdb",
+				"-w", "10",
                                 "-e", "lnet:172.18.50.40@o2ib1:12345:34:1",
                                 "-s", "dasdadasd"};
 
 static char *cs_ut_args_bad_cmd[] = { "m0d", "-r", "-p", "-D", "cs_sdb",
-                                "-S", "cs_stob", "-A", "cs_addb_sdb",
+                                "-S", "cs_stob", "-A", "cs_addb_sdb", "-w", "10",
                                 "-e", "lnet:172.18.50.40@o2ib1:12345:34:1"};
 
 static char *cs_ut_buffer_pool_cmd[] = { "m0d", "-r", "-p", "-T", "linux",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-s", "ds1", "-q", "4", "-m", "4096"};
 
 static char *cs_ut_lnet_cmd[] = { "m0d", "-r", "-p", "-T", "linux",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_sdb",
+				"-w", "10",
                                 "-e", "lnet:0@lo:12345:34:1",
                                 "-s", "ds1"};
 
 static char *cs_ut_lnet_mult_if_cmd[] = { "m0d", "-r", "-p", "-T", "linux",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:172.18.50.40@tcp:12345:30:101",
                                 "-e", "lnet:172.18.50.40@o2ib0:12345:34:101",
                                 "-s", "ioservice"};
@@ -144,6 +163,7 @@ static char *cs_ut_lnet_mult_if_cmd[] = { "m0d", "-r", "-p", "-T", "linux",
 static char *cs_ut_lnet_ep_dup_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:172.18.50.40@o2ib1:12345:30:101",
                                 "-s", "ds1", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb2", "-S", "cs_stob2",
@@ -154,6 +174,7 @@ static char *cs_ut_lnet_ep_dup_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
 static char *cs_ut_ep_mixed_dup_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:172.18.50.40@tcp:12345:30:101",
                                 "-e", "lnet:172.18.50.40@o2ib0:12345:34:101",
                                 "-e", "lnet:172.18.50.40@o2ib1:12345:30:101",
@@ -163,6 +184,7 @@ static char *cs_ut_ep_mixed_dup_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
 static char *cs_ut_lnet_dup_tcp_if_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:172.18.50.40@tcp:12345:30:101",
                                 "-e", "lnet:172.18.50.40@tcp:12345:32:105",
                                 "-s", "ds1"};
@@ -170,6 +192,7 @@ static char *cs_ut_lnet_dup_tcp_if_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
 static char *cs_ut_lnet_ep_bad_cmd[] = { "m0d", "-r", "-p", "-T", "AD",
                                 "-D", "cs_sdb", "-S", "cs_stob",
                                 "-A", "cs_addb_stob",
+				"-w", "10",
                                 "-e", "lnet:asdad:asdsd:sadasd",
                                 "-s", "ds1"};
 
@@ -355,6 +378,13 @@ static void test_cs_ut_service_one(void)
 				  ARRAY_SIZE(cs_ut_service_one_cmd));
 }
 
+static void test_cs_ut_missing_pool_width(void)
+{
+	cs_ut_test_helper_failure(cs_ut_missing_pool,
+				  ARRAY_SIZE(cs_ut_missing_pool));
+}
+
+
 static void dev_conf_file_create(void)
 {
 	int   ret;
@@ -553,6 +583,7 @@ const struct m0_test_suite m0d_ut = {
         .ts_fini = NULL,
         .ts_tests = {
                 { "cs-single-service", test_cs_ut_service_one},
+                { "cs-missing-pool-width", test_cs_ut_missing_pool_width},
 		{ "cs-multiple-services", test_cs_ut_services_many},
 		{ "cs-multiple-request-handlers", test_cs_ut_reqhs_many},
 		{ "cs-command-options-jumbled", test_cs_ut_opts_jumbled},
diff --git a/rpc/ut/clnt_srv_ctx.c b/rpc/ut/clnt_srv_ctx.c
index b7672a0..82f8cec 100644
--- a/rpc/ut/clnt_srv_ctx.c
+++ b/rpc/ut/clnt_srv_ctx.c
@@ -67,7 +67,7 @@ static struct m0_rpc_client_ctx cctx = {
 static char *server_argv[] = {
 	"rpclib_ut", "-r", "-p", "-T", "AD", "-D", SERVER_DB_FILE_NAME,
 	"-S", SERVER_STOB_FILE_NAME, "-A", SERVER_ADDB_STOB_FILE_NAME,
-	"-e", SERVER_ENDPOINT, "-s", "ds1", "-s", "ds2"
+	"-e", SERVER_ENDPOINT, "-s", "ds1", "-s", "ds2", "-w", "10"
 };
 
 static struct m0_rpc_server_ctx sctx = {
diff --git a/sns/cm/ut/cp_common.c b/sns/cm/ut/cp_common.c
index 8c8bd03..eaed17e 100644
--- a/sns/cm/ut/cp_common.c
+++ b/sns/cm/ut/cp_common.c
@@ -32,6 +32,7 @@ const char log_file_name[] = "sr_ut.errlog";
 char      *sns_cm_ut_svc[] = { "m0d", "-r", "-p", "-T", "LINUX",
                                "-D", "sr_db", "-S", "sr_stob",
                                "-A", "sr_addb_stob",
+				"-w", "10",
                                "-e", "lnet:0@lo:12345:34:1",
                                "-s", "sns_cm",
                                "-s", "ioservice"};
-- 
1.8.3.2

