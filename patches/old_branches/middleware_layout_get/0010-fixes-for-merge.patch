From 1c7edd19b40084304b34ab541d9732b8235f98f1 Mon Sep 17 00:00:00 2001
From: Hua Huang <hua_huang@xyratex.com>
Date: Tue, 26 Feb 2013 23:26:21 +0800
Subject: [PATCH 10/24] fixes for merge

---
 conf/ut/confc.c           |  2 +-
 ioservice/io_service.c    | 10 ++--------
 ioservice/io_service.h    |  2 +-
 m0t1fs/linux_kernel/st/st |  3 ---
 rpc/ut/clnt_srv_ctx.c     |  2 +-
 5 files changed, 5 insertions(+), 14 deletions(-)

diff --git a/conf/ut/confc.c b/conf/ut/confc.c
index 102c144..1bb7ea1 100644
--- a/conf/ut/confc.c
+++ b/conf/ut/confc.c
@@ -354,7 +354,7 @@ static void test_confc_net(void)
 		NAME(""), "-r", "-p", "-T", "AD", "-D", NAME(".db"),
 		"-S", NAME(".stob"), "-A", NAME("-addb.stob"),
 		"-e", SERVER_ENDPOINT, "-s", "confd",
-		"-c", M0_CONF_UT_PATH("conf-str.txt"),
+		"-c", M0_CONF_UT_PATH("conf-str.txt")
 	};
 	M0_RPC_SERVER_CTX_DEFINE(confd, &g_xprt, 1, argv, ARRAY_SIZE(argv),
 				 NULL, 0, NAME(".log"));
diff --git a/ioservice/io_service.c b/ioservice/io_service.c
index a8f712e..f90f1a0 100644
--- a/ioservice/io_service.c
+++ b/ioservice/io_service.c
@@ -458,18 +458,12 @@ static int ios_start(struct m0_reqh_service *service)
 	if (rc != 0)
 		return rc;
 
-	serv_obj = container_of(service, struct m0_reqh_io_service, rios_gen);
-	serv_obj->rios_cdom = *cdom;
-
-	rc = ios_create_buffer_pool(service);
+	rc = m0_ios_mds_rpc_ctx_init(service);
 	if (rc != 0) {
 		m0_ios_cdom_fini(service->rs_reqh);
 		return rc;
 	}
 
-	serv_obj = container_of(service, struct m0_reqh_io_service, rios_gen);
-	serv_obj->rios_cdom = *cdom;
-
 	rc = ios_create_buffer_pool(service);
 	if (rc != 0) {
 		/* Cleanup required for already created buffer pools. */
@@ -655,7 +649,7 @@ M0_INTERNAL int m0_ios_mds_rpc_ctx_init(struct m0_reqh_service *service)
 	rpc_client_ctx->rcx_db_name            = dbname;
 	rpc_client_ctx->rcx_dbenv              = reqh->rh_dbenv;
 	rpc_client_ctx->rcx_cob_dom_id         = service->rs_uuid;
-	rpc_client_ctx->rcx_cob_dom            = &serv_obj->rios_cdom;
+	rpc_client_ctx->rcx_cob_dom            = serv_obj->rios_cdom;
 	rpc_client_ctx->rcx_nr_slots           = NR_SLOTS_PER_SESSION;
 	rpc_client_ctx->rcx_timeout_s          = RPC_TIMEOUT;
 	rpc_client_ctx->rcx_max_rpcs_in_flight = MAX_NR_RPC_IN_FLIGHT;
diff --git a/ioservice/io_service.h b/ioservice/io_service.h
index badc41a..7087e3c 100644
--- a/ioservice/io_service.h
+++ b/ioservice/io_service.h
@@ -96,7 +96,7 @@ struct m0_reqh_io_service {
 	/** Read[0] and write[1] I/O FOM statistics */
 	struct m0_ios_rwfom_stats    rios_rwfom_stats[2];
 	/** Cob domain for ioservice. */
-	struct m0_cob_domain         rios_cdom;
+	struct m0_cob_domain         *rios_cdom;
 
 	/** rpc client to metadata & management service.
 	 * This is stored in reqh as a key. So other services, like "sns_repair"
diff --git a/m0t1fs/linux_kernel/st/st b/m0t1fs/linux_kernel/st/st
index c84ac92..26486a0 100755
--- a/m0t1fs/linux_kernel/st/st
+++ b/m0t1fs/linux_kernel/st/st
@@ -28,8 +28,6 @@ export_lnet_nid_endpoints() {
     export IOS0_ENDPOINT="$LNET_NID:12345:34:1"
     export IOS1_ENDPOINT="$LNET_NID:12345:34:2"
     export MDS_ENDPOINT="$IOS0_ENDPOINT"
-    export CLI2MDS_ENDPOINT1="$LNET_NID:12345:34:201"
-    export CLI2MDS_ENDPOINT2="$LNET_NID:12345:34:202"
     export CONFD_ENDPOINT="$IOS0_ENDPOINT"
 }
 
@@ -82,7 +80,6 @@ modules_insert() {
 }
 
 modules_remove() {
-    sleep 20
     rmmod m0mero
     rmmod galois
 }
diff --git a/rpc/ut/clnt_srv_ctx.c b/rpc/ut/clnt_srv_ctx.c
index d8ee4e1..b7672a0 100644
--- a/rpc/ut/clnt_srv_ctx.c
+++ b/rpc/ut/clnt_srv_ctx.c
@@ -67,7 +67,7 @@ static struct m0_rpc_client_ctx cctx = {
 static char *server_argv[] = {
 	"rpclib_ut", "-r", "-p", "-T", "AD", "-D", SERVER_DB_FILE_NAME,
 	"-S", SERVER_STOB_FILE_NAME, "-A", SERVER_ADDB_STOB_FILE_NAME,
-	"-e", SERVER_ENDPOINT, "-s", "ds1", "-s", "ds2",
+	"-e", SERVER_ENDPOINT, "-s", "ds1", "-s", "ds2"
 };
 
 static struct m0_rpc_server_ctx sctx = {
-- 
1.8.3.2

