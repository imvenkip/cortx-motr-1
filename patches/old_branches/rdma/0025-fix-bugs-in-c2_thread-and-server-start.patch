From a38aa0e22f13d004fb61eaa15fe3c8004f12ed4b Mon Sep 17 00:00:00 2001
From: jay <jay@clusterstor0.cstor.com>
Date: Tue, 3 Aug 2010 11:19:06 -0600
Subject: [PATCH 25/34] - fix bugs in c2_thread and server start - remove debug
 prints

---
 lib/user_space/thread.c        | 3 +++
 net/net_srv.c                  | 4 +++-
 net/usunrpc/rfc5666/svc_rdma.c | 4 ++--
 net/usunrpc/server.c           | 2 --
 4 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/lib/user_space/thread.c b/lib/user_space/thread.c
index 6023fb2..d207adf 100644
--- a/lib/user_space/thread.c
+++ b/lib/user_space/thread.c
@@ -84,6 +84,9 @@ int c2_thread_join(struct c2_thread *q)
 {
 	int result;
 
+        if (q->t_state == TS_PARKED)
+                return 0;
+
 	C2_PRE(q->t_state == TS_RUNNING);
 	C2_PRE(!pthread_equal(q->t_h.h_id, pthread_self()));
 	result = pthread_join(q->t_h.h_id, NULL);
diff --git a/net/net_srv.c b/net/net_srv.c
index 33397df..506762b 100644
--- a/net/net_srv.c
+++ b/net/net_srv.c
@@ -56,7 +56,9 @@ int c2_service_start(struct c2_service *service, struct c2_service_id *sid)
 		c2_rwlock_read_lock(&dom->nd_lock);
 		c2_list_add(&dom->nd_service, &service->s_linkage);
 		c2_rwlock_read_unlock(&dom->nd_lock);
-	}
+	} else {
+		c2_addb_ctx_fini(&service->s_addb);
+        }
 	return result;
 }
 
diff --git a/net/usunrpc/rfc5666/svc_rdma.c b/net/usunrpc/rfc5666/svc_rdma.c
index 4025594..a805d5f 100644
--- a/net/usunrpc/rfc5666/svc_rdma.c
+++ b/net/usunrpc/rfc5666/svc_rdma.c
@@ -11,9 +11,9 @@
 #define rdma_errx(rc, fmt, args...)                     \
         fprintf(stderr, "[%s:%d error(%d)] " fmt,       \
                  __func__, __LINE__, rc, ##args)
-#define dprintf(fmt, args...) fprintf(stderr, "[%s:%d] " fmt, __func__, __LINE__, ##args)
+#define dprintf(fmt, args...) //fprintf(stderr, "[%s:%d] " fmt, __func__, __LINE__, ##args)
 #define gethere()       dprintf("get here\n")
-#define svcmsg_dumper   printf
+#define svcmsg_dumper   NULL //printf
 
 /*
   Call convention for functions in this file:
diff --git a/net/usunrpc/server.c b/net/usunrpc/server.c
index 3f54010..9a22ced 100644
--- a/net/usunrpc/server.c
+++ b/net/usunrpc/server.c
@@ -284,8 +284,6 @@ static void usunrpc_op(struct c2_service *service,
 	struct c2_fop          *arg;
 	int                     result;
 
-	printf("got fop %s\n", fopt->ft_name);
-
 	xs  = service->s_xport_private;
 	arg = c2_fop_alloc(fopt, NULL);
 	C2_ALLOC_PTR(wi);
-- 
1.8.3.2

