From 82edd1a10b78989b6d3ad2637a0b226739026984 Mon Sep 17 00:00:00 2001
From: "jinshan.xiong" <jinshan.xiong@clusterstor.com>
Date: Wed, 28 Jul 2010 16:37:50 -0600
Subject: [PATCH 17/34] - setup alignment at client side, though it is wrong -
 fix a bug in c2_alloc_align

---
 c2t1fs/main.c      | 2 ++
 lib/memory.c       | 2 +-
 net/usunrpc/uxdr.c | 2 +-
 3 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/c2t1fs/main.c b/c2t1fs/main.c
index 60841d8..21b3464 100644
--- a/c2t1fs/main.c
+++ b/c2t1fs/main.c
@@ -149,6 +149,7 @@ static int ksunrpc_read_write(struct c2_net_conn *conn,
                 arg->siw_object.f_seq  = 10;
                 arg->siw_object.f_oid  = objid;
 		arg->siw_offset        = pos;
+		arg->siw_buf.cib_align = PAGE_SIZE;
 		arg->siw_buf.cib_count = len;
 		arg->siw_buf.cib_pgoff = off;
 		arg->siw_buf.cib_pages = pages;
@@ -180,6 +181,7 @@ static int ksunrpc_read_write(struct c2_net_conn *conn,
 		arg->sir_seg.f_offset = pos;
 		arg->sir_seg.f_count  = len;
 
+		ret->sirr_buf.cib_align = PAGE_SIZE;
 		ret->sirr_buf.cib_count = len;
 		ret->sirr_buf.cib_pgoff = off;
 		ret->sirr_buf.cib_pages = pages;
diff --git a/lib/memory.c b/lib/memory.c
index 59e478e..0d918d3 100644
--- a/lib/memory.c
+++ b/lib/memory.c
@@ -94,7 +94,7 @@ void *c2_alloc_align(size_t size, int align)
 {
         void *ret;
 
-        C2_ASSERT((align ^ (align - 1)) == 0);
+        C2_ASSERT((align & (align - 1)) == 0);
         if (posix_memalign(&ret, align, size))
                 return NULL;
 
diff --git a/net/usunrpc/uxdr.c b/net/usunrpc/uxdr.c
index 6d4c2ca..e4b37be 100644
--- a/net/usunrpc/uxdr.c
+++ b/net/usunrpc/uxdr.c
@@ -190,7 +190,7 @@ static bool_t c2_xdr_io_buf(XDR *xdrs, void *obj)
         switch(xdrs->x_op) {
         case XDR_DECODE:
                 dbuf->cib_value = c2_alloc_align(dbuf->cib_count,
-                                                  dbuf->cib_align);
+                                                 dbuf->cib_align);
                 if (dbuf->cib_value == NULL)
                         return FALSE;
         case XDR_ENCODE:
-- 
1.8.3.2

