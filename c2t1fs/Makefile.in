C2T1FS_SRCDIR = @SRCDIR@/c2t1fs
FOPDIR = @SRCDIR@/fop
ADDBDIR = @SRCDIR@/addb
STOBDIR = @SRCDIR@/stob/ut
GALOISDIR = @SRCDIR@/../galois
IOSERVICEDIR = @SRCDIR@/ioservice

obj-m := c2t1fs.o c2t1fs_loop.o
c2t1fs-y := main.o io_k.o io_fops_k.o io_fops.o io_foms.o io_fop_init.o addb_store.o addb_k.o

EXTRA_CFLAGS = -DHAVE_CONFIG_H -I@SRCDIR@ @KCFLAGS@

prepare: io_k.h io_k.c addb_k.c addb_k.h io_fops_k.h io_fops_k.c
	ln -sf $(STOBDIR)/io_fop_init.c .
	ln -sf $(ADDBDIR)/addb_store.c .
	ln -sf $(GALOISDIR)/galois.h @SRCDIR@/sns
	ln -sf $(IOSERVICEDIR)/io_fops.c
	ln -sf $(IOSERVICEDIR)/io_foms.c

io_k.h io_k.c: $(STOBDIR)/io.ff
	$(FOPDIR)/fop2c -k $(STOBDIR)/io.ff

addb_k.h addb_k.c: $(ADDBDIR)/addb.ff
	$(FOPDIR)/fop2c -k $(ADDBDIR)/addb.ff

io_fops_k.h io_fops_k.c: $(IOSERVICEDIR)/io_fops.ff
	$(FOPDIR)/fop2c -k $(IOSERVICEDIR)/io_fops.ff

install modules_install:
	$(MAKE) INSTALL_MOD_DIR=kernel/fs/c2t1fs -C @LINUX_OBJ@ M=`pwd` modules_install

uninstall:
	rm -fr @LINUX_MOD@/kernel/fs/c2t1fs

distclean clean:
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` clean;
	rm -fr Module.symvers io_k.[ch] io_fop_init.c addb_store.c addb_k.[ch] io_fops_k.[ch]
	rm -fr @SRCDIR@/sns/galois.h
	rm -rf io_fops.* io_foms.*
	rm -rf fop_types.h

distdir:
	cp $(C2T1FS_SRCDIR)/Makefile.in $(C2T1FS_SRCDIR)/c2t1fs.h \
$(C2T1FS_SRCDIR)/c2t1fs_loop.c $(C2T1FS_SRCDIR)/main.c \
@top_builddir@/@PACKAGE@-@VERSION@/c2t1fs
