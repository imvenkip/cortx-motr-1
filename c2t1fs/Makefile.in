OS = @OS@
C2T1FS_SRCDIR = @SRCDIR@/c2t1fs
FOPDIR = @SRCDIR@/fop
STOBDIR = @SRCDIR@/stob/ut

ifeq ($(OS),linux)

obj-m := c2t1fs.o c2t1fs_loop.o 
c2t1fs-y := main.o io_fop_init.o io_k.o

EXTRA_CFLAGS = -DHAVE_CONFIG_H -I@SRCDIR@ @KCFLAGS@

all:
	if ! test -e c2t1fs.c; then \
                ln -s $(C2T1FS_SRCDIR)/c2t1fs.c; \
                ln -s $(C2T1FS_SRCDIR)/c2t1fs.h; \
        fi 
	$(FOPDIR)/fop2c -k $(STOBDIR)/io.ff 
	if ! test -e io_fop_init.c; then \
		ln -s $(STOBDIR)/io_fop_init.c; \
        fi 
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` modules

install modules_install:
	$(MAKE) INSTALL_MOD_DIR=kernel/fs/c2t1fs -C @LINUX_OBJ@ M=`pwd` modules_install

uninstall:
	rm -fr @LINUX_MOD@/kernel/fs/c2t1fs

distclean clean:
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` clean;
	rm -fr Module.symvers io_k.[ch]

else

all:
install:
uninstall:
distclean clean:

endif

distdir:
	cp $(C2T1FS_SRCDIR)/Makefile.in $(C2T1FS_SRCDIR)/c2t1fs.[ch] $(C2T1FS_SRCDIR)/c2t1fs_loop.c \
@top_builddir@/@PACKAGE@-@VERSION@/c2t1fs
