#!/usr/bin/env bash

# This script compares xcode protocol files produced by `xcode/proto` script,
# which uses gccxml files to generate protocol, and `xcode/m0protocol` binary
# utility, which uses libmero.so.

echo -n 'Checking xcode protocol... '

# exit immediately if one the commands exits with a non-zero status
set -e

trap "rm -f protocol{,-{be,conf,rpc}}.txt" EXIT

./xcode/m0protocol -p > protocol.txt
for domain in be conf rpc ; do
    ./xcode/m0protocol -d $domain > protocol-$domain.txt
done

rc=0
for proto_file in protocol*.txt ; do
    if ! cmp -s {xcode/,}$proto_file ; then
        rc=1
        echo 'FAIL'
        echo '*ERROR* `xcode/proto` output differs from `xcode/m0protocol`'
        break
    fi
done

if [[ $rc -eq 0 ]] ; then
    echo OK
    exit 0
fi

diff_cmd='diff -u'
if which wdiff 2>/dev/null ; then
    diff_cmd='wdiff'
fi

for proto_file in protocol*.txt ; do
    if ! cmp -s {xcode/,}$proto_file ; then
        $diff_cmd {xcode/,}$proto_file || true
    fi
done

exit 1
