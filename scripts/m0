#!/bin/sh
set -e

### --------------------------------------------------------------------
### Mero helper script
###
### Installation:
###     ln -s /path/to/mero/scripts/m0 ~/bin/m0
###
### Type `m0 help' for usage.
### --------------------------------------------------------------------

## CAUTION! This directory will be removed by superuser.
RUNDIR=${RUNDIR:-$HOME/XXX}

PROG="${0##*/}"
SRC="$(readlink -f $0)"
SRC="${SRC%/*/*}"

SUDO='sudo -E'

die() { echo "$@" >&2; exit 1; }

clean() {
    cd "$SRC"
    make distclean || true
    [ "$1" = '-f' ] && git clean -fdx || true
}

_make() {
    local _OUT=`mktemp`
    trap "rm $_OUT" 0
    make $MAKE_OPTS 2>&1 | tee $_OUT
    [ ${PIPESTATUS[0]} -eq 0 ] || exit ${PIPESTATUS[0]}
    if grep 'WARNING:' $_OUT; then
	die 'WARNING in make output is treated as error'
    fi
}

build() {
    autoreconf -ifs
    ./configure $CONFIGURE_OPTS
    _make
}

run_init() {
    $SUDO rm -rf "$RUNDIR"  # Ouch!
    mkdir "$RUNDIR"
    cd "$RUNDIR"
}

run_ut()  { run_init; $SUDO "$SRC/utils/ut.sh" "$@"; }

run_kut() {
    run_init
    echo 'Running kernel UT (this may take a while) ...'
    $SUDO "$SRC/utils/linux_kernel/ut.sh"
}

run_st() {
    run_init
    $SUDO "$SRC/net/test/st/st.sh"

    ## rpc ping
    "$SRC/rpc/it/st.sh"

    ## conf ST
    $SUDO SANDBOX_DIR=${RUNDIR}/_m0-sandbox "$SRC/m0t1fs/linux_kernel/st/st"

    ## other ST
    $SUDO "$SRC/m0t1fs/linux_kernel/st/m0t1fs_test.sh"

    ## Pool machine query/set testing.
    $SUDO "$SRC/m0t1fs/linux_kernel/st/m0t1fs_poolmach.sh"

    ## SNS single failure repair and rebalance
    $SUDO "$SRC/m0t1fs/linux_kernel/st/m0t1fs_sns_repair_1f.sh"

    ## SNS multi failure repair
    $SUDO "$SRC/m0t1fs/linux_kernel/st/m0t1fs_sns_repair_mf.sh"
}

dist_check() {
    local DIST=mero-0.1.0
    local DISTFILE=$DIST.tar.gz

    cd "$SRC"
    [ -f Makefile ] || die "You need to \`$PROG make' first."

    make dist

    ## Don't preserve files' ownership (if $SRC/.. is on NFS, it will fail).
    tar --no-same-owner -xzf $DISTFILE

    for lib in extra-libs/*; do
	[ $lib != extra-libs/galois ] && ln -sf ../../$lib $DIST/extra-libs/
    done

    cd $DIST
    build
    cd -
    rm -r $DIST

    [ "$1" = '-a' ] || rm $DISTFILE
}

check_everything() {
    for cmd in clean build dist_check run_ut run_kut run_st; do
	echo "----- $cmd -----" >&2
	$cmd
    done
}

help() {
    [ $1 -eq 0 ] && _usage || _usage >&2
    exit $1
}

_usage() {
    cat <<EOF
Usage: $PROG COMMAND [OPTION]...

Commands:
    make                Execute 'make' in Mero directory, falling back to
                        '$PROG rebuild' if no Makefile is found.

    rebuild             Clean and build the whole Mero anew.

    run-ut [OPTION]...  Run user-space unit tests.
                        OPTIONs are passed to utils/ut.sh.

    run-kut             Run kernel unit tests.

    run-st              Run system tests.

    run-all             Run unit and system tests.

    dist-check [-a]     Create and validate Mero distribution archive.
                        The resulting archive file will be deleted,
                        unless '-a' option is used.

    check-everything  = (rebuild + dist-check + run-all) * 2
                        Please run this command before landing.
                        .
                        '* 2' means that the command is being run two
                        times; the second time with './configure
                        --disable-m0-asserts'.

    clean [-f]          Execute 'make distclean' in Mero sources directory.
                        '-f' will also remove untracked files and directories
                        (i.e. those not added to the git repository).
                        *WARNING*: You do not want to use '-f' option
                        if there are any untracked files you care about.

    help    Show this help and exit.

Environment variables:
    CONFIGURE_OPTS      Extra options for './configure' command.
    MAKE_OPTS           Extra options for 'make' command.

M0 sources: $SRC
UT output:  $RUNDIR
EOF
}

case "$1" in
    make)
	cd "$SRC"
	if [ -f Makefile ]; then
	    _make
	else
	    build
	fi;;
    rebuild) clean; build;;
    run-ut)  shift; run_ut "$@";;
    run-kut) run_kut;;
    run-st)  run_st;;
    run-all)
        shift; run_ut "$@"
        run_kut
        run_st;;
    dist-check) shift; dist_check "$@";;
    check-everything)
	check_everything
	echo $CONFIGURE_OPTS | grep -qe '--disable-m0-asserts' || {
	    CONFIGURE_OPTS="$CONFIGURE_OPTS --disable-m0-asserts"
	    check_everything
	};;
    clean) shift; clean "$@";;
    help) help 0;;
    *)    help 1;;
esac
