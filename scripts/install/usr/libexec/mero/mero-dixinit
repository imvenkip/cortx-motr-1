#!/usr/bin/env bash

# exit immediately if one the commands exits with a non-zero status
set -e

# constants
readonly PROG_NAME=$(basename $0)

# global variables, which can be overriden in /etc/sysconfig/mero
MERO_GENDERS_CONF=/etc/mero/genders

# service local variables
user_config=/etc/sysconfig/mero
kernel_config=/etc/sysconfig/mero-kernel
service_funcs=/usr/libexec/mero/mero-service.functions

m0_dixinit()
{
    source $service_funcs

    # read configs
    [[ -r $kernel_config ]] && source $kernel_config
    [[ -r $user_config ]]   && source $user_config

    [[ -n $MERO_M0D_DEBUGGER ]] && export M0_DEBUGGER=$MERO_M0D_DEBUGGER

    m0_cas_enabled || {
        m0_log 'CAS service is not enabled, skipping m0dixinit'
        return 0
    }

    local service_dir=$(m0_get_m0d_data_dir_for dixinit)
    [[ ! -d $service_dir ]] && mkdir -p "$service_dir"
    cd "$service_dir"

    local ha_ep=${MERO_HA_EP:-$(m0_get_global_ep_of ha)}
    local dix_pverid='v|1:20'
    local dixinit=$(m0_path_to m0dixinit)

    m0_run $dixinit -l $(m0_get_lnet_nid):12345:34:101 -H $ha_ep \
                    -p $m0_prof_opt -I $dix_pverid \
                    -d $dix_pverid -a create
}

# Skip m0dixinit, mkfs creates meta indices now. See MERO-2793.
# m0_dixinit
