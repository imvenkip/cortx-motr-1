#! /bin/sh

# This script is also used by utils/ut.sh, utils/linux_kernel/ut.sh
# If you are modifying this file, please make the relevant changes
# in above mentioned files also.

MODLIST="@abs_top_srcdir@/mero/m0mero.ko"

# The following associative array carries the list of module parameters for
# modules in MODLIST.
declare -A MODPARAMS
NULL_UUID="00000000-0000-0000-0000-000000000000"
MERO_MODULE_TRACE_MASK='!all'
MERO_TRACE_PRINT_CONTEXT=short
MERO_TRACE_LEVEL='call+'

MODPARAMS[m0mero.ko]="node_uuid=${NODE_UUID:-$NULL_UUID}"

MODPARAMS[m0ut.ko]="node_uuid=${NODE_UUID:-$NULL_UUID} \
		    trace_immediate_mask=${MERO_MODULE_TRACE_MASK} \
		    trace_print_context=${MERO_TRACE_PRINT_CONTEXT} \
		    trace_level=${MERO_TRACE_LEVEL}"

# to make command output parsing predictable
export LC_MESSAGES=C

abort()
{
	msg="$1"
	echo "$1 Aborting."
	exit 1
}

# Do not rmmod lnet, it may be in use by lustre
modprobe_lnet()
{
	modprobe lnet || abort "Error probing lnet."
}

modload_m0gf()
{
	BASE=@GF_ABS_SRC@
	if test "x$BASE" = "x"; then
		modprobe m0gf
	else
		insmod $BASE/src/linux_kernel/m0gf.ko
	fi
}

modunload_m0gf()
{
	rmmod m0gf &>> /dev/null
}

modload()
{
	for m in $MODLIST ;do
                BN=$(basename $m)
                PARAMS=
                if [[ ! -z "${MODPARAMS[$BN]}" ]] ; then
		    PARAMS=${MODPARAMS[$BN]}
		fi
		insmod $m $PARAMS || abort "Error loading $m $PARAMS"
	done
}

modunload()
{
	for m in $MODLIST ;do
		echo $m
	done | tac | while read ;do
		rmmod $REPLY &>> /dev/null || echo "Error unloading $REPLY."
	done
}
