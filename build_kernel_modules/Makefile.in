OS = @OS@

C2T1FS_SRCDIR = @SRCDIR@/c2t1fs
KSUNRPC_SRCDIR = @SRCDIR@/net/ksunrpc
FOPDIR = @SRCDIR@/fop
STOBDIR = @SRCDIR@/stob/ut

ifeq ($(OS),linux)

obj-y := c2t1fs/ ksunrpc/

all:
	if ! test -e c2t1fs; then       \
            ln -s $(C2T1FS_SRCDIR);     \
        fi
	if ! test -e ksunrpc; then      \
            ln -s $(KSUNRPC_SRCDIR);    \
        fi 
	$(FOPDIR)/fop2c -k $(STOBDIR)/io.ff 
	mv io_k.[ch] c2t1fs/
	if ! test -e c2t1fs/io_fop_init.c; then \
		ln -s $(STOBDIR)/io_fop_init.c c2t1fs/; \
        fi 
	if ! test -e ksunrpc/fop.c; then \
		ln -s $(FOPDIR)/fop.c ksunrpc/; \
		ln -s $(FOPDIR)/fop_format.c ksunrpc/; \
        fi 
	if ! test -e c2t1fs/fop.c; then \
		ln -s $(FOPDIR)/fop.c c2t1fs/; \
		ln -s $(FOPDIR)/fop_format.c c2t1fs/; \
        fi 
	$(MAKE) -C @LINUX_OBJ@ M=`pwd` modules

clean distclean:
	if ! test -e c2t1fs; then       \
            ln -s $(C2T1FS_SRCDIR);     \
        fi
	if ! test -e ksunrpc; then      \
            ln -s $(KSUNRPC_SRCDIR);    \
        fi
	$(MAKE) -C c2t1fs clean
	$(MAKE) -C ksunrpc clean
	$(RM) Module.markers modules.order
	$(RM) ksunrpc/fop.c ksunrpc/fop_format.c
	$(RM) c2t1fs/fop.c c2t1fs/fop_format.c c2t1fs/io_fop_init.c
	$(RM) -fr c2t1fs ksunrpc

else

all:
install:
uninstall:
distclean clean:

endif

distdir:
	if ! test -e c2t1fs; then       \
            ln -s $(C2T1FS_SRCDIR);     \
        fi
	if ! test -e ksunrpc; then      \
            ln -s $(KSUNRPC_SRCDIR);    \
        fi
	$(MAKE) -C c2t1fs distdir
	$(MAKE) -C ksunrpc distdir
